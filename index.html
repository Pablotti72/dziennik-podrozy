<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dziennik podr√≥≈ºy</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
  <div id="authModal" class="modal" style="display: none;">
    <div class="modal-content">
      <h2>üîê Dostƒôp do edycji</h2>
      <p>Wprowad≈∫ has≈Ço administratora, aby edytowaƒá.</p>
      <input type="password" id="adminPassword" placeholder="Has≈Ço">
      <button onclick="checkPassword()">Wejd≈∫</button>
      <button onclick="closeAuthModal()" style="margin-top: 10px;">Anuluj</button>
    </div>
  </div>

  <div class="header-container right-top">
    <div class="header-box">Nasze podr√≥≈ºe</div>
    <button id="addTripBtn" class="add-btn" style="display: none;">‚ûï Dodaj wyprawƒô</button>
    <button id="editModeBtn" class="edit-btn">üîß Tryb edycji</button>
  </div>

  <div id="map"></div>

  <div id="tripModal" class="modal" style="display: none;">
    <div class="modal-content">
      <h2 id="tripModalTitle">Dodaj wyprawƒô</h2>
      <form id="tripForm">
        <input type="hidden" id="tripId">
        <label>Nazwa: <input type="text" id="tripName" required></label><br>
        <label>Opis: <textarea id="tripDescription" required></textarea></label><br>
        <label>Data rozpoczƒôcia: <input type="date" id="tripStartDate"></label><br>
        <label>Data zako≈Ñczenia: <input type="date" id="tripEndDate"></label><br>
        <button type="submit" id="tripFormSubmit">Zapisz</button>
      </form>
    </div>
  </div>
  
  <div id="msgModal" class="msg-modal" style="display: none">
    <div class="msg-modal-content">
      <p id="msgText"></p>
      <button onclick="closeMsgModal()">OK</button>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script type="module">
    // Import necessary Firebase services
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Global variables for Firebase services and user data
    let app, auth, db;
    let userId = null;
    let editMode = false;
    let map = null;
    let tripMarkers = {}; // Stores Leaflet markers for trips

    // --- Firebase Initialization and Authentication ---
    // Check for the Firebase configuration provided by the environment
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    if (firebaseConfig) {
      // Initialize Firebase app
      app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      auth = getAuth(app);

      // Listen for auth state changes and sign in
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          userId = user.uid;
          console.log("User is signed in with UID:", userId);
          // Set up listeners for data only after successful sign-in
          setupTripListener();
        } else {
          // User is signed out, sign in with the custom token or anonymously
          console.log("No user signed in. Signing in...");
          if (initialAuthToken) {
            try {
              await signInWithCustomToken(auth, initialAuthToken);
              console.log("Signed in with custom token.");
            } catch (error) {
              console.error("Error signing in with custom token:", error);
              // Fallback to anonymous sign-in if custom token fails
              await signInAnonymously(auth);
            }
          } else {
            await signInAnonymously(auth);
            console.log("Signed in anonymously.");
          }
          userId = auth.currentUser?.uid || crypto.randomUUID();
          setupTripListener();
        }
      });
    } else {
      console.error("Firebase configuration not provided. The app will not function correctly.");
      showMessage("B≈ÇƒÖd: Konfiguracja Firebase nie zosta≈Ça dostarczona.");
    }

    // --- Data Handling and Listeners ---
    function setupTripListener() {
      if (!db || !userId) return; // Wait for db and userId to be ready

      const tripsRef = collection(db, `artifacts/${appId}/public/data/trips`);
      
      // Listen for real-time updates to the trips collection
      onSnapshot(tripsRef, (snapshot) => {
        const trips = [];
        snapshot.forEach((doc) => {
          trips.push({ id: doc.id, ...doc.data() });
        });
        displayTrips(trips);
      }, (error) => {
        console.error("B≈ÇƒÖd podczas pobierania wypraw:", error);
        showMessage("WystƒÖpi≈Ç b≈ÇƒÖd podczas ≈Çadowania wypraw.");
      });
    }

    // --- UI and Map Functions ---
    function initializeMap() {
      if (map === null) {
        map = L.map('map').setView([51.505, -0.09], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);

        map.on('click', function(e) {
          if (editMode) {
            const { lat, lng } = e.latlng;
            openTripModal(lat, lng);
          }
        });
      }
    }

    function displayTrips(trips) {
      // Clear existing markers
      Object.values(tripMarkers).forEach(marker => marker.remove());
      tripMarkers = {};

      if (map === null) {
          initializeMap();
      }

      trips.forEach(trip => {
        const marker = L.marker([trip.latitude, trip.longitude]).addTo(map);
        tripMarkers[trip.id] = marker;
        
        let popupContent = `<b>${trip.name}</b><br>${trip.description}`;
        if (trip.startDate) {
            popupContent += `<br>Od: ${formatDate(trip.startDate)}`;
        }
        if (trip.endDate) {
            popupContent += `<br>Do: ${formatDate(trip.endDate)}`;
        }
        popupContent += `<br><br><a href="trip.html?tripId=${trip.id}">Zobacz szczeg√≥≈Çy</a>`;

        if (editMode) {
          popupContent += `<br><button onclick="editTrip('${trip.id}')" class="btn btn-edit">Edytuj</button>`;
          popupContent += `<button onclick="deleteTrip('${trip.id}')" class="btn btn-delete">Usu≈Ñ</button>`;
        }

        marker.bindPopup(popupContent);
      });
    }

    window.openTripModal = function(lat = null, lng = null) {
      document.getElementById("tripModalTitle").textContent = "Dodaj wyprawƒô";
      document.getElementById("tripId").value = "";
      document.getElementById("tripName").value = "";
      document.getElementById("tripDescription").value = "";
      document.getElementById("tripStartDate").value = "";
      document.getElementById("tripEndDate").value = "";
      
      // If coordinates are provided, save them for the new trip
      if (lat !== null && lng !== null) {
        window.tempTripLat = lat;
        window.tempTripLng = lng;
      }
      
      document.getElementById("tripModal").style.display = "flex";
    };

    window.editTrip = async function(tripId) {
        if (!db) return;
        const tripRef = doc(db, `artifacts/${appId}/public/data/trips`, tripId);
        try {
            const tripDoc = await getDoc(tripRef);
            if (tripDoc.exists()) {
                const tripData = tripDoc.data();
                document.getElementById("tripModalTitle").textContent = "Edytuj wyprawƒô";
                document.getElementById("tripId").value = tripId;
                document.getElementById("tripName").value = tripData.name;
                document.getElementById("tripDescription").value = tripData.description;
                document.getElementById("tripStartDate").value = tripData.startDate || "";
                document.getElementById("tripEndDate").value = tripData.endDate || "";
                window.tempTripLat = tripData.latitude;
                window.tempTripLng = tripData.longitude;
                document.getElementById("tripModal").style.display = "flex";
            } else {
                showMessage("Wyprawa nie znaleziona.");
            }
        } catch (error) {
            console.error("B≈ÇƒÖd podczas ≈Çadowania danych wyprawy do edycji:", error);
            showMessage("Nie uda≈Ço siƒô za≈Çadowaƒá danych wyprawy.");
        }
    };

    document.getElementById("tripForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      if (!db || !userId) {
        showMessage("B≈ÇƒÖd: Nie po≈ÇƒÖczono z bazƒÖ danych.");
        return;
      }

      const tripId = document.getElementById("tripId").value;
      const tripName = document.getElementById("tripName").value;
      const tripDescription = document.getElementById("tripDescription").value;
      const tripStartDate = document.getElementById("tripStartDate").value;
      const tripEndDate = document.getElementById("tripEndDate").value;
      const newTripId = generateId(tripName);

      const tripData = {
        name: tripName,
        description: tripDescription,
        startDate: tripStartDate,
        endDate: tripEndDate,
        latitude: window.tempTripLat,
        longitude: window.tempTripLng,
        ownerId: userId,
      };

      try {
        if (tripId) {
          // Update existing trip
          const tripRef = doc(db, `artifacts/${appId}/public/data/trips`, tripId);
          await updateDoc(tripRef, tripData);
          showMessage("Wyprawa zaktualizowana!");
        } else {
          // Add new trip
          const tripRef = doc(db, `artifacts/${appId}/public/data/trips`, newTripId);
          const tripDoc = await getDoc(tripRef);
          if (tripDoc.exists()) {
             showMessage("Wyprawa o takiej nazwie ju≈º istnieje. Proszƒô u≈ºyƒá innej nazwy.");
             return;
          }
          await setDoc(tripRef, tripData);
          showMessage("Wyprawa dodana!");
        }
        closeTripModal();
      } catch (error) {
        console.error("B≈ÇƒÖd podczas zapisywania wyprawy:", error);
        showMessage("Nie uda≈Ço siƒô zapisaƒá wyprawy.");
      }
    });

    document.getElementById("editModeBtn").addEventListener("click", function() {
      editMode = !editMode;
      const editBtn = document.getElementById("editModeBtn");
      const addBtn = document.getElementById("addTripBtn");
      if (editMode) {
        editBtn.textContent = "‚úÖ Tryb widza";
        editBtn.style.backgroundColor = "#28a745";
        addBtn.style.display = "block";
        document.getElementById("authModal").style.display = "flex";
      } else {
        editBtn.textContent = "üîß Tryb edycji";
        editBtn.style.backgroundColor = "#007bff";
        addBtn.style.display = "none";
        closeAuthModal();
      }
      // Re-display trips to update popups with edit/delete buttons
      const tripsRef = collection(db, `artifacts/${appId}/public/data/trips`);
      getDocs(tripsRef).then(snapshot => {
        const trips = [];
        snapshot.forEach(doc => trips.push({ id: doc.id, ...doc.data() }));
        displayTrips(trips);
      });
    });

    document.getElementById("addTripBtn").addEventListener("click", function() {
      openTripModal();
    });

    window.checkPassword = function() {
      const password = document.getElementById("adminPassword").value;
      if (password === "admin123") { // Replace with a more secure check
        closeAuthModal();
        showMessage("W≈ÇƒÖczono tryb edycji.");
      } else {
        showMessage("Nieprawid≈Çowe has≈Ço.");
      }
    };

    window.deleteTrip = function(tripId) {
      if (!db || !userId) return;
      if (confirm("Czy na pewno chcesz usunƒÖƒá tƒô wyprawƒô?")) {
        const tripRef = doc(db, `artifacts/${appId}/public/data/trips`, tripId);
        deleteDoc(tripRef)
          .then(() => {
            showMessage("Wyprawa zosta≈Ça usuniƒôta.");
          })
          .catch((err) => {
            console.error("B≈ÇƒÖd podczas usuwania:", err);
            showMessage("Nie uda≈Ço siƒô usunƒÖƒá wyprawy.");
          });
      }
    };

    function generateId(name) {
      return name
        .toLowerCase()
        .trim()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/[^a-z0-9]/g, "_")
        .replace(/_+/g, "_")
        .replace(/^_+|_+$/g, "");
    }

    function formatDate(dateStr) {
      return dateStr ? new Date(dateStr).toLocaleDateString("pl-PL", { day: "numeric", month: "long", year: "numeric" }) : "Brak daty";
    }
    
    // --- Obs≈Çuga UI i modal√≥w ---\
    window.closeTripModal = function() { document.getElementById("tripModal").style.display = "none"; };
    window.closeAuthModal = function() { document.getElementById("authModal").style.display = "none"; };
    window.showMessage = function(text) {
      document.getElementById("msgText").textContent = text;
      document.getElementById("msgModal").style.display = "flex";
    };
    window.closeMsgModal = function() { document.getElementById("msgModal").style.display = "none"; };

    document.addEventListener("keydown", function(e) {
      if (e.key === "Escape") {
        closeTripModal();
        closeAuthModal();
        closeMsgModal();
      }
    });

    // Initialize the map on page load
    window.onload = initializeMap;

  </script>
</body>
</html>
