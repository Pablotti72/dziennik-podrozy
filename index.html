<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dziennik podróży</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
  <div id="authModal" class="modal" style="display: none;">
    <div class="modal-content">
      <h2>🔐 Dostęp do edycji</h2>
      <p>Wprowadź hasło administratora, aby edytować.</p>
      <input type="password" id="adminPassword" placeholder="Hasło">
      <button onclick="checkPassword()">Wejdź</button>
      <button onclick="closeAuthModal()" style="margin-top: 10px;">Anuluj</button>
    </div>
  </div>

  <div class="header-container right-top">
    <div class="header-box">Nasze podróże</div>
    <button id="addTripBtn" class="add-btn" style="display: none;">➕ Dodaj wyprawę</button>
    <button id="editModeBtn" class="edit-btn">🔧 Tryb edycji</button>
  </div>

  <div id="map"></div>

  <div id="tripModal" class="modal" style="display: none;">
    <div class="modal-content scrollable-modal">
      <h2 id="tripModalTitle">Dodaj wyprawę</h2>
      <form id="tripForm">
        <input type="hidden" id="tripId">
        <label>Nazwa: <input type="text" id="tripName" required></label><br><br>
        <label>Opis: <textarea id="tripDescription" rows="3"></textarea></label><br><br>
        <label>Zdjęcie (URL): <input type="url" id="tripImage" required></label><br><br>
        <label>Data od: <input type="date" id="tripDateFrom" required></label><br><br>
        <label>Data do: <input type="date" id="tripDateTo" required></label><br><br>

        <button type="submit">Zapisz</button>
        <button type="button" onclick="closeTripModal()">Anuluj</button>
      </form>
    </div>
  </div>

  <div id="msgModal" class="msg-modal" style="display: none;">
    <div class="msg-modal-content">
      <p id="msgText"></p>
      <button onclick="closeMsgModal()">OK</button>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const firebaseBaseUrl = "https://moj-dziennik-podrozy-default-rtdb.europe-west1.firebasedatabase.app";
    const editModeBtn = document.getElementById("editModeBtn");
    const addTripBtn = document.getElementById("addTripBtn");
    const adminPassword = "admin";

    let isEditing = sessionStorage.getItem("isEditing") === "true";
    updateEditModeButton();

    const map = L.map("map");
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

    // --- Ładowanie i wyświetlanie danych ---
    function loadTrips() {
        fetch(`${firebaseBaseUrl}/trips.json`)
            .then(res => res.json())
            .then(trips => {
                map.eachLayer(l => { if (l instanceof L.Marker) map.removeLayer(l); });

                const tripMarkers = [];
                if (trips) {
                    Object.keys(trips).forEach(key => {
                        const trip = trips[key];
                        if (trip.lat && trip.lng) {
                            const marker = L.marker([trip.lat, trip.lng]).addTo(map);
                            marker.bindPopup(`<strong>${trip.name}</strong><br>${trip.description || ''}`);

                            marker.on("click", function() {
                                saveMapState();
                                window.location.href = `trip.html?id=${key}&from=index`;
                            });

                            if (isEditing) {
                                const popupContent = `
                                    <strong>${trip.name}</strong><br>
                                    <small>${trip.description || ''}</small><br>
                                    <img src="${trip.image}" width="100"><br><br>
                                    <button onclick="editTrip('${key}')">✏️ Edytuj</button>
                                    <button onclick="deleteTrip('${key}')">🗑️ Usuń</button>
                                `;
                                marker.bindPopup(popupContent);
                            }
                        }
                    });
                }

                restoreMapState();
            })
            .catch(err => {
                console.error("Błąd ładowania wypraw:", err);
                showMessage("❌ Nie udało się załadować listy wypraw.");
            });
    }

    // --- Zapisywanie i odtwarzanie stanu mapy ---
    function saveMapState() {
        sessionStorage.setItem('mapCenterLat', map.getCenter().lat);
        sessionStorage.setItem('mapCenterLng', map.getCenter().lng);
        sessionStorage.setItem('mapZoom', map.getZoom());
    }

    function restoreMapState() {
        const savedLat = sessionStorage.getItem('mapCenterLat');
        const savedLng = sessionStorage.getItem('mapCenterLng');
        const savedZoom = sessionStorage.getItem('mapZoom');

        if (savedLat && savedLng && savedZoom) {
            map.setView([parseFloat(savedLat), parseFloat(savedLng)], parseInt(savedZoom));
            sessionStorage.removeItem('mapCenterLat');
            sessionStorage.removeItem('mapCenterLng');
            sessionStorage.removeItem('mapZoom');
        } else {
            map.setView([52.237, 21.017], 6); // Domyślny widok na Polskę
        }
    }

    // --- Logika edycji ---
    editModeBtn.addEventListener("click", function() {
      if (isEditing) {
        isEditing = false;
        sessionStorage.setItem("isEditing", "false");
        updateEditModeButton();
        loadTrips();
      } else {
        document.getElementById("authModal").style.display = "flex";
      }
    });

    window.checkPassword = function() {
        const password = document.getElementById("adminPassword").value;
        if (password === adminPassword) {
            isEditing = true;
            sessionStorage.setItem("isEditing", "true");
            updateEditModeButton();
            closeAuthModal();
            loadTrips();
        } else {
            showMessage("❌ Nieprawidłowe hasło.");
        }
    };

    function updateEditModeButton() {
        if (isEditing) {
            editModeBtn.textContent = "✅ Tryb edycji";
            editModeBtn.style.background = "#4CAF50";
            addTripBtn.style.display = "block";
        } else {
            editModeBtn.textContent = "🔧 Tryb edycji";
            editModeBtn.style.background = "#FFC107";
            addTripBtn.style.display = "none";
        }
    }

    addTripBtn.addEventListener("click", function() {
      openTripModal();
      map.on("click", onMapClick);
    });

    let newTripCoords = null;
    function onMapClick(e) {
      newTripCoords = e.latlng;
      map.off("click", onMapClick);
      document.getElementById("tripModal").style.display = "flex";
    }

    window.openTripModal = function() {
      document.getElementById("tripForm").reset();
      document.getElementById("tripId").value = "";
      document.getElementById("tripModalTitle").textContent = "Dodaj nową wyprawę";
      document.getElementById("tripModal").style.display = "flex";
    };

    window.editTrip = function(id) {
        saveMapState();
        fetch(`${firebaseBaseUrl}/trips/${id}.json`)
            .then(res => res.json())
            .then(trip => {
                if (trip) {
                    document.getElementById("tripId").value = id;
                    document.getElementById("tripName").value = trip.name;
                    document.getElementById("tripDescription").value = trip.description || '';
                    document.getElementById("tripImage").value = trip.image;
                    document.getElementById("tripDateFrom").value = trip.dateFrom;
                    document.getElementById("tripDateTo").value = trip.dateTo;
                    document.getElementById("tripModalTitle").textContent = "Edytuj wyprawę";
                    document.getElementById("tripModal").style.display = "flex";
                }
            });
    };

    document.getElementById("tripForm").addEventListener("submit", function(e) {
      e.preventDefault();

      const tripId = document.getElementById("tripId").value;
      const isEdit = tripId !== "";
      const url = isEdit ?
        `${firebaseBaseUrl}/trips/${tripId}.json` :
        `${firebaseBaseUrl}/trips/${generateId(document.getElementById("tripName").value)}.json`;

      const tripData = {
        name: document.getElementById("tripName").value,
        description: document.getElementById("tripDescription").value,
        image: document.getElementById("tripImage").value,
        dateFrom: document.getElementById("tripDateFrom").value,
        dateTo: document.getElementById("tripDateTo").value,
        lat: newTripCoords ? newTripCoords.lat : null,
        lng: newTripCoords ? newTripCoords.lng : null
      };

      fetch(url, {
        method: isEdit ? "PATCH" : "PUT",
        body: JSON.stringify(tripData),
        headers: { "Content-Type": "application/json" }
      })
      .then(() => {
        closeTripModal();
        showMessage("✅ Zapisano!");
        loadTrips();
        newTripCoords = null;
      })
      .catch(err => {
        console.error("Błąd zapisu:", err);
        showMessage("❌ Nie udało się zapisać.");
      });
    });

    window.deleteTrip = function(id) {
      if (confirm("Czy na pewno chcesz usunąć tę wyprawę?")) {
        fetch(`${firebaseBaseUrl}/trips/${id}.json`, { method: "DELETE" })
          .then(() => {
            showMessage("✅ Usunięto!");
            loadTrips();
          })
          .catch(err => {
            console.error("Błąd usuwania:", err);
            showMessage("❌ Nie udało się usunąć wyprawy.");
          });
      }
    };

    function generateId(name) {
      return name
        .toLowerCase()
        .trim()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/[^a-z0-9]/g, "_")
        .replace(/_+/g, "_")
        .replace(/^_+|_+$/g, "");
    }

    function formatDate(dateStr) {
      return dateStr ? new Date(dateStr).toLocaleDateString("pl-PL", { day: "numeric", month: "long", year: "numeric" }) : "Brak daty";
    }
    
    // --- Obsługa UI i modalów ---
    window.closeTripModal = function() { document.getElementById("tripModal").style.display = "none"; };
    window.closeAuthModal = function() { document.getElementById("authModal").style.display = "none"; };
    window.showMessage = function(text) {
      document.getElementById("msgText").textContent = text;
      document.getElementById("msgModal").style.display = "flex";
    };
    window.closeMsgModal = function() { document.getElementById("msgModal").style.display = "none"; };

    document.addEventListener("keydown", function(e) {
      if (e.key === "Escape") {
        closeTripModal();
        closeAuthModal();
        closeMsgModal();
      }
    });

    loadTrips();
  </script>
</body>
</html>