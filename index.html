<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dziennik podróży</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" />
</head>
<body>
  <div id="authModal" class="modal" style="display: none;">
    <div class="modal-content">
      <h2>🔐 Dostęp do edycji</h2>
      <p>Wprowadź hasło administratora, aby edytować.</p>
      <input type="password" id="adminPassword" placeholder="Hasło" autocomplete="current-password">
      <button onclick="checkPassword()">Wejdź</button>
      <button onclick="closeAuthModal()" style="margin-top: 10px;">Anuluj</button>
    </div>
  </div>

  <div class="header-container right-top">
    <div class="header-box">Nasze podróże</div>
    <button id="addTripBtn" class="add-btn" style="display: none;">➕ Dodaj wyprawę</button>
    <button id="editModeBtn" class="edit-btn">🔧 Tryb edycji</button>
  </div>

  <div id="map"></div>
  <div class="loader-overlay" id="loader-overlay" style="display: none;">
    <div class="loader"></div>
  </div>

  <div id="tripModal" class="modal" style="display: none;">
    <div class="modal-content scrollable-modal">
      <h2 id="tripModalTitle">Dodaj nową wyprawę</h2>
      <form id="tripForm">
        <input type="hidden" id="tripId">
        <label>Nazwa: <input type="text" id="tripName" required></label>
        <label>Krótki opis: <textarea id="tripDescription" required></textarea></label>
        <label>Data rozpoczęcia: <input type="date" id="tripStartDate" required></label>
        <label>Data zakończenia: <input type="date" id="tripEndDate"></label>
        <label>Kategoria:
          <select id="tripCategory" required>
            <option value="trekking">⛰️ Trekking</option>
            <option value="citybreak">🏙️ City Break</option>
            <option value="relax">⛱️ Relaks</option>
            <option value="roadtrip">🚗 Road Trip</option>
            <option value="inny">🔧 Inny</option>
          </select>
        </label>
        <label>Link do zdjęcia: <input type="url" id="tripImage" placeholder="https://..."></label>
        <div class="modal-actions">
          <button type="submit" id="tripSaveBtn">Zapisz</button>
          <button type="button" onclick="closeTripModal()">Anuluj</button>
        </div>
      </form>
    </div>
  </div>

  <div id="msgModal" class="msg-modal" style="display: none;">
    <div class="msg-modal-content">
      <p id="msgText"></p>
      <button onclick="closeMsgModal()">OK</button>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script type="module">
    // --- Firebase Imports ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- Firestore Global Variables (Provided by Canvas) ---
    // DO NOT change these variables. They are automatically managed.
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // --- Firebase Initialization ---
    let app, db, auth, userId;
    let editMode = false;

    // Use a loader to indicate that the app is loading
    const showLoader = () => document.getElementById("loader-overlay").style.display = "flex";
    const hideLoader = () => document.getElementById("loader-overlay").style.display = "none";
    
    // Asynchronous function to initialize Firebase and authenticate
    const initFirebaseAndAuth = async () => {
      showLoader();
      try {
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        // Sign in with the provided token or anonymously if no token is available
        if (initialAuthToken) {
          await signInWithCustomToken(auth, initialAuthToken);
        } else {
          await signInAnonymously(auth);
        }

        onAuthStateChanged(auth, async (user) => {
          if (user) {
            userId = user.uid;
            console.log("Użytkownik zalogowany:", userId);
            hideLoader();
            await setupApp();
          } else {
            console.log("Brak zalogowanego użytkownika. Zaloguj się, aby uzyskać dostęp do edycji.");
            hideLoader();
            await setupApp();
          }
        });
      } catch (error) {
        console.error("Błąd uwierzytelniania lub inicjalizacji Firebase:", error);
        showMessage("Wystąpił błąd podczas logowania. Spróbuj ponownie.");
        hideLoader();
      }
    };

    // --- Map and UI Elements ---
    let map;
    const markers = {};
    const tripMarkers = {};

    const setupApp = async () => {
      if (!map) {
        map = L.map('map').setView([52.2297, 21.0122], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
      }
      
      await loadTrips();
      setupEventListeners();
    };

    // --- Firebase Functions ---
    async function loadTrips() {
      // Clear previous markers
      Object.values(tripMarkers).forEach(marker => marker.remove());
      Object.values(markers).forEach(marker => marker.remove());
      
      const tripsRef = collection(db, `/artifacts/${appId}/public/data/trips`);
      onSnapshot(tripsRef, (querySnapshot) => {
        Object.values(tripMarkers).forEach(marker => marker.remove());
        querySnapshot.forEach((doc) => {
          const trip = doc.data();
          trip.id = doc.id;
          if (trip.mainLocation) {
            addTripMarker(trip);
          }
        });
        hideLoader();
      }, (error) => {
        console.error("Błąd ładowania wypraw:", error);
        showMessage("Nie udało się załadować listy wypraw.");
        hideLoader();
      });
    }

    async function addTrip(trip) {
      try {
        showLoader();
        await addDoc(collection(db, `/artifacts/${appId}/public/data/trips`), trip);
        showMessage("Wyprawa dodana pomyślnie! ✅");
        hideLoader();
        closeTripModal();
      } catch (e) {
        console.error("Błąd dodawania wyprawy:", e);
        showMessage("Nie udało się dodać wyprawy.");
        hideLoader();
      }
    }

    async function updateTrip(id, data) {
      try {
        showLoader();
        await setDoc(doc(db, `/artifacts/${appId}/public/data/trips`, id), data);
        showMessage("Wyprawa zaktualizowana pomyślnie! ✅");
        hideLoader();
        closeTripModal();
      } catch (e) {
        console.error("Błąd aktualizacji wyprawy:", e);
        showMessage("Nie udało się zaktualizować wyprawy.");
        hideLoader();
      }
    }

    async function deleteTrip(id) {
      try {
        showLoader();
        await deleteDoc(doc(db, `/artifacts/${appId}/public/data/trips`, id));
        showMessage("Wyprawa usunięta pomyślnie! ✅");
        hideLoader();
      } catch (e) {
        console.error("Błąd usuwania wyprawy:", e);
        showMessage("Nie udało się usunąć wyprawy.");
        hideLoader();
      }
    }

    async function fetchTrip(id) {
        const docRef = doc(db, `/artifacts/${appId}/public/data/trips`, id);
        try {
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                return docSnap.data();
            } else {
                console.log("Brak takiego dokumentu!");
                return null;
            }
        } catch (e) {
            console.error("Błąd pobierania dokumentu:", e);
            return null;
        }
    }

    // --- Marker Functions ---
    function addTripMarker(trip) {
      const { name, mainLocation, id } = trip;
      if (!mainLocation || !mainLocation.lat || !mainLocation.lng) {
        console.error("Brak danych lokalizacji dla wyprawy:", name);
        return;
      }
      const marker = L.marker([mainLocation.lat, mainLocation.lng]).addTo(map);
      marker.bindPopup(`<b>${name}</b><br><a href="trip.html?tripId=${id}">Zobacz szczegóły</a>`);
      tripMarkers[id] = marker;

      // Edit mode functionality
      if (editMode) {
        marker.on('click', () => {
          editTrip(id);
        });
      }
    }

    function addTempMarker(lat, lng) {
      const existingTempMarker = markers['temp'];
      if (existingTempMarker) {
        existingTempMarker.remove();
      }
      const newMarker = L.marker([lat, lng]).addTo(map);
      markers['temp'] = newMarker;
    }

    // --- UI and Modal Handlers ---
    function openTripModal(trip) {
      const modal = document.getElementById("tripModal");
      const form = document.getElementById("tripForm");
      document.getElementById("tripId").value = trip ? trip.id : '';
      document.getElementById("tripModalTitle").textContent = trip ? "Edytuj wyprawę" : "Dodaj nową wyprawę";
      document.getElementById("tripName").value = trip ? trip.name : '';
      document.getElementById("tripDescription").value = trip ? trip.description : '';
      document.getElementById("tripStartDate").value = trip ? trip.startDate : '';
      document.getElementById("tripEndDate").value = trip ? trip.endDate : '';
      document.getElementById("tripCategory").value = trip ? trip.category : 'trekking';
      document.getElementById("tripImage").value = trip ? trip.image : '';
      document.getElementById("tripSaveBtn").textContent = trip ? "Zapisz zmiany" : "Dodaj wyprawę";
      
      const tripActionsContainer = document.querySelector(".modal-actions");
      const deleteBtn = tripActionsContainer.querySelector("#deleteTripBtn");
      if (deleteBtn) {
        deleteBtn.remove();
      }
      if (trip) {
        const newDeleteBtn = document.createElement("button");
        newDeleteBtn.id = "deleteTripBtn";
        newDeleteBtn.textContent = "Usuń";
        newDeleteBtn.type = "button";
        newDeleteBtn.onclick = () => {
          if (confirm("Czy na pewno chcesz usunąć tę wyprawę?")) {
            deleteTrip(trip.id);
            closeTripModal();
          }
        };
        tripActionsContainer.insertBefore(newDeleteBtn, tripActionsContainer.lastElementChild);
      }
      
      modal.style.display = "flex";
    }

    async function editTrip(id) {
        const trip = await fetchTrip(id);
        if (trip) {
            openTripModal(trip);
        }
    }

    window.closeTripModal = function() {
      document.getElementById("tripModal").style.display = "none";
    };

    window.closeAuthModal = function() {
      document.getElementById("authModal").style.display = "none";
    };
    
    window.showMessage = function(text) {
      document.getElementById("msgText").textContent = text;
      document.getElementById("msgModal").style.display = "flex";
    };
    
    window.closeMsgModal = function() {
      document.getElementById("msgModal").style.display = "none";
    };

    document.addEventListener("keydown", function(e) {
      if (e.key === "Escape") {
        closeTripModal();
        closeAuthModal();
        closeMsgModal();
      }
    });

    // --- Event Listeners ---
    function setupEventListeners() {
      document.getElementById("addTripBtn").addEventListener("click", () => {
        openTripModal();
      });

      document.getElementById("editModeBtn").addEventListener("click", () => {
        editMode = !editMode;
        document.getElementById("addTripBtn").style.display = editMode ? "block" : "none";
        document.getElementById("editModeBtn").textContent = editMode ? "✅ Wyjdź z edycji" : "🔧 Tryb edycji";

        // Open auth modal if entering edit mode
        if (editMode) {
            document.getElementById("authModal").style.display = "flex";
        }
        
        // Re-render markers to be clickable in edit mode
        loadTrips();
      });

      document.getElementById("tripForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const tripId = document.getElementById("tripId").value;
        const tripName = document.getElementById("tripName").value;
        const tripDescription = document.getElementById("tripDescription").value;
        const tripStartDate = document.getElementById("tripStartDate").value;
        const tripEndDate = document.getElementById("tripEndDate").value;
        const tripCategory = document.getElementById("tripCategory").value;
        const tripImage = document.getElementById("tripImage").value;
        
        // Use a temp marker for the main location
        const latLng = markers['temp'] ? markers['temp'].getLatLng() : null;
        const mainLocation = latLng ? { lat: latLng.lat, lng: latLng.lng } : null;

        const tripData = {
          name: tripName,
          description: tripDescription,
          startDate: tripStartDate,
          endDate: tripEndDate,
          category: tripCategory,
          image: tripImage,
          mainLocation: mainLocation,
          places: []
        };
        
        if (tripId) {
          await updateTrip(tripId, tripData);
        } else {
          await addTrip(tripData);
        }
      });
      
      map.on('click', (e) => {
        if (editMode) {
          addTempMarker(e.latlng.lat, e.latlng.lng);
        }
      });

      window.checkPassword = async function() {
        const password = document.getElementById('adminPassword').value;
        // Simple password check for demo purposes, replace with proper auth
        if (password === 'admin') {
          closeAuthModal();
          showMessage("Tryb edycji włączony. Możesz dodawać i edytować wyprawy.");
        } else {
          showMessage("Nieprawidłowe hasło. Tryb edycji nieaktywny.");
          document.getElementById('editModeBtn').textContent = "🔧 Tryb edycji";
          document.getElementById('addTripBtn').style.display = 'none';
          editMode = false;
        }
      };
    }
    
    // Initial call
    initFirebaseAndAuth();

    // --- Helper Functions ---
    function generateId(name) {
      return name
        .toLowerCase()
        .trim()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/[^a-z0-9]/g, "_")
        .replace(/_+/g, "_")
        .replace(/^_+|_+$/g, "");
    }

    function formatDate(dateStr) {
      return dateStr ? new Date(dateStr).toLocaleDateString("pl-PL", { day: "numeric", month: "long", year: "numeric" }) : "Brak daty";
    }
  </script>
</body>
</html>
