<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dziennik podr√≥≈ºy</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
  <!-- Modal do uwierzytelniania administratora -->
  <div id="authModal" class="modal" style="display: none;">
    <div class="modal-content">
      <h2>üîê Dostƒôp do edycji</h2>
      <p>Wprowad≈∫ has≈Ço administratora, aby edytowaƒá.</p>
      <input type="password" id="adminPassword" placeholder="Has≈Ço">
      <button onclick="checkPassword()">Wejd≈∫</button>
      <button onclick="closeAuthModal()" style="margin-top: 10px;">Anuluj</button>
    </div>
  </div>

  <!-- Modal do dodawania/edycji wyprawy -->
  <div id="tripModal" class="modal" style="display: none;">
    <div class="modal-content">
      <h2 id="tripModalTitle">Dodaj wyprawƒô</h2>
      <form id="tripForm">
        <input type="hidden" id="tripId">
        <label>Nazwa: <input type="text" id="tripName" required></label>
        <label>Data rozpoczƒôcia: <input type="date" id="tripStartDate" required></label>
        <label>Data zako≈Ñczenia: <input type="date" id="tripEndDate"></label>
        <label>Opis: <textarea id="tripDescription" rows="4"></textarea></label>
        <button type="submit">Zapisz</button>
        <button type="button" onclick="closeTripModal()">Anuluj</button>
      </form>
    </div>
  </div>

  <!-- Modal do wy≈õwietlania wiadomo≈õci -->
  <div id="msgModal" class="msg-modal" style="display: none">
    <div class="msg-modal-content">
      <p id="msgText"></p>
      <button onclick="closeMsgModal()">OK</button>
    </div>
  </div>

  <!-- G≈Ç√≥wny kontener nag≈Ç√≥wka i przycisk√≥w -->
  <div class="header-container right-top">
    <div class="header-box">Nasze podr√≥≈ºe</div>
    <button id="addTripBtn" class="add-btn" style="display: none;">‚ûï Dodaj wyprawƒô</button>
    <button id="editModeBtn" class="edit-btn">üîß Tryb edycji</button>
    <button id="toggleViewBtn" class="toggle-view-btn">Lista kraj√≥w</button>
  </div>

  <!-- Kontener mapy -->
  <div id="map"></div>

  <!-- Kontener listy kraj√≥w (domy≈õlnie ukryty) -->
  <div id="countryListContainer" class="country-list-container" style="display: none;">
    <h2>Kraje, kt√≥re odwiedzili≈õmy</h2>
    <div id="countriesList" class="countries-list">
      <p>≈Åadowanie kraj√≥w...</p>
    </div>
  </div>

  <!-- Skrypty -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Global variables for Firebase configuration
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // Firebase Initialization
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    
    // Global state variables
    let userId = null;
    let map = null;
    let trips = [];
    const tripMarkers = {};
    let editMode = false;
    let currentMarker = null;

    // Authentication and data loading
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        userId = user.uid;
        console.log("Authenticated with user ID:", userId);
        loadTrips();
        // Check if initial token is set, if so, we can proceed with other logic
        // If not, we can assume we are in an anonymous session
      } else {
        if (initialAuthToken) {
          try {
            await signInWithCustomToken(auth, initialAuthToken);
          } catch (error) {
            console.error("Error signing in with custom token:", error);
            await signInAnonymously(auth);
          }
        } else {
          await signInAnonymously(auth);
        }
      }
    });

    // Helper function to show a message modal
    window.showMessage = function(text) {
      document.getElementById("msgText").textContent = text;
      document.getElementById("msgModal").style.display = "flex";
    };

    window.closeMsgModal = function() {
      document.getElementById("msgModal").style.display = "none";
    };

    window.closeTripModal = function() {
      document.getElementById("tripModal").style.display = "none";
      if (currentMarker) {
        map.removeLayer(currentMarker);
      }
    };
    
    window.closeAuthModal = function() {
        document.getElementById("authModal").style.display = "none";
    };

    // Initialize map
    function initMap() {
      if (!map) {
        map = L.map('map').setView([52.0, 19.0], 6); // Centered on Poland
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        map.on('click', onMapClick);
      }
    }

    // Function to handle map clicks for adding new markers
    async function onMapClick(e) {
      if (editMode) {
        if (currentMarker) {
          map.removeLayer(currentMarker);
        }
        currentMarker = L.marker(e.latlng).addTo(map);
        document.getElementById('tripId').value = '';
        document.getElementById('tripName').value = '';
        document.getElementById('tripStartDate').value = '';
        document.getElementById('tripEndDate').value = '';
        document.getElementById('tripDescription').value = '';
        document.getElementById('tripModalTitle').textContent = 'Dodaj wyprawƒô';
        document.getElementById('tripModal').style.display = 'flex';
      }
    }

    // Function to handle form submission for saving a trip
    document.getElementById('tripForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const tripName = document.getElementById('tripName').value;
      const tripStartDate = document.getElementById('tripStartDate').value;
      const tripEndDate = document.getElementById('tripEndDate').value;
      const tripDescription = document.getElementById('tripDescription').value;
      const tripId = document.getElementById('tripId').value;

      // Reverse geocoding to get country
      let country = 'Nieznany';
      try {
          const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${currentMarker.getLatLng().lat}&lon=${currentMarker.getLatLng().lng}`);
          const data = await response.json();
          country = data.address.country || 'Nieznany';
      } catch (error) {
          console.error("Geocoding failed:", error);
      }

      const tripData = {
        name: tripName,
        startDate: tripStartDate,
        endDate: tripEndDate,
        description: tripDescription,
        latitude: currentMarker.getLatLng().lat,
        longitude: currentMarker.getLatLng().lng,
        country: country, // Add the new country field
        authorId: userId
      };

      if (tripId) {
        // Update existing trip
        try {
          await updateDoc(doc(db, `artifacts/${appId}/public/data/trips`, tripId), tripData);
          showMessage("Wyprawa zaktualizowana!");
        } catch (error) {
          console.error("Error updating trip:", error);
          showMessage("Nie uda≈Ço siƒô zaktualizowaƒá wyprawy.");
        }
      } else {
        // Add new trip
        try {
          await addDoc(collection(db, `artifacts/${appId}/public/data/trips`), tripData);
          showMessage("Wyprawa dodana!");
        } catch (error) {
          console.error("Error adding trip:", error);
          showMessage("Nie uda≈Ço siƒô dodaƒá wyprawy.");
        }
      }

      closeTripModal();
    });

    // Load trips from Firestore and listen for changes
    function loadTrips() {
      const tripsCollectionRef = collection(db, `artifacts/${appId}/public/data/trips`);
      onSnapshot(tripsCollectionRef, (snapshot) => {
        trips = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderTripsOnMap(trips);
        renderCountryList(trips);
      }, (error) => {
        console.error("Error listening to trips:", error);
        showMessage("Nie uda≈Ço siƒô za≈Çadowaƒá wypraw.");
      });
    }

    // Render trips on the map
    function renderTripsOnMap(tripsToRender) {
      // Clear all existing markers
      for (const markerId in tripMarkers) {
        map.removeLayer(tripMarkers[markerId]);
        delete tripMarkers[markerId];
      }

      if (map) {
        tripsToRender.forEach(trip => {
          const latLng = [trip.latitude, trip.longitude];
          const marker = L.marker(latLng).addTo(map)
            .bindPopup(`<b>${trip.name}</b><br>${formatDate(trip.startDate)} - ${formatDate(trip.endDate)}<br><a href="trip.html?id=${trip.id}">Zobacz szczeg√≥≈Çy</a>`);

          marker.on('contextmenu', (e) => {
            if (editMode) {
              e.preventDefault();
              showTripModal(trip);
            }
          });

          // Add a delete listener
          marker.on('dblclick', async (e) => {
            if (editMode) {
              e.preventDefault();
              if (window.confirm("Czy na pewno chcesz usunƒÖƒá tƒô wyprawƒô?")) {
                try {
                  await deleteDoc(doc(db, `artifacts/${appId}/public/data/trips`, trip.id));
                  showMessage("Wyprawa usuniƒôta!");
                } catch (error) {
                  console.error("Error deleting trip:", error);
                  showMessage("Nie uda≈Ço siƒô usunƒÖƒá wyprawy.");
                }
              }
            }
          });

          tripMarkers[trip.id] = marker;
        });
      } else {
        console.log("Map not initialized yet.");
      }
    }

    // Function to render the country list
    function renderCountryList(tripsData) {
      const countries = {};
      tripsData.forEach(trip => {
        const countryName = trip.country || 'Nieznany';
        if (!countries[countryName]) {
          countries[countryName] = 0;
        }
        countries[countryName]++;
      });

      const countriesListDiv = document.getElementById('countriesList');
      countriesListDiv.innerHTML = '';
      
      const sortedCountries = Object.keys(countries).sort();

      sortedCountries.forEach(country => {
        const countryItem = document.createElement('div');
        countryItem.className = 'country-item';
        countryItem.innerHTML = `
          <span>${country} (${countries[country]})</span>
        `;
        countryItem.addEventListener('click', () => {
          filterTripsByCountry(country);
        });
        countriesListDiv.appendChild(countryItem);
      });
    }

    // Function to filter trips by selected country
    function filterTripsByCountry(country) {
      const filteredTrips = trips.filter(trip => trip.country === country);
      renderTripsOnMap(filteredTrips);
      // Switch back to map view
      document.getElementById('map').style.display = 'block';
      document.getElementById('countryListContainer').style.display = 'none';
      document.getElementById('toggleViewBtn').textContent = 'Lista kraj√≥w';
      // Adjust map view to fit the filtered markers
      if (filteredTrips.length > 0) {
        const group = new L.featureGroup(filteredTrips.map(t => L.marker([t.latitude, t.longitude])));
        map.fitBounds(group.getBounds().pad(0.5));
      }
    }

    // Function to handle the toggle view button
    document.getElementById('toggleViewBtn').addEventListener('click', () => {
      const mapContainer = document.getElementById('map');
      const countryListContainer = document.getElementById('countryListContainer');
      const toggleViewBtn = document.getElementById('toggleViewBtn');

      if (mapContainer.style.display === 'none') {
        // Switch to map view
        mapContainer.style.display = 'block';
        countryListContainer.style.display = 'none';
        toggleViewBtn.textContent = 'Lista kraj√≥w';
        renderTripsOnMap(trips); // Render all trips
        initMap();
        map.invalidateSize();
      } else {
        // Switch to country list view
        mapContainer.style.display = 'none';
        countryListContainer.style.display = 'block';
        toggleViewBtn.textContent = 'Poka≈º mapƒô';
      }
    });

    // Helper function to format date
    function formatDate(dateStr) {
      return dateStr ? new Date(dateStr).toLocaleDateString("pl-PL", { day: "numeric", month: "long", year: "numeric" }) : "Brak daty";
    }

    // Show trip modal for editing
    function showTripModal(trip) {
      document.getElementById('tripId').value = trip.id;
      document.getElementById('tripName').value = trip.name;
      document.getElementById('tripStartDate').value = trip.startDate;
      document.getElementById('tripEndDate').value = trip.endDate;
      document.getElementById('tripDescription').value = trip.description;
      document.getElementById('tripModalTitle').textContent = 'Edytuj wyprawƒô';
      document.getElementById('tripModal').style.display = 'flex';
      currentMarker = L.marker([trip.latitude, trip.longitude]).addTo(map);
    }
    
    // Toggle edit mode
    document.getElementById('editModeBtn').addEventListener('click', () => {
        editMode = !editMode;
        const addTripBtn = document.getElementById('addTripBtn');
        const editModeBtn = document.getElementById('editModeBtn');
        if (editMode) {
            addTripBtn.style.display = 'block';
            editModeBtn.textContent = 'üõë Wy≈ÇƒÖcz edycjƒô';
            showMessage("Tryb edycji w≈ÇƒÖczony. Kliknij mapƒô, aby dodaƒá wyprawƒô, lub kliknij prawym przyciskiem, aby edytowaƒá istniejƒÖcƒÖ.");
        } else {
            addTripBtn.style.display = 'none';
            editModeBtn.textContent = 'üîß Tryb edycji';
            showMessage("Tryb edycji wy≈ÇƒÖczony.");
        }
    });

    // Initial map setup
    window.onload = function() {
      initMap();
    };

    </script>
</body>
</html>
