<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dziennik podr√≥≈ºy</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
  <!-- Modal do uwierzytelniania -->
  <div id="authModal" class="modal" style="display: none;">
    <div class="modal-content">
      <h2>üîê Dostƒôp do edycji</h2>
      <p>Wprowad≈∫ has≈Ço administratora, aby edytowaƒá.</p>
      <input type="password" id="adminPassword" placeholder="Has≈Ço">
      <button onclick="checkPassword()">Wejd≈∫</button>
      <button onclick="closeAuthModal()" style="margin-top: 10px;">Anuluj</button>
    </div>
  </div>

  <!-- Modal do dodawania/edycji wyprawy -->
  <div id="tripModal" class="modal" style="display: none;">
    <div class="modal-content scrollable-modal">
      <h2 id="tripModalTitle">Dodaj wyprawƒô</h2>
      <form id="tripForm">
        <input type="hidden" id="tripId">
        <label>Nazwa: <input type="text" id="tripName" required></label><br>
        <label>Opis: <textarea id="tripDescription" required></textarea></label><br>
        <label>Data rozpoczƒôcia: <input type="date" id="tripStartDate"></label><br>
        <label>Data zako≈Ñczenia: <input type="date" id="tripEndDate"></label><br>
        <label>Link do zdjƒôcia nag≈Ç√≥wkowego (URL): <input type="url" id="tripPhotoUrl"></label><br>
        <button type="submit" id="tripSaveBtn">Zapisz</button>
        <button type="button" onclick="closeTripModal()">Anuluj</button>
      </form>
    </div>
  </div>

  <!-- Modal do wy≈õwietlania wiadomo≈õci -->
  <div id="msgModal" class="msg-modal" style="display: none">
    <div class="msg-modal-content">
      <p id="msgText"></p>
      <button onclick="closeMsgModal()">OK</button>
    </div>
  </div>

  <div class="header-container right-top">
    <div class="header-box">Nasze podr√≥≈ºe</div>
    <button id="addTripBtn" class="add-btn" style="display: none;">‚ûï Dodaj wyprawƒô</button>
    <button id="editModeBtn" class="edit-btn">üîß Tryb edycji</button>
  </div>

  <div id="map"></div>
  <div id="tripList" class="trip-list-container"></div>

  <!-- Skrypty -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script type="module">
    // --- Konfiguracja Firebase (wymagana) ---
    // Te zmienne sƒÖ dostarczane przez ≈õrodowisko i sƒÖ niezbƒôdne do dzia≈Çania
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, orderBy, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    let app;
    let db;
    let auth;
    let userId;
    let isEditMode = false;
    let currentMap;
    let markers = {};
    let tripUnsubscribe;

    // Funkcja do inicjalizacji Firebase i uwierzytelniania
    async function initializeFirebaseAndAuth() {
      if (firebaseConfig && !app) {
        try {
          app = initializeApp(firebaseConfig);
          db = getFirestore(app);
          auth = getAuth(app);

          // S≈Çuchanie zmian stanu uwierzytelnienia
          onAuthStateChanged(auth, async (user) => {
            if (user) {
              userId = user.uid;
              console.log("U≈ºytkownik zalogowany:", userId);
              document.getElementById("authModal").style.display = "none";
              // W≈ÇƒÖczanie trybu edycji dla zalogowanych u≈ºytkownik√≥w
              if (isEditMode) {
                document.getElementById("addTripBtn").style.display = "block";
              }
              // Rozpoczƒôcie nas≈Çuchiwania danych po zalogowaniu
              await fetchTrips();
            } else {
              userId = null;
              console.log("U≈ºytkownik wylogowany.");
              document.getElementById("addTripBtn").style.display = "none";
            }
          });

          // Uwierzytelnienie za pomocƒÖ tokena lub anonimowo
          if (initialAuthToken) {
            await signInWithCustomToken(auth, initialAuthToken);
          } else {
            await signInAnonymously(auth);
          }
        } catch (error) {
          console.error("B≈ÇƒÖd inicjalizacji Firebase:", error);
          showMessage("B≈ÇƒÖd inicjalizacji aplikacji. Spr√≥buj od≈õwie≈ºyƒá stronƒô.");
        }
      }
    }

    // Wywo≈Çanie funkcji inicjalizujƒÖcej
    initializeFirebaseAndAuth();

    // Funkcja do renderowania listy wypraw
    function renderTrips(trips) {
      const tripListContainer = document.getElementById("tripList");
      tripListContainer.innerHTML = '';
      if (currentMap) {
        currentMap.eachLayer(layer => {
          if (layer instanceof L.Marker) {
            layer.remove();
          }
        });
        markers = {};
      }

      if (trips.length === 0) {
        tripListContainer.innerHTML = '<p class="no-trips-msg">Brak zapisanych wypraw.</p>';
        return;
      }

      trips.forEach(trip => {
        const tripCard = document.createElement("a");
        tripCard.href = `trip.html?id=${trip.id}`;
        tripCard.className = "trip-card";
        
        // Dynamiczne t≈Ço z zdjƒôcia wyprawy
        if (trip.photoUrl) {
          tripCard.style.backgroundImage = `url('${trip.photoUrl}')`;
          tripCard.style.backgroundSize = 'cover';
          tripCard.style.backgroundPosition = 'center';
        }

        tripCard.innerHTML = `
          <div class="card-content">
            <h3>${trip.name}</h3>
            <p>${formatDate(trip.startDate)} - ${formatDate(trip.endDate)}</p>
          </div>
        `;

        // Przyciski edycji i usuwania w trybie edycji
        if (isEditMode) {
          const editBtn = document.createElement("button");
          editBtn.className = "edit-btn-card";
          editBtn.innerHTML = '‚úèÔ∏è';
          editBtn.onclick = (e) => {
            e.preventDefault();
            e.stopPropagation();
            editTrip(trip);
          };
          
          const deleteBtn = document.createElement("button");
          deleteBtn.className = "delete-btn-card";
          deleteBtn.innerHTML = '‚ùå';
          deleteBtn.onclick = (e) => {
            e.preventDefault();
            e.stopPropagation();
            if (window.confirm("Czy na pewno chcesz usunƒÖƒá tƒô wyprawƒô?")) {
              deleteTrip(trip.id);
            }
          };

          const cardButtons = document.createElement("div");
          cardButtons.className = "card-buttons";
          cardButtons.appendChild(editBtn);
          cardButtons.appendChild(deleteBtn);
          tripCard.appendChild(cardButtons);
        }
        
        tripListContainer.appendChild(tripCard);
      });
    }

    // Funkcja do pobierania wypraw z Firestore
    async function fetchTrips() {
      if (tripUnsubscribe) {
        tripUnsubscribe();
      }
      
      const tripsRef = collection(db, `artifacts/${appId}/public/data/trips`);
      const q = query(tripsRef);
      
      tripUnsubscribe = onSnapshot(q, (snapshot) => {
        const trips = [];
        snapshot.forEach((doc) => {
          trips.push({ id: doc.id, ...doc.data() });
        });
        renderTrips(trips);
      }, (error) => {
        console.error("B≈ÇƒÖd podczas pobierania wypraw:", error);
        showMessage("Nie uda≈Ço siƒô pobraƒá wypraw. Spr√≥buj ponownie p√≥≈∫niej.");
      });
    }

    // --- Obs≈Çuga trybu edycji ---
    document.getElementById("editModeBtn").onclick = () => {
      isEditMode = !isEditMode;
      const editBtn = document.getElementById("editModeBtn");
      const addBtn = document.getElementById("addTripBtn");
      
      if (isEditMode) {
        editBtn.textContent = "‚úÖ Zako≈Ñcz edycjƒô";
        editBtn.classList.add("active");
        if (userId) { // Poka≈º przycisk dodawania tylko je≈õli zalogowany
          addBtn.style.display = "block";
        }
      } else {
        editBtn.textContent = "üîß Tryb edycji";
        editBtn.classList.remove("active");
        addBtn.style.display = "none";
      }
      // Ponowne renderowanie, aby pokazaƒá/ukryƒá przyciski edycji
      fetchTrips(); 
    };
    
    // --- Obs≈Çuga dodawania/edycji wyprawy ---
    document.getElementById("addTripBtn").onclick = () => {
      document.getElementById("tripModalTitle").textContent = "Dodaj wyprawƒô";
      document.getElementById("tripId").value = "";
      document.getElementById("tripName").value = "";
      document.getElementById("tripDescription").value = "";
      document.getElementById("tripStartDate").value = "";
      document.getElementById("tripEndDate").value = "";
      document.getElementById("tripPhotoUrl").value = "";
      document.getElementById("tripModal").style.display = "flex";
    };

    async function editTrip(trip) {
      document.getElementById("tripModalTitle").textContent = "Edytuj wyprawƒô";
      document.getElementById("tripId").value = trip.id;
      document.getElementById("tripName").value = trip.name;
      document.getElementById("tripDescription").value = trip.description;
      document.getElementById("tripStartDate").value = trip.startDate || "";
      document.getElementById("tripEndDate").value = trip.endDate || "";
      document.getElementById("tripPhotoUrl").value = trip.photoUrl || "";
      document.getElementById("tripModal").style.display = "flex";
    }

    document.getElementById("tripForm").onsubmit = async (e) => {
      e.preventDefault();
      const tripId = document.getElementById("tripId").value;
      const tripData = {
        name: document.getElementById("tripName").value,
        description: document.getElementById("tripDescription").value,
        startDate: document.getElementById("tripStartDate").value,
        endDate: document.getElementById("tripEndDate").value,
        photoUrl: document.getElementById("tripPhotoUrl").value,
        userId: userId
      };

      try {
        if (tripId) {
          // Edycja istniejƒÖcej wyprawy
          await updateDoc(doc(db, `artifacts/${appId}/public/data/trips`, tripId), tripData);
          showMessage("Wyprawa zaktualizowana!");
        } else {
          // Dodawanie nowej wyprawy
          await addDoc(collection(db, `artifacts/${appId}/public/data/trips`), tripData);
          showMessage("Wyprawa dodana!");
        }
        closeTripModal();
      } catch (e) {
        console.error("B≈ÇƒÖd podczas zapisywania wyprawy:", e);
        showMessage("Nie uda≈Ço siƒô zapisaƒá wyprawy.");
      }
    };
    
    window.deleteTrip = async (tripId) => {
      try {
        await deleteDoc(doc(db, `artifacts/${appId}/public/data/trips`, tripId));
        showMessage("Wyprawa usuniƒôta!");
      } catch (e) {
        console.error("B≈ÇƒÖd podczas usuwania wyprawy:", e);
        showMessage("Nie uda≈Ço siƒô usunƒÖƒá wyprawy.");
      }
    };

    // --- Funkcje pomocnicze ---
    function formatDate(dateStr) {
      return dateStr ? new Date(dateStr).toLocaleDateString("pl-PL", { day: "numeric", month: "long", year: "numeric" }) : "Brak daty";
    }
    
    // --- Obs≈Çuga UI i modal√≥w ---
    window.closeTripModal = function() { document.getElementById("tripModal").style.display = "none"; };
    window.closeAuthModal = function() { document.getElementById("authModal").style.display = "none"; };
    window.showMessage = function(text) {
      document.getElementById("msgText").textContent = text;
      document.getElementById("msgModal").style.display = "flex";
    };
    window.closeMsgModal = function() { document.getElementById("msgModal").style.display = "none"; };

    document.addEventListener("keydown", function(e) {
      if (e.key === "Escape") {
        closeTripModal();
        closeAuthModal();
        closeMsgModal();
      }
    });

    // Inicjalizacja mapy Leaflet
    const mapContainer = document.getElementById("map");
    if (mapContainer) {
      currentMap = L.map('map').setView([52.0, 19.0], 6); // Centrum Polski
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
      }).addTo(currentMap);
    }
  </script>
</body>
</html>
