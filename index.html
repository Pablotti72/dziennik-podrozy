<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dziennik podróży</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
  <div id="authModal" class="modal" style="display: none;">
    <div class="modal-content">
      <h2>🔐 Logowanie</h2>
      <p>Wprowadź dane administratora, aby edytować.</p>
      <input type="email" id="adminEmail" placeholder="Email">
      <input type="password" id="adminPassword" placeholder="Hasło">
      <button onclick="signIn()">Zaloguj</button>
      <button onclick="closeAuthModal()" style="margin-top: 10px;">Anuluj</button>
    </div>
  </div>

  <div class="header-container right-top">
    <div class="header-box">Nasze podróże</div>
    <button id="addTripBtn" class="add-btn" style="display: none;">➕ Dodaj wyprawę</button>
    <button id="editModeBtn" class="edit-btn">🔧 Tryb edycji</button>
  </div>

  <div id="map"></div>

  <div id="tripModal" class="modal" style="display: none;">
    <div class="modal-content">
      <h2>Dodaj/Edytuj wyprawę</h2>
      <form id="tripForm">
        <input type="hidden" id="tripId">
        <label>Nazwa wyprawy: <input type="text" id="tripName" required></label><br>
        <label>Kategoria:
          <select id="tripCategory" required>
            <option value="miasto">🏙️ Miasto</option>
            <option value="park">🌳 Park</option>
            <option value="zabytek">🏛️ Zabytek</option>
            <option value="inne">⚙️ Inne</option>
          </select>
        </label><br>
        <label>Data od: <input type="date" id="tripDateFrom"></label><br>
        <label>Data do: <input type="date" id="tripDateTo"></label><br>
        <label>Główne zdjęcie (URL): <input type="url" id="tripMainPhotoUrl"></label><br>
        <label>Opis: <textarea id="tripDescription" rows="4"></textarea></label><br>
        <button type="submit">Zapisz</button>
        <button type="button" onclick="closeTripModal()">Anuluj</button>
      </form>
    </div>
  </div>

  <div id="msgModal" class="msg-modal" style="display: none">
    <div class="msg-modal-content">
      <p id="msgText"></p>
      <button onclick="closeMsgModal()">OK</button>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getDatabase, ref, onValue, set, update, remove, push } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBcRB_dec2OunBPevgemcWouCfDP6dNZV4",
      authDomain: "moj-dziennik-podrozy.firebaseapp.com",
      databaseURL: "https://moj-dziennik-podrozy-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "moj-dziennik-podrozy",
      storageBucket: "moj-dziennik-podrozy.firebasestorage.app",
      messagingSenderId: "997572019753",
      appId: "1:997572019753:web:0f5aa78a1c24072de3be38"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const editModeBtn = document.getElementById("editModeBtn");
    const addTripBtn = document.getElementById("addTripBtn");
    let isEditing = sessionStorage.getItem("isEditing") === "true";
    updateEditModeButton();

    function updateEditModeButton() {
      if (isEditing) {
        editModeBtn.textContent = "✅ Zakończ edycję";
        editModeBtn.style.background = "#F44336";
        addTripBtn.style.display = "block";
      } else {
        editModeBtn.textContent = "🔧 Tryb edycji";
        editModeBtn.style.background = "#FFC107";
        addTripBtn.style.display = "none";
      }
    }

    editModeBtn.addEventListener("click", function() {
      if (isEditing) {
        signOut(auth).then(() => {
          isEditing = false;
          sessionStorage.setItem("isEditing", "false");
          updateEditModeButton();
          loadTrips();
          showMessage("✅ Wylogowano pomyślnie.");
        }).catch((error) => {
          console.error("Błąd wylogowania:", error);
        });
      } else {
        document.getElementById("authModal").style.display = "flex";
      }
    });

    window.signIn = function() {
      const email = document.getElementById("adminEmail").value;
      const password = document.getElementById("adminPassword").value;

      signInWithEmailAndPassword(auth, email, password)
        .then((userCredential) => {
          onValue(ref(db, `admins/${userCredential.user.uid}`), (snapshot) => {
            if (snapshot.exists()) {
              isEditing = true;
              sessionStorage.setItem("isEditing", "true");
              updateEditModeButton();
              closeAuthModal();
              loadTrips();
              showMessage("✅ Zalogowano jako administrator!");
            } else {
              signOut(auth);
              showMessage("❌ Brak uprawnień administratora.");
            }
          }, { onlyOnce: true });
        })
        .catch((error) => {
          showMessage(`❌ Błąd logowania: ${error.message}`);
        });
    };

    const map = L.map("map").setView([52.2297, 21.0122], 6);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
    }).addTo(map);

    let tripMarkers = {};

    function getCategoryIcon(category) {
      const icons = {
        miasto: "🏙️",
        park: "🌳",
        zabytek: "🏛️",
        inne: "⚙️",
      };
      return icons[category] || "";
    }

    function createTripPopupContent(trip) {
      let content = `
        <div class="popup-content">
          <img src="${trip.mainPhotoUrl || 'https://via.placeholder.com/100x70?text=Brak+zdj'}" alt="${trip.name}" width="100" />
          <h4>${getCategoryIcon(trip.category)} ${trip.name}</h4>
          <p class="popup-date">
            ${trip.dateFrom ? new Date(trip.dateFrom).toLocaleDateString("pl-PL") : ''}
            ${trip.dateTo ? ' - ' + new Date(trip.dateTo).toLocaleDateString("pl-PL") : ''}
          </p>
          <div class="popup-buttons">
            <a href="trip.html?id=${trip.id}" class="popup-button">Zobacz</a>
      `;

      if (isEditing) {
        content += `
            <button class="popup-button edit-btn" onclick="editTrip('${trip.id}')">✏️</button>
            <button class="popup-button delete-btn" onclick="deleteTrip('${trip.id}')">🗑️</button>
        `;
      }

      content += `</div></div>`;
      return content;
    }

    async function loadTrips() {
      for (const markerId in tripMarkers) {
        map.removeLayer(tripMarkers[markerId]);
      }
      tripMarkers = {};

      onValue(ref(db, 'trips'), (snapshot) => {
        const trips = snapshot.val();
        if (trips) {
          Object.keys(trips).forEach((id) => {
            const trip = trips[id];
            trip.id = id;
            if (trip.mainLat && trip.mainLng) {
              const marker = L.marker([trip.mainLat, trip.mainLng]).addTo(map);
              marker.bindPopup(createTripPopupContent(trip));
              tripMarkers[id] = marker;
            }
          });
        }
      }, { onlyOnce: true });
    }
    loadTrips();

    const tripForm = document.getElementById("tripForm");
    const tripModal = document.getElementById("tripModal");

    window.addTripBtn.addEventListener("click", () => {
      document.getElementById("tripId").value = "";
      tripForm.reset();
      tripModal.style.display = "flex";
    });

    tripForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const id = document.getElementById("tripId").value;
      const tripData = {
        name: document.getElementById("tripName").value,
        category: document.getElementById("tripCategory").value,
        dateFrom: document.getElementById("tripDateFrom").value,
        dateTo: document.getElementById("tripDateTo").value,
        mainPhotoUrl: document.getElementById("tripMainPhotoUrl").value,
        description: document.getElementById("tripDescription").value,
      };

      if (id) {
        update(ref(db, `trips/${id}`), tripData)
          .then(() => {
            showMessage("✅ Wyprawa zaktualizowana!");
            closeTripModal();
            loadTrips();
          })
          .catch(err => {
            console.error("Błąd aktualizacji:", err);
            showMessage("❌ Nie udało się zaktualizować wyprawy.");
          });
      } else {
        const newTripRef = push(ref(db, 'trips'));
        set(newTripRef, tripData)
          .then(() => {
            showMessage("✅ Wyprawa dodana!");
            closeTripModal();
            loadTrips();
          })
          .catch(err => {
            console.error("Błąd dodawania:", err);
            showMessage("❌ Nie udało się dodać wyprawy.");
          });
      }
    });

    window.editTrip = function(id) {
      onValue(ref(db, `trips/${id}`), (snapshot) => {
        const trip = snapshot.val();
        if (trip) {
          document.getElementById("tripId").value = id;
          document.getElementById("tripName").value = trip.name;
          document.getElementById("tripCategory").value = trip.category;
          document.getElementById("tripDateFrom").value = trip.dateFrom;
          document.getElementById("tripDateTo").value = trip.dateTo;
          document.getElementById("tripMainPhotoUrl").value = trip.mainPhotoUrl;
          document.getElementById("tripDescription").value = trip.description;
          tripModal.style.display = "flex";
        }
      }, { onlyOnce: true });
    };

    window.deleteTrip = function(id) {
      if (confirm("Czy na pewno chcesz usunąć tę wyprawę?")) {
        remove(ref(db, `trips/${id}`))
          .then(() => {
            showMessage("✅ Usunięto!");
            loadTrips();
          })
          .catch(err => {
            console.error("Błąd usuwania:", err);
            showMessage("❌ Nie udało się usunąć wyprawy.");
          });
      }
    };

    window.closeTripModal = function() { document.getElementById("tripModal").style.display = "none"; };
    window.closeAuthModal = function() { document.getElementById("authModal").style.display = "none"; };
    window.showMessage = function(text) {
      document.getElementById("msgText").textContent = text;
      document.getElementById("msgModal").style.display = "flex";
    };
    window.closeMsgModal = function() { document.getElementById("msgModal").style.display = "none"; };
  </script>
</body>
</html>