<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dziennik podr√≥≈ºy</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>

  <!-- Tytu≈Ç w lewym g√≥rnym rogu -->
  <div class="header-title">
    Nasze podr√≥≈ºe
  </div>

  <!-- Przycisk menu ‚ò∞ w prawym g√≥rnym rogu -->
  <button id="menuToggle" class="menu-toggle">‚ò∞</button>

  <!-- WyskakujƒÖce menu (z prawej) -->
  <nav id="sideMenu" class="side-menu">
    <div class="menu-header">
      <h3>Menu</h3>
      <button id="closeMenu" class="close-btn">√ó</button>
    </div>
    <ul class="menu-list">
      <li><a href="index.html">üè† Strona g≈Ç√≥wna</a></li>

      <li class="menu-item has-submenu">
        <span>üåç Odwiedzone kraje</span>
        <ul id="countryList" class="submenu">
          <!-- Kraje zostanƒÖ za≈Çadowane dynamicznie -->
          <li><em>≈Åadowanie...</em></li>
        </ul>
      </li>

      <li class="menu-item has-submenu">
        <span>üè∑Ô∏è Kategorie</span>
        <ul id="categoryList" class="submenu">
          <!-- Kategorie zostanƒÖ za≈Çadowane dynamicznie -->
          <li><em>≈Åadowanie...</em></li>
        </ul>
      </li>

      <li>
        <input type="text" id="searchInput" placeholder="üîç Wyszukaj miejsce..." class="menu-search">
      </li>

      <li class="menu-item has-submenu">
        <span>üîΩ Sortuj wed≈Çug</span>
        <ul class="submenu">
          <li><a href="#" data-sort="date">Daty</a></li>
          <li><a href="#" data-sort="name">Nazwy</a></li>
          <li><a href="#" data-sort="country">Kraju</a></li>
        </ul>
      </li>

      <li><a href="#" id="statsLink">üìä Statystyki</a></li>
    </ul>
  </nav>

  <!-- Modal komunikat√≥w (bez zmian) -->
  <div id="authModal" class="modal" style="display: none;">
    <div class="modal-content">
      <h2>üîê Dostƒôp do edycji</h2>
      <p>Wprowad≈∫ has≈Ço administratora, aby edytowaƒá.</p>
      <input type="password" id="adminPassword" placeholder="Has≈Ço">
      <button onclick="checkPassword()">Wejd≈∫</button>
      <button onclick="closeAuthModal()" style="margin-top: 10px;">Anuluj</button>
    </div>
  </div>

  <!-- Przycisk trybu edycji (przesuniƒôty, by nie kolidowaƒá z menu) -->
  <button id="editModeBtn" class="edit-btn right-top">üîß Tryb edycji</button>

  <!-- Mapa -->
  <div id="map"></div>

  <!-- Modal formularza wyprawy (bez zmian) -->
  <div id="tripModal" class="modal" style="display: none;">
    <div class="modal-content scrollable-modal">
      <h2 id="tripModalTitle">Dodaj wyprawƒô</h2>
      <form id="tripForm">
        <input type="hidden" id="tripId">
        <input type="hidden" id="tripLat">
        <input type="hidden" id="tripLng">
        <input type="hidden" id="originalTripId">

        <label>Nazwa: <input type="text" id="tripName" required></label><br><br>
        <label>Opis: <textarea id="tripDescription" rows="2"></textarea></label><br><br>
        <label>Zdjƒôcie (URL): <input type="url" id="tripImage" required></label><br><br>
        <label>Data od: <input type="date" id="tripDateFrom" required></label><br><br>
        <label>Data do: <input type="date" id="tripDateTo"></label><br><br>

        <button type="submit" id="saveTripBtn">Zapisz</button>
        <button type="button" onclick="closeTripModal()">Anuluj</button>
      </form>
    </div>
  </div>

  <!-- Modal komunikat√≥w -->
  <div id="msgModal" class="msg-modal" style="display: none;">
    <div class="msg-modal-content">
      <p id="msgText"></p>
      <button onclick="closeMsgModal()">OK</button>
    </div>
  </div>

  <!-- Leaflet i skrypty -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const firebaseBaseUrl = "https://moj-dziennik-podrozy-default-rtdb.europe-west1.firebasedatabase.app";
    const correctPassword = "sekret2025";
    let isAddingTrip = false;
    let isEditing = sessionStorage.getItem("isEditing") === "true";

    // --- Mapa ---
    const map = L.map("map").setView([54.5, -3.0], 6);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

    // --- Menu wyskakujƒÖce ---
    const menuToggle = document.getElementById("menuToggle");
    const sideMenu = document.getElementById("sideMenu");
    const closeMenu = document.getElementById("closeMenu");

    menuToggle.addEventListener("click", () => {
      sideMenu.style.transform = "translateX(0)";
    });

    closeMenu.addEventListener("click", () => {
      sideMenu.style.transform = "translateX(100%)";
    });

    // Zamknij menu po klikniƒôciu poza nim
    sideMenu.addEventListener("click", (e) => {
      if (e.target === sideMenu) {
        sideMenu.style.transform = "translateX(100%)";
      }
    });

    // --- ≈Åadowanie kraj√≥w i kategorii ---
    const countryList = document.getElementById("countryList");
    const categoryList = document.getElementById("categoryList");

    function loadCountriesAndCategories() {
      fetch(`${firebaseBaseUrl}/trips.json`)
        .then(res => res.json())
        .then(trips => {
          const countries = new Set();
          const categories = new Set();

          if (!trips) return;

          Object.values(trips).forEach(trip => {
            if (trip.places) {
              Object.values(trip.places).forEach(place => {
                if (place.country) countries.add(place.country);
                if (place.category) categories.add(place.category);
              });
            }
          });

          // Wype≈Çnij listƒô kraj√≥w
          countryList.innerHTML = "";
          Array.from(countries).sort().forEach(country => {
            const li = document.createElement("li");
            li.innerHTML = `<a href="list.html?type=country&value=${encodeURIComponent(country)}">${country}</a>`;
            countryList.appendChild(li);
          });

          // Wype≈Çnij listƒô kategorii
          categoryList.innerHTML = "";
          Array.from(categories).sort().forEach(cat => {
            const label = getCategoryLabel(cat);
            const li = document.createElement("li");
            li.innerHTML = `<a href="list.html?type=category&value=${encodeURIComponent(cat)}">${label}</a>`;
            categoryList.appendChild(li);
          });
        })
        .catch(err => console.error("B≈ÇƒÖd ≈Çadowania kraj√≥w/kategorii:", err));
    }

    // Funkcja z `place.html` ‚Äì kopia dla sp√≥jno≈õci
    function getCategoryLabel(category) {
      const labels = {
        miasto: "üèôÔ∏è Miasto",
        park: "üå≥ Park",
        zabytek: "üèõÔ∏è Zabytek",
        muzeum: "üñºÔ∏è Muzeum",
        hotel: "üè® Hotel",
        szczyt: "‚õ∞Ô∏è Szczyt",
        restauracja: "üçΩÔ∏è Restauracja",
        miejsce_widokowe: "üåÑ Miejsce widokowe",
        atrakcja_turystyczna: "üéØ Atrakcja turystyczna",
        inny: "üîß Inny"
      };
      return labels[category] || category;
    }

    // --- Tryb edycji (bez zmian) ---
    function checkPassword() {
      const password = document.getElementById("adminPassword").value;
      if (password === correctPassword) {
        sessionStorage.setItem("isEditing", "true");
        isEditing = true;
        closeAuthModal();
        updateUIForEditMode();
        loadTrips();
      } else {
        showMessage("‚ùå B≈Çƒôdne has≈Ço!");
      }
    }

    function updateUIForEditMode() {
      const editBtn = document.getElementById("editModeBtn");
      editBtn.textContent = isEditing ? "Wyjd≈∫ z edycji" : "üîß Tryb edycji";
    }

    document.getElementById("editModeBtn").addEventListener("click", function() {
      if (isEditing) {
        sessionStorage.removeItem("isEditing");
        isEditing = false;
        updateUIForEditMode();
        loadTrips();
      } else {
        document.getElementById("authModal").style.display = "flex";
      }
    });

    // --- Obs≈Çuga dodawania wyprawy ---
    document.getElementById("editModeBtn").addEventListener("click", function() {
      if (isEditing) {
        document.getElementById("addTripBtn").style.display = "block";
      } else {
        document.getElementById("addTripBtn").style.display = "none";
      }
    });

    // --- ≈Åadowanie wypraw ---
    function loadTrips() {
      fetch(tripsUrl)
        .then(res => res.json())
        .then(trips => {
          map.eachLayer(layer => { if (layer instanceof L.Marker) map.removeLayer(layer); });
          if (!trips) return;
          Object.keys(trips).forEach(key => {
            const trip = trips[key];
            if (!trip.lat || !trip.lng) return;
            const marker = L.marker([trip.lat, trip.lng]).addTo(map);
            let popupContent = isEditing
              ? `<strong><a href="trip.html?id=${key}&from=edit">${trip.name}</a></strong><br>...`
              : `<strong><a href="trip.html?id=${key}">${trip.name}</a></strong><br>...`;
            marker.bindPopup(popupContent);
          });
        })
        .catch(err => console.error("B≈ÇƒÖd ≈Çadowania wypraw:", err));
    }

    const tripsUrl = `${firebaseBaseUrl}/trips.json`;
    loadTrips();
    loadCountriesAndCategories();
    updateUIForEditMode();

    // --- Funkcje pomocnicze ---
    window.closeAuthModal = function() { document.getElementById("authModal").style.display = "none"; };
    window.closeTripModal = function() { document.getElementById("tripModal").style.display = "none"; };
    window.showMessage = function(text) {
      document.getElementById("msgText").textContent = text;
      document.getElementById("msgModal").style.display = "flex";
    };
    window.closeMsgModal = function() { document.getElementById("msgModal").style.display = "none"; };

    document.addEventListener("keydown", e => {
      if (e.key === "Escape") {
        closeAuthModal();
        closeTripModal();
        closeMsgModal();
        sideMenu.style.transform = "translateX(100%)";
      }
    });
  </script>
</body>
</html>