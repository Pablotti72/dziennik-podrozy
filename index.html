<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dziennik podr√≥≈ºy</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" />
</head>
<body>
  <!-- Modal do autoryzacji -->
  <div id="authModal" class="modal" style="display: none;">
    <div class="modal-content">
      <h2>üîê Dostƒôp do edycji</h2>
      <p>Wprowad≈∫ has≈Ço administratora, aby edytowaƒá.</p>
      <input type="password" id="adminPassword" placeholder="Has≈Ço">
      <button onclick="checkPassword()">Wejd≈∫</button>
      <button onclick="closeAuthModal()" style="margin-top: 10px;">Anuluj</button>
    </div>
  </div>

  <!-- G≈Ç√≥wny nag≈Ç√≥wek z przyciskami -->
  <div class="header-container right-top">
    <div class="header-box">Nasze podr√≥≈ºe</div>
    <button id="addTripBtn" class="add-btn" style="display: none;">‚ûï Dodaj wyprawƒô</button>
    <button id="editModeBtn" class="edit-btn">üîß Tryb edycji</button>
    <button id="menuBtn" class="menu-btn">‚ò∞ Menu</button>
  </div>

  <!-- Boczne menu (domy≈õlnie ukryte) -->
  <div id="sideMenu" class="side-menu">
    <button id="closeMenuBtn" class="close-btn">&times;</button>
    <a href="#" onclick="showMessage('Przejd≈∫ do Strony g≈Ç√≥wnej')">Strona g≈Ç√≥wna</a>
    <a href="#" onclick="showMessage('Przejd≈∫ do Odwiedzonych kraj√≥w')">Odwiedzone kraje</a>
    <a href="#" onclick="showMessage('Przejd≈∫ do Kategorii')">Kategorie</a>
    <a href="#" onclick="showMessage('Otw√≥rz Wyszukiwarkƒô')">Wyszukiwarka</a>
    <a href="#" onclick="showMessage('Opcje sortowania')">Opcje sortowania</a>
    <a href="#" onclick="showMessage('Poka≈º Statystyki')">Statystyki</a>
  </div>

  <div id="map"></div>

  <!-- Modal do dodawania/edycji wyprawy -->
  <div id="tripModal" class="modal" style="display: none;">
    <div class="modal-content scrollable-modal">
      <h2 id="tripModalTitle">Dodaj wyprawƒô</h2>
      <form id="tripForm">
        <input type="hidden" id="tripId">
        <label>Nazwa: <input type="text" id="tripName" required></label>
        <label>Data: <input type="date" id="tripDate" required></label>
        <label>Opis: <textarea id="tripDescription" rows="4"></textarea></label>
        <label>Zdjƒôcie URL: <input type="url" id="tripImageUrl" placeholder="https://..."></label>
        <label>Zasiƒôg mapy (wsp√≥≈Çrzƒôdne):</label>
        <div class="map-bounds">
          <label>Min Lat: <input type="number" step="0.000001" id="tripLatMin"></label>
          <label>Min Lng: <input type="number" step="0.000001" id="tripLngMin"></label>
          <label>Max Lat: <input type="number" step="0.000001" id="tripLatMax"></label>
          <label>Max Lng: <input type="number" step="0.000001" id="tripLngMax"></label>
        </div>
        <button type="submit">Zapisz</button>
        <button type="button" onclick="closeTripModal()">Anuluj</button>
      </form>
    </div>
  </div>

  <!-- Modal do wy≈õwietlania wiadomo≈õci -->
  <div id="msgModal" class="msg-modal" style="display: none;">
    <div class="msg-modal-content">
      <p id="msgText"></p>
      <button onclick="closeMsgModal()">OK</button>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, deleteDoc, onSnapshot, collection, query, where, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Globalne zmienne dostarczone przez ≈õrodowisko Canvas (NIE EDYTOWAƒÜ)
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // Inicjalizacja Firebase i Firestore
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    let userId = null;

    // Funkcja autoryzacji
    async function authenticate() {
      if (initialAuthToken) {
        await signInWithCustomToken(auth, initialAuthToken);
      } else {
        await signInAnonymously(auth);
      }
    }

    // Obs≈Çuga uwierzytelnienia
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        userId = user.uid;
        document.body.dataset.userId = userId;
        console.log("Authenticated with user ID:", userId);

        // Subskrypcja kolekcji "wyprawy" po uwierzytelnieniu
        try {
          const tripsRef = collection(db, `artifacts/${appId}/public/data/wyprawy`);
          onSnapshot(tripsRef, (querySnapshot) => {
            const trips = [];
            querySnapshot.forEach((doc) => {
              const data = doc.data();
              trips.push({ id: doc.id, ...data });
            });
            renderTrips(trips);
          }, (error) => {
            console.error("Error listening to trips:", error);
            showMessage("WystƒÖpi≈Ç b≈ÇƒÖd podczas ≈Çadowania wypraw.");
          });
        } catch (err) {
          console.error("Error setting up Firestore listener:", err);
          showMessage("Nie uda≈Ço siƒô nawiƒÖzaƒá po≈ÇƒÖczenia z bazƒÖ danych.");
        }
      } else {
        userId = null;
        console.log("User is signed out.");
        // Opcjonalnie: Przekierowanie lub reset stanu
      }
    });

    // Uwierzytelnienie przy ≈Çadowaniu strony
    authenticate();

    // Sta≈Çe i zmienne
    const PASSWORD = "admin";
    let isEditMode = false;
    let map = null;
    let markers = [];
    let trips = [];

    // --- Funkcje g≈Ç√≥wne ---

    function initMap() {
      if (map) map.remove();
      map = L.map('map', { zoomControl: false }).setView([52.2297, 21.0122], 6); // Domy≈õlna lokalizacja: Warszawa
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);

      // Funkcja do rysowania granic i marker√≥w na mapie
      function drawTripBoundaries(trip) {
        if (trip.latMin && trip.lngMin && trip.latMax && trip.lngMax) {
          const bounds = L.latLngBounds(
            [trip.latMin, trip.lngMin],
            [trip.latMax, trip.lngMax]
          );
          L.rectangle(bounds, { color: "#ff7800", weight: 3, interactive: false }).addTo(map);
        }
      }

      // Funkcja do pobierania i wy≈õwietlania miejsc dla danej wyprawy
      async function fetchAndRenderPlaces(tripId) {
        const placesRef = collection(db, `artifacts/${appId}/public/data/wyprawy/${tripId}/miejsca`);
        const q = query(placesRef);
        const placesSnapshot = await getDocs(q);
        const placeData = placesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        placeData.forEach(place => {
          if (place.latitude && place.longitude) {
            const marker = L.marker([place.latitude, place.longitude]).addTo(map);
            markers.push(marker);
            marker.on('click', () => showPlaceDetails(place, tripId));
          }
        });
      }

      // Renderowanie wypraw
      function renderTrips(fetchedTrips) {
        trips = fetchedTrips;
        markers.forEach(marker => map.removeLayer(marker));
        markers = [];
        map.eachLayer(layer => {
          if (layer instanceof L.Rectangle) {
            map.removeLayer(layer);
          }
        });

        trips.forEach(trip => {
          if (trip.latMin) {
            drawTripBoundaries(trip);
            fetchAndRenderPlaces(trip.id);
          }
        });
      }
    }

    function toggleEditMode() {
      isEditMode = !isEditMode;
      const btn = document.getElementById("editModeBtn");
      const addBtn = document.getElementById("addTripBtn");
      btn.textContent = isEditMode ? "üíæ Tryb przeglƒÖdania" : "üîß Tryb edycji";
      addBtn.style.display = isEditMode ? "inline-block" : "none";
      showMessage(`W≈ÇƒÖczono tryb edycji: ${isEditMode ? "TAK" : "NIE"}`);
    }

    function showTripModal(trip = null) {
      if (!isEditMode) return;
      const modal = document.getElementById("tripModal");
      const form = document.getElementById("tripForm");
      const title = document.getElementById("tripModalTitle");

      form.reset();
      document.getElementById("tripId").value = "";

      if (trip) {
        title.textContent = "Edytuj wyprawƒô";
        document.getElementById("tripId").value = trip.id;
        document.getElementById("tripName").value = trip.name || "";
        document.getElementById("tripDate").value = trip.date || "";
        document.getElementById("tripDescription").value = trip.description || "";
        document.getElementById("tripImageUrl").value = trip.imageUrl || "";
        document.getElementById("tripLatMin").value = trip.latMin || "";
        document.getElementById("tripLngMin").value = trip.lngMin || "";
        document.getElementById("tripLatMax").value = trip.latMax || "";
        document.getElementById("tripLngMax").value = trip.lngLng || "";
      } else {
        title.textContent = "Dodaj wyprawƒô";
      }

      modal.style.display = "flex";
    }

    // --- Zdarzenia i obs≈Çuga formularzy ---
    document.getElementById("editModeBtn").addEventListener("click", () => {
      const authModal = document.getElementById("authModal");
      if (!isEditMode) {
        authModal.style.display = "flex";
      } else {
        toggleEditMode();
      }
    });

    document.getElementById("addTripBtn").addEventListener("click", () => {
      showTripModal();
    });

    document.getElementById("tripForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const tripId = document.getElementById("tripId").value;
      const name = document.getElementById("tripName").value;
      const date = document.getElementById("tripDate").value;
      const description = document.getElementById("tripDescription").value;
      const imageUrl = document.getElementById("tripImageUrl").value;
      const latMin = parseFloat(document.getElementById("tripLatMin").value) || null;
      const lngMin = parseFloat(document.getElementById("tripLngMin").value) || null;
      const latMax = parseFloat(document.getElementById("tripLatMax").value) || null;
      const lngMax = parseFloat(document.getElementById("tripLngMax").value) || null;

      const tripData = { name, date, description, imageUrl, latMin, lngMin, latMax, lngMax, userId };
      const tripRef = doc(db, `artifacts/${appId}/public/data/wyprawy`, tripId || generateId(name));

      try {
        await setDoc(tripRef, tripData, { merge: true });
        closeTripModal();
        showMessage("Wyprawa zapisana pomy≈õlnie!");
      } catch (e) {
        console.error("Error saving document: ", e);
        showMessage("Nie uda≈Ço siƒô zapisaƒá wyprawy.");
      }
    });

    window.checkPassword = function() {
      const password = document.getElementById("adminPassword").value;
      if (password === PASSWORD) {
        closeAuthModal();
        toggleEditMode();
      } else {
        showMessage("Nieprawid≈Çowe has≈Ço.");
      }
    };

    window.deleteTrip = async function(id) {
      if (confirm("Czy na pewno chcesz usunƒÖƒá tƒô wyprawƒô?")) {
        try {
          await deleteDoc(doc(db, `artifacts/${appId}/public/data/wyprawy`, id));
          showMessage("Wyprawa usuniƒôta pomy≈õlnie.");
        } catch (err) {
          console.error("B≈ÇƒÖd usuwania:", err);
          showMessage("Nie uda≈Ço siƒô usunƒÖƒá wyprawy.");
        }
      }
    };

    function generateId(name) {
      return name
        .toLowerCase()
        .trim()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/[^a-z0-9]/g, "_")
        .replace(/_+/g, "_")
        .replace(/^_+|_+$/g, "");
    }

    function formatDate(dateStr) {
      return dateStr ? new Date(dateStr).toLocaleDateString("pl-PL", { day: "numeric", month: "long", year: "numeric" }) : "Brak daty";
    }

    // --- Obs≈Çuga UI i modal√≥w ---
    window.closeTripModal = function() { document.getElementById("tripModal").style.display = "none"; };
    window.closeAuthModal = function() { document.getElementById("authModal").style.display = "none"; };
    window.showMessage = function(text) {
      document.getElementById("msgText").textContent = text;
      document.getElementById("msgModal").style.display = "flex";
    };
    window.closeMsgModal = function() { document.getElementById("msgModal").style.display = "none"; };

    // Obs≈Çuga bocznego menu
    document.getElementById("menuBtn").addEventListener("click", () => {
      document.getElementById("sideMenu").style.width = "250px";
    });

    document.getElementById("closeMenuBtn").addEventListener("click", () => {
      document.getElementById("sideMenu").style.width = "0";
    });

    document.addEventListener("keydown", function(e) {
      if (e.key === "Escape") {
        closeTripModal();
        closeAuthModal();
        closeMsgModal();
        document.getElementById("sideMenu").style.width = "0";
      }
    });

    initMap();
  </script>
</body>
</html>
```css
/* --- OG√ìLNE --- */
body {
  margin: 0;
  padding: 0;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background-color: #f5f5f5;
  color: #333;
}

/* --- KONTENER NAG≈Å√ìWKA --- */
.header-container {
  position: absolute;
  top: 10px;
  right: 10px;
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 6px;
  z-index: 1000;
  background: white;
  padding: 12px 16px;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  max-width: 280px;
  box-sizing: border-box;
}

.header-box {
  font-size: 18px;
  font-weight: bold;
  color: #2c3e50;
  text-align: right;
}

/* --- PRZYCISKI --- */
.add-btn {
  background: #4CAF50;
  color: white;
  border: none;
  padding: 8px 12px;
  font-size: 14px;
  border-radius: 8px;
  cursor: pointer;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  transition: transform 0.2s, box-shadow 0.2s;
}

.add-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

.edit-btn {
  background: #3498db;
  color: white;
  border: none;
  padding: 8px 12px;
  font-size: 14px;
  border-radius: 8px;
  cursor: pointer;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  transition: transform 0.2s, box-shadow 0.2s;
}

.edit-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

/* Nowy przycisk menu */
.menu-btn {
  background: #5c6770;
  color: white;
  border: none;
  padding: 8px 12px;
  font-size: 14px;
  border-radius: 8px;
  cursor: pointer;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  transition: transform 0.2s, box-shadow 0.2s;
}

.menu-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

/* --- MAPA --- */
#map {
  width: 100%;
  height: 100vh;
  position: absolute;
  top: 0;
  left: 0;
  z-index: 1;
}

/* --- MODALE --- */
.modal {
  display: none;
  position: fixed;
  z-index: 2000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.6);
  justify-content: center;
  align-items: center;
  overflow-y: auto;
}

.modal-content {
  background-color: white;
  padding: 25px;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
  max-width: 500px;
  width: 90%;
  text-align: center;
  animation: fadeIn 0.3s;
}

.scrollable-modal {
  max-height: 80vh;
  overflow-y: auto;
}

.modal-content h2 {
  color: #2c3e50;
  margin-top: 0;
  border-bottom: 2px solid #4CAF50;
  padding-bottom: 10px;
  margin-bottom: 20px;
}

.modal-content label,
.modal-content input,
.modal-content textarea {
  display: block;
  width: 100%;
  margin-bottom: 15px;
}

.modal-content input[type="text"],
.modal-content input[type="date"],
.modal-content input[type="url"],
.modal-content textarea {
  padding: 10px;
  border-radius: 8px;
  border: 1px solid #ddd;
  box-sizing: border-box;
}

.modal-content button {
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 16px;
  transition: background-color 0.2s;
}

.modal-content button[type="submit"] {
  background-color: #4CAF50;
  color: white;
  margin-right: 10px;
}

.modal-content button[type="button"] {
  background-color: #f44336;
  color: white;
}

.modal-content button[type="submit"]:hover {
  background-color: #45a049;
}

.modal-content button[type="button"]:hover {
  background-color: #e53935;
}

.map-bounds {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
  margin-bottom: 15px;
}

.map-bounds label {
  text-align: left;
}

.msg-modal {
  display: none;
  position: fixed;
  z-index: 3000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.6);
  justify-content: center;
  align-items: center;
}

.msg-modal-content {
  background-color: white;
  padding: 25px;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
  text-align: center;
  max-width: 300px;
}

.msg-modal-content p {
  margin: 0 0 20px;
}

.msg-modal-content button {
  padding: 8px 16px;
  background-color: #3498db;
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
}

/* --- UK≈ÅAD WYPRAW --- */
.trip-card-container {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 20px;
  padding: 20px;
}

.trip-card {
  background: white;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
  transition: transform 0.3s, box-shadow 0.3s;
  cursor: pointer;
  display: flex;
  flex-direction: column;
}

.trip-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
}

.trip-card-image {
  width: 100%;
  height: 200px;
  object-fit: cover;
  display: block;
}

.trip-card-content {
  padding: 15px;
  display: flex;
  flex-direction: column;
  flex-grow: 1;
}

.trip-card h3 {
  color: #2c3e50;
  margin: 0;
  font-size: 1.5em;
  border-bottom: 2px solid #4CAF50;
  padding-bottom: 5px;
  margin-bottom: 10px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.trip-card p {
  margin: 0;
  color: #555;
  line-height: 1.4;
  font-size: 0.9em;
  flex-grow: 1;
  display: -webkit-box;
  -webkit-line-clamp: 3;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.trip-card .trip-date {
  color: #777;
  font-size: 0.8em;
  margin-top: 10px;
}

.trip-actions {
  display: flex;
  gap: 10px;
  margin-top: 15px;
  align-items: center;
}

.trip-actions button {
  padding: 8px 12px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: background-color 0.2s;
  font-size: 0.9em;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.trip-actions .edit-btn-small {
  background-color: #3498db;
  color: white;
}

.trip-actions .delete-btn-small {
  background-color: #e74c3c;
  color: white;
}

.trip-actions .edit-btn-small:hover {
  background-color: #2980b9;
}

.trip-actions .delete-btn-small:hover {
  background-color: #c0392b;
}

/* --- ANULACJA PRZYCISKU TRYBU EDYCJI --- */
.edit-btn.cancel {
  background-color: #e74c3c;
  color: white;
}

.edit-btn.cancel:hover {
  background-color: #c0392b;
}

/* --- ANIMACJE --- */
@keyframes fadeIn {
  from { opacity: 0; transform: scale(0.95); }
  to { opacity: 1; transform: scale(1); }
}

/* --- RESPONSIVE DESIGN --- */
@media (max-width: 768px) {
  .header-container {
    max-width: 95%;
  }

  .trip-card-container {
    padding: 10px;
  }
}

/* --- NOWE STYLE DLA BOCZNEGO MENU --- */
.side-menu {
  height: 100%;
  width: 0; /* Domy≈õlnie ukryte */
  position: fixed;
  z-index: 2001; /* Wy≈ºej ni≈º modale */
  top: 0;
  right: 0;
  background-color: #111;
  overflow-x: hidden;
  transition: 0.5s;
  padding-top: 60px;
  box-shadow: -4px 0 15px rgba(0, 0, 0, 0.2);
}

.side-menu a {
  padding: 15px 8px 15px 32px;
  text-decoration: none;
  font-size: 20px;
  color: #818181;
  display: block;
  transition: 0.3s;
}

.side-menu a:hover {
  color: #f1f1f1;
  background-color: #333;
}

.side-menu .close-btn {
  position: absolute;
  top: 0;
  right: 25px;
  font-size: 36px;
  margin-left: 50px;
  border: none;
  background: none;
  color: #818181;
  cursor: pointer;
}

.side-menu .close-btn:hover {
  color: #f1f1f1;
}

