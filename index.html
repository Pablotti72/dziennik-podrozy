<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dziennik podr√≥≈ºy</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
  <!-- Modal autoryzacji -->
  <div id="authModal" class="modal" style="display: none;">
    <div class="modal-content">
      <h2>üîê Dostƒôp do edycji</h2>
      <p>Wprowad≈∫ has≈Ço administratora, aby edytowaƒá.</p>
      <input type="password" id="adminPassword" placeholder="Has≈Ço">
      <button onclick="checkPassword()">Wejd≈∫</button>
      <button onclick="closeAuthModal()" style="margin-top: 10px;">Anuluj</button>
    </div>
  </div>

  <!-- Kontener nag≈Ç√≥wka -->
  <div class="header-container right-top">
    <div class="header-box">Nasze podr√≥≈ºe</div>
    <button id="addTripBtn" class="add-btn" style="display: none;">‚ûï Dodaj wyprawƒô</button>
    <button id="editModeBtn" class="edit-btn">üîß Tryb edycji</button>
  </div>

  <!-- Mapa -->
  <div id="map"></div>

  <!-- Modal do dodawania/edycji wyprawy -->
  <div id="tripModal" class="modal" style="display: none;">
    <div class="modal-content">
      <h2 id="tripModalTitle">Dodaj wyprawƒô</h2>
      <form id="tripForm">
        <input type="hidden" id="tripId">
        <label>Nazwa: <input type="text" id="tripName" required></label><br><br>
        <label>Data rozpoczƒôcia: <input type="date" id="tripStartDate"></label><br><br>
        <label>Data zako≈Ñczenia: <input type="date" id="tripEndDate"></label><br><br>
        <label>Opis: <textarea id="tripDescription" rows="4" placeholder="Kr√≥tki opis wyprawy"></textarea></label><br><br>
        <label>Zdjƒôcie nag≈Ç√≥wka URL: <input type="url" id="tripImageUrl" placeholder="https://..."></label><br><br>
        <div id="tripActions">
          <button type="submit">Zapisz</button>
          <button type="button" onclick="window.closeTripModal()">Anuluj</button>
          <button type="button" id="deleteTripBtn" class="delete-btn" style="display: none;">Usu≈Ñ</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal do wy≈õwietlania wiadomo≈õci -->
  <div id="msgModal" class="msg-modal" style="display: none;">
    <div class="msg-modal-content">
      <p id="msgText"></p>
      <button onclick="closeMsgModal()">OK</button>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script type="module">
    // --- Imports from Firebase ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, doc, getDoc, addDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    // --- Global variables provided by the environment ---
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const authToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // --- Firebase Initialization ---
    let app, db, auth, userId;
    let isEditMode = false;
    let map, tripsLayer;

    // Initialize Firebase and set up authentication
    async function initializeFirebase() {
        if (Object.keys(firebaseConfig).length === 0) {
            console.error("Firebase config is missing. Data persistence will not work.");
            return;
        }
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            if (authToken) {
                await signInWithCustomToken(auth, authToken);
            } else {
                await signInAnonymously(auth);
            }
            userId = auth.currentUser.uid;
            console.log("Firebase initialized successfully. User ID:", userId);
            
            // Start listening for trip data
            await setupTripListener();

        } catch (error) {
            console.error("Firebase initialization failed:", error);
            showMessage("Nie uda≈Ço siƒô po≈ÇƒÖczyƒá z bazƒÖ danych.");
        }
    }

    // Initialize Leaflet map
    function initializeMap() {
      map = L.map('map').setView([52.0, 19.0], 6);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);
      tripsLayer = L.layerGroup().addTo(map);
    }

    // Setup listener for real-time trip data
    async function setupTripListener() {
      if (!db || !userId) return;

      const tripsCollectionRef = collection(db, `artifacts/${appId}/public/data/trips`);
      onSnapshot(tripsCollectionRef, (snapshot) => {
        const trips = [];
        snapshot.forEach(doc => {
          trips.push({ id: doc.id, ...doc.data() });
        });
        updateTripsOnMap(trips);
      }, (error) => {
        console.error("B≈ÇƒÖd ≈Çadowania wypraw:", error);
        showMessage("Nie uda≈Ço siƒô za≈Çadowaƒá listy wypraw.");
      });
    }

    // Update map with trip markers
    function updateTripsOnMap(trips) {
      tripsLayer.clearLayers();
      trips.forEach(trip => {
        const marker = L.marker([trip.latitude, trip.longitude]).addTo(tripsLayer);
        const popupContent = `
          <b>${trip.name}</b><br>
          ${trip.startDate ? formatDate(trip.startDate) : ''} - ${trip.endDate ? formatDate(trip.endDate) : ''}<br>
          ${trip.description || ''}<br><br>
          <a href="trip.html?id=${trip.id}">Szczeg√≥≈Çy wyprawy</a>
        `;
        marker.bindPopup(popupContent);

        if (isEditMode) {
          const editBtn = document.createElement('button');
          editBtn.textContent = 'Edytuj';
          editBtn.classList.add('action-btn');
          editBtn.onclick = () => window.editTrip(trip);
          
          const deleteBtn = document.createElement('button');
          deleteBtn.textContent = 'Usu≈Ñ';
          deleteBtn.classList.add('action-btn', 'delete-btn');
          deleteBtn.onclick = () => window.deleteTrip(trip.id);
          
          const popupDiv = document.createElement('div');
          popupDiv.innerHTML = popupContent;
          popupDiv.appendChild(editBtn);
          popupDiv.appendChild(deleteBtn);
          
          marker.setPopupContent(popupDiv);
        }
      });
    }

    // --- Funkcje UI i obs≈Çugi danych ---
    window.checkPassword = function() {
      const password = document.getElementById("adminPassword").value;
      if (password === 'admin123') { // Proste has≈Ço dla test√≥w
        isEditMode = true;
        showMessage('Tryb edycji w≈ÇƒÖczony.');
        document.getElementById('editModeBtn').textContent = 'Tryb podglƒÖdu';
        document.getElementById('addTripBtn').style.display = 'block';
        document.getElementById('authModal').style.display = 'none';
      } else {
        showMessage('Nieprawid≈Çowe has≈Ço!');
      }
    };

    window.toggleEditMode = function() {
      isEditMode = !isEditMode;
      const editModeBtn = document.getElementById('editModeBtn');
      const addTripBtn = document.getElementById('addTripBtn');

      if (isEditMode) {
        document.getElementById('authModal').style.display = 'flex';
      } else {
        showMessage('Tryb edycji wy≈ÇƒÖczony.');
        editModeBtn.textContent = 'üîß Tryb edycji';
        addTripBtn.style.display = 'none';
        updateTripsOnMap([]); // Rerender to remove edit/delete buttons
        setupTripListener(); // Re-add normal popups
      }
    };

    window.openTripModal = function() {
      document.getElementById('tripModalTitle').textContent = 'Dodaj wyprawƒô';
      document.getElementById('tripForm').reset();
      document.getElementById('tripId').value = '';
      document.getElementById('deleteTripBtn').style.display = 'none';
      document.getElementById('tripModal').style.display = 'flex';
    };

    window.closeTripModal = function() {
      document.getElementById("tripModal").style.display = "none";
    };

    window.editTrip = function(trip) {
      document.getElementById('tripModalTitle').textContent = 'Edytuj wyprawƒô';
      document.getElementById('tripId').value = trip.id;
      document.getElementById('tripName').value = trip.name;
      document.getElementById('tripStartDate').value = trip.startDate || '';
      document.getElementById('tripEndDate').value = trip.endDate || '';
      document.getElementById('tripDescription').value = trip.description || '';
      document.getElementById('tripImageUrl').value = trip.imageUrl || '';
      document.getElementById('deleteTripBtn').style.display = 'block';
      document.getElementById('tripModal').style.display = 'flex';
    };

    window.deleteTrip = async function(tripId) {
      const confirmed = confirm("Czy na pewno chcesz usunƒÖƒá tƒô wyprawƒô? Spowoduje to r√≥wnie≈º usuniƒôcie wszystkich powiƒÖzanych miejsc!");
      if (!confirmed) return;

      try {
        await deleteDoc(doc(db, `artifacts/${appId}/public/data/trips`, tripId));
        showMessage('Wyprawa zosta≈Ça usuniƒôta.');
      } catch (e) {
        console.error("B≈ÇƒÖd podczas usuwania wyprawy:", e);
        showMessage("Nie uda≈Ço siƒô usunƒÖƒá wyprawy.");
      }
      closeTripModal();
    };

    window.closeAuthModal = function() {
      document.getElementById("authModal").style.display = "none";
    };

    window.showMessage = function(text) {
      document.getElementById("msgText").textContent = text;
      document.getElementById("msgModal").style.display = "flex";
    };

    window.closeMsgModal = function() {
      document.getElementById("msgModal").style.display = "none";
    };

    document.getElementById('editModeBtn').addEventListener('click', window.toggleEditMode);
    document.getElementById('addTripBtn').addEventListener('click', window.openTripModal);

    document.getElementById('tripForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const tripId = document.getElementById('tripId').value;
      const tripData = {
        name: document.getElementById('tripName').value,
        startDate: document.getElementById('tripStartDate').value,
        endDate: document.getElementById('tripEndDate').value,
        description: document.getElementById('tripDescription').value,
        imageUrl: document.getElementById('tripImageUrl').value,
        // Domy≈õlne wsp√≥≈Çrzƒôdne, je≈õli nie ma markera
        latitude: map.getCenter().lat,
        longitude: map.getCenter().lng,
        creatorId: userId
      };

      try {
        if (tripId) {
          // Update existing trip
          await updateDoc(doc(db, `artifacts/${appId}/public/data/trips`, tripId), tripData);
          showMessage('Wyprawa zosta≈Ça zaktualizowana!');
        } else {
          // Add new trip
          await addDoc(collection(db, `artifacts/${appId}/public/data/trips`), tripData);
          showMessage('Nowa wyprawa zosta≈Ça dodana!');
        }
      } catch (e) {
        console.error("B≈ÇƒÖd zapisu danych:", e);
        showMessage("Nie uda≈Ço siƒô zapisaƒá wyprawy.");
      }
      closeTripModal();
    });

    function formatDate(dateStr) {
      return dateStr ? new Date(dateStr).toLocaleDateString("pl-PL", { day: "numeric", month: "long", year: "numeric" }) : "Brak daty";
    }

    // Obs≈Çuga klawisza ESC
    document.addEventListener("keydown", function(e) {
      if (e.key === "Escape") {
        closeTripModal();
        closeAuthModal();
        closeMsgModal();
      }
    });

    // Uruchomienie aplikacji
    document.addEventListener("DOMContentLoaded", () => {
        initializeMap();
        initializeFirebase();
    });
  </script>
</body>
</html>
