<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dziennik podr√≥≈ºy</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- Tailwind CSS CDN - used for development purposes only -->
  <!-- Ostrze≈ºenie: ta wersja Tailwind jest tylko do cel√≥w deweloperskich. -->
  <!-- W wersji produkcyjnej nale≈ºy zainstalowaƒá jƒÖ jako wtyczkƒô PostCSS. -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans antialiased text-gray-800">

  <!-- Main application container with a responsive layout -->
  <div class="flex flex-col md:flex-row h-screen overflow-hidden">

    <!-- Sidebar for the list of trips -->
    <aside id="sidebar" class="w-full md:w-1/3 lg:w-1/4 bg-white shadow-xl p-4 overflow-y-auto transition-all duration-300 ease-in-out z-20 flex-shrink-0">
      <div class="flex items-center justify-between mb-4">
        <h1 class="text-2xl font-bold text-gray-800">Nasze podr√≥≈ºe</h1>
        <button id="editModeBtn" class="bg-blue-500 text-white px-3 py-1 rounded-full text-sm font-semibold hover:bg-blue-600 transition-colors">üîß Tryb edycji</button>
      </div>

      <div class="space-y-4">
        <button id="addTripBtn" class="w-full bg-green-600 text-white py-2 px-4 rounded-lg font-bold hover:bg-green-700 transition-colors hidden">
          ‚ûï Dodaj wyprawƒô
        </button>
        <div id="trip-list" class="space-y-4">
          <!-- The list of trips will be dynamically inserted here -->
          <p class="text-gray-500 text-center mt-8">≈Åadowanie wypraw...</p>
        </div>
      </div>
    </aside>

    <!-- Map container -->
    <main id="map-container" class="flex-1 min-h-[50vh] md:min-h-screen">
      <div id="map" class="h-full w-full"></div>
    </main>
  </div>

  <!-- Authentication Modal -->
  <div id="authModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
    <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm text-center transform transition-all scale-95 md:scale-100">
      <h2 class="text-2xl font-bold mb-4">üîê Dostƒôp do edycji</h2>
      <p class="text-gray-600 mb-4">Wprowad≈∫ has≈Ço administratora, aby edytowaƒá.</p>
      <input type="password" id="adminPassword" placeholder="Has≈Ço" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
      <div class="flex flex-col gap-2">
        <button onclick="checkPassword()" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors">Wejd≈∫</button>
        <button onclick="closeAuthModal()" class="w-full bg-gray-200 text-gray-700 font-bold py-3 px-4 rounded-lg hover:bg-gray-300 transition-colors">Anuluj</button>
      </div>
    </div>
  </div>

  <!-- Trip Form Modal (for adding/editing) -->
  <div id="tripModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
    <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg transform transition-all scale-95 md:scale-100">
      <h2 id="tripModalTitle" class="text-2xl font-bold mb-4 text-gray-800">Dodaj wyprawƒô</h2>
      <form id="tripForm" class="space-y-4">
        <input type="hidden" id="tripId">
        <div>
          <label for="tripName" class="block text-sm font-medium text-gray-700">Nazwa wyprawy:</label>
          <input type="text" id="tripName" required class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <div>
          <label for="tripDescription" class="block text-sm font-medium text-gray-700">Opis:</label>
          <textarea id="tripDescription" rows="4" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="tripStartDate" class="block text-sm font-medium text-gray-700">Data rozpoczƒôcia:</label>
            <input type="date" id="tripStartDate" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label for="tripEndDate" class="block text-sm font-medium text-gray-700">Data zako≈Ñczenia:</label>
            <input type="date" id="tripEndDate" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" onclick="closeTripModal()" class="bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">Anuluj</button>
          <button type="submit" id="saveTripBtn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">Zapisz</button>
        </div>
      </form>
      <button id="deleteTripBtn" class="w-full bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition-colors mt-4 hidden">üóëÔ∏è Usu≈Ñ wyprawƒô</button>
    </div>
  </div>

  <!-- Custom Message/Confirmation Modal -->
  <div id="msgModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
    <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm text-center">
      <p id="msgText" class="text-lg font-semibold mb-4"></p>
      <div class="flex justify-center gap-2">
        <button id="msgConfirmBtn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition-colors hidden">Potwierd≈∫</button>
        <button id="msgOkBtn" onclick="closeMsgModal()" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">OK</button>
      </div>
    </div>
  </div>

  <!-- Scripts for Leaflet and Firebase -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script type="module">
    // Import necessary Firebase services
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, deleteDoc, onSnapshot, collection, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    // --- Global Variables and Initial State ---
    // These variables are loaded from the environment
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    let db;
    let auth;
    let map = null;
    let editMode = false;
    let tripMarkers = {};
    let selectedTripId = null;

    // --- Modal Functions (defined first to be callable anywhere) ---
    /**
     * Shows a custom message modal, replacing the need for `alert()` and `confirm()`.
     * @param {string} text - The message to display.
     * @param {boolean} [isConfirm=false] - If true, shows a confirmation button.
     * @param {function} [onConfirm=null] - The callback function to execute on confirmation.
     */
    function showMessage(text, isConfirm = false, onConfirm = null) {
      document.getElementById("msgText").textContent = text;
      const confirmBtn = document.getElementById("msgConfirmBtn");
      const okBtn = document.getElementById("msgOkBtn");
      
      if (isConfirm) {
        confirmBtn.style.display = 'inline-block';
        okBtn.textContent = 'Anuluj';
        confirmBtn.onclick = () => {
          if (onConfirm) onConfirm();
          closeMsgModal();
        };
      } else {
        confirmBtn.style.display = 'none';
        okBtn.textContent = 'OK';
        okBtn.onclick = closeMsgModal;
      }
      document.getElementById("msgModal").style.display = "flex";
    }

    /** Closes the message modal. */
    function closeMsgModal() {
      document.getElementById("msgModal").style.display = "none";
    }
    
    /** Closes the authentication modal. */
    function closeAuthModal() {
      document.getElementById("authModal").style.display = "none";
    }

    /** Closes the trip form modal. */
    function closeTripModal() {
      document.getElementById("tripModal").style.display = "none";
    }
    
    // --- Firebase Initialization and Authentication ---
    /** Initializes Firebase and handles user authentication. */
    async function initFirebaseAndAuth() {
      try {
        if (!firebaseConfig || !firebaseConfig.projectId) {
          console.error("Firebase configuration not provided. The app will not function correctly.");
          showMessage("B≈ÇƒÖd: Konfiguracja Firebase nie zosta≈Ça dostarczona.");
          return;
        }

        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        // Listen for auth state changes and sign in if not authenticated
        onAuthStateChanged(auth, async (user) => {
          if (user) {
            console.log("U≈ºytkownik uwierzytelniony:", user.uid);
            setupTripListener();
          } else {
            try {
              if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
              } else {
                await signInAnonymously(auth);
              }
            } catch (error) {
              console.error("B≈ÇƒÖd uwierzytelniania:", error);
              showMessage("B≈ÇƒÖd uwierzytelniania. Proszƒô od≈õwie≈ºyƒá stronƒô.");
            }
          }
        });
      } catch (error) {
        console.error("WystƒÖpi≈Ç b≈ÇƒÖd podczas inicjalizacji Firebase:", error);
        showMessage("WystƒÖpi≈Ç nieoczekiwany b≈ÇƒÖd. Proszƒô od≈õwie≈ºyƒá stronƒô.");
      }
    }

    // --- Map Initialization ---
    /** Initializes the Leaflet map. */
    function initMap() {
      if (map === null) {
        map = L.map('map').setView([52.2297, 21.0122], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        map.on('click', (e) => {
          if (editMode) {
            openTripModal(null, e.latlng.lat, e.latlng.lng);
          }
        });
      }
    }

    // --- Data Listener (real-time updates) ---
    /** Sets up a real-time listener for the trips collection. */
    function setupTripListener() {
      if (!db) {
          console.error("Database not initialized.");
          return;
      }
      const tripsRef = collection(db, `artifacts/${appId}/public/data/trips`);
      onSnapshot(tripsRef, (querySnapshot) => {
        const trips = [];
        querySnapshot.forEach(doc => {
          trips.push({ id: doc.id, ...doc.data() });
        });
        renderTrips(trips);
      }, (error) => {
        console.error("B≈ÇƒÖd podczas pobierania wypraw:", error);
        showMessage("Nie uda≈Ço siƒô za≈Çadowaƒá listy wypraw.");
      });
    }

    // --- Rendering Functions ---
    /**
     * Renders trip cards in the sidebar and markers on the map.
     * @param {Array<Object>} trips - An array of trip objects.
     */
    function renderTrips(trips) {
      const tripListDiv = document.getElementById("trip-list");
      if (!tripListDiv) return;

      tripListDiv.innerHTML = '';
      
      // Clear existing markers from the map before re-rendering
      Object.values(tripMarkers).forEach(marker => map.removeLayer(marker));
      tripMarkers = {};

      if (trips.length === 0) {
        tripListDiv.innerHTML = '<p class="text-gray-500 text-center mt-8">Brak zapisanych wypraw.</p>';
        return;
      }
      
      trips.forEach(trip => {
        // Create a card for the sidebar
        const tripCard = document.createElement('div');
        tripCard.id = `trip-card-${trip.id}`;
        tripCard.className = `p-4 bg-gray-50 rounded-lg shadow-md hover:bg-gray-100 transition-colors cursor-pointer ${selectedTripId === trip.id ? 'border-2 border-blue-500' : ''}`;
        tripCard.innerHTML = `
          <h3 class="font-bold text-lg text-gray-800 truncate">${trip.name}</h3>
          <p class="text-sm text-gray-500">${formatDate(trip.startDate)} - ${formatDate(trip.endDate)}</p>
          <p class="mt-2 text-gray-600 line-clamp-2">${trip.description || 'Brak opisu.'}</p>
        `;
        tripCard.addEventListener('click', () => {
          // Center the map view on the trip location when the card is clicked
          const lat = trip.startLocation?.latitude || 52.2297;
          const lng = trip.startLocation?.longitude || 21.0122;
          if (map) {
              map.setView([lat, lng], 10);
          }
          selectTripCard(trip.id);
        });
        tripListDiv.appendChild(tripCard);
        
        // Create a marker for the map
        if (map && trip.startLocation && trip.startLocation.latitude && trip.startLocation.longitude) {
          const marker = L.marker([trip.startLocation.latitude, trip.startLocation.longitude]).addTo(map);
          const popupContent = `<b>${trip.name}</b><br><a href="trip.html?id=${trip.id}">Zobacz szczeg√≥≈Çy</a>`;
          
          if (editMode) {
              const editDeleteButtons = `
                  <div class="mt-2 flex gap-2">
                    <button onclick="openTripModal('${trip.id}')" class="bg-blue-500 text-white px-2 py-1 rounded-md text-xs hover:bg-blue-600 transition-colors">Edytuj</button>
                    <button onclick="confirmDeleteTrip('${trip.id}')" class="bg-red-500 text-white px-2 py-1 rounded-md text-xs hover:bg-red-600 transition-colors">Usu≈Ñ</button>
                  </div>
              `;
              marker.bindPopup(popupContent + editDeleteButtons);
          } else {
              marker.bindPopup(popupContent);
          }
          
          marker.on('click', () => {
            selectTripCard(trip.id);
          });
          
          tripMarkers[trip.id] = marker;
        }
      });
    }

    /**
     * Highlights the selected trip card in the sidebar.
     * @param {string} tripId - The ID of the selected trip.
     */
    function selectTripCard(tripId) {
      if (selectedTripId) {
        document.getElementById(`trip-card-${selectedTripId}`)?.classList.remove('border-2', 'border-blue-500');
      }
      const newSelectedCard = document.getElementById(`trip-card-${tripId}`);
      if (newSelectedCard) {
          newSelectedCard.classList.add('border-2', 'border-blue-500');
          selectedTripId = tripId;
      }
    }

    // --- User Interface Event Handlers ---
    document.getElementById("editModeBtn").addEventListener("click", () => {
      if (!editMode) {
        document.getElementById("authModal").style.display = 'flex';
        document.getElementById("adminPassword").focus();
      } else {
        setEditMode(false);
      }
    });

    /** Checks the admin password to enable edit mode. */
    window.checkPassword = function() {
      const password = document.getElementById("adminPassword").value;
      if (password === 'admin123') { // This is a placeholder for a real-world password check
        setEditMode(true);
        closeAuthModal();
        showMessage("Tryb edycji w≈ÇƒÖczony.");
      } else {
        showMessage("Nieprawid≈Çowe has≈Ço.");
      }
      document.getElementById("adminPassword").value = '';
    };

    /**
     * Toggles the edit mode on and off.
     * @param {boolean} state - True to enable, false to disable.
     */
    function setEditMode(state) {
      editMode = state;
      const editBtn = document.getElementById("editModeBtn");
      const addBtn = document.getElementById("addTripBtn");
      if (editMode) {
        editBtn.textContent = "‚úÖ Tryb widza";
        editBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
        editBtn.classList.add('bg-green-500', 'hover:bg-green-600');
        addBtn.classList.remove('hidden');
      } else {
        editBtn.textContent = "üîß Tryb edycji";
        editBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
        editBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
        addBtn.classList.add('hidden');
      }
      
      // Re-render trips to update the markers with edit/delete buttons
      if (map && db) {
          const tripsRef = collection(db, `artifacts/${appId}/public/data/trips`);
          onSnapshot(tripsRef, (querySnapshot) => {
              const trips = [];
              querySnapshot.forEach(doc => trips.push({ id: doc.id, ...doc.data() }));
              renderTrips(trips);
          });
      }
    }

    document.getElementById("addTripBtn").addEventListener("click", () => {
      openTripModal();
    });

    /**
     * Opens the trip modal for adding a new trip or editing an existing one.
     * @param {string} [tripId=null] - The ID of the trip to edit. If null, a new trip is added.
     * @param {number} [lat=null] - The latitude for a new trip.
     * @param {number} [lng=null] - The longitude for a new trip.
     */
    window.openTripModal = function(tripId = null, lat = null, lng = null) {
      const modalTitle = document.getElementById("tripModalTitle");
      const deleteBtn = document.getElementById("deleteTripBtn");
      document.getElementById("tripForm").reset();
      
      if (tripId) {
        modalTitle.textContent = "Edytuj wyprawƒô";
        deleteBtn.style.display = 'block';
        document.getElementById("tripId").value = tripId;
        const tripDocRef = doc(db, `artifacts/${appId}/public/data/trips`, tripId);
        getDoc(tripDocRef).then(docSnap => {
          if (docSnap.exists()) {
            const data = docSnap.data();
            document.getElementById("tripName").value = data.name;
            document.getElementById("tripDescription").value = data.description;
            document.getElementById("tripStartDate").value = data.startDate || '';
            document.getElementById("tripEndDate").value = data.endDate || '';
            window.tempLat = data.startLocation?.latitude;
            window.tempLng = data.startLocation?.longitude;
          }
        });
      } else {
        modalTitle.textContent = "Dodaj nowƒÖ wyprawƒô";
        deleteBtn.style.display = 'none';
        document.getElementById("tripId").value = '';
        window.tempLat = lat;
        window.tempLng = lng;
      }
      document.getElementById("tripModal").style.display = 'flex';
    };

    document.getElementById("tripForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!db) {
          showMessage("B≈ÇƒÖd: Nie po≈ÇƒÖczono z bazƒÖ danych.");
          return;
      }
      
      const tripId = document.getElementById("tripId").value;
      const tripName = document.getElementById("tripName").value;
      const tripDescription = document.getElementById("tripDescription").value;
      const tripStartDate = document.getElementById("tripStartDate").value;
      const tripEndDate = document.getElementById("tripEndDate").value;

      const tripData = {
        name: tripName,
        description: tripDescription,
        startDate: tripStartDate,
        endDate: tripEndDate,
      };

      if (window.tempLat !== null && window.tempLng !== null) {
        tripData.startLocation = { latitude: window.tempLat, longitude: window.tempLng };
      }
      
      try {
        if (tripId) {
          const tripRef = doc(db, `artifacts/${appId}/public/data/trips`, tripId);
          await updateDoc(tripRef, tripData);
          showMessage("Wyprawa zaktualizowana!");
        } else {
          const tripRef = doc(collection(db, `artifacts/${appId}/public/data/trips`));
          await setDoc(tripRef, tripData);
          showMessage("Nowa wyprawa dodana!");
        }
        closeTripModal();
      } catch (err) {
        console.error("B≈ÇƒÖd podczas zapisywania wyprawy:", err);
        showMessage("Nie uda≈Ço siƒô zapisaƒá wyprawy.");
      }
    });

    /**
     * Confirms and deletes a trip after user confirmation.
     * @param {string} tripId - The ID of the trip to delete.
     */
    window.confirmDeleteTrip = function(tripId) {
      showMessage("Czy na pewno chcesz usunƒÖƒá tƒô wyprawƒô?", true, async () => {
        try {
          await deleteDoc(doc(db, `artifacts/${appId}/public/data/trips`, tripId));
          showMessage("Wyprawa usuniƒôta!");
        } catch (err) {
          console.error("B≈ÇƒÖd podczas usuwania wyprawy:", err);
          showMessage("Nie uda≈Ço siƒô usunƒÖƒá wyprawy.");
        }
      });
    };

    // --- Helper Functions ---
    /**
     * Formats a date string to a Polish locale.
     * @param {string} dateStr - The date string to format.
     * @returns {string} The formatted date string or "Brak daty".
     */
    function formatDate(dateStr) {
      if (!dateStr) return "Brak daty";
      const date = new Date(dateStr);
      return date.toLocaleDateString("pl-PL", { day: "numeric", month: "long", year: "numeric" });
    }

    // --- Initial App Load ---
    // The main entry point for the application.
    window.onload = function() {
      initMap();
      initFirebaseAndAuth();
    };
  </script>
</body>
</html>
