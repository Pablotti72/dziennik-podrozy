<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Miejsce</title>
  <link rel="stylesheet" href="style.css" />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css"
  />
</head>
<body>
  <div class="header-container right-top">
    <div class="header-box">Miejsce</div>
    <a id="backLink" class="back-link" href="#">‚Üê Wr√≥ƒá do wyprawy</a>
  </div>

  <main class="place-page">
    <article id="place-content">
      <p>≈Åadowanie miejsca...</p>
    </article>
    <div id="place-map"></div>
    <div id="place-photos" class="photo-gallery"></div>
  </main>

  <!-- Modal do wy≈õwietlania wiadomo≈õci -->
  <div id="msgModal" class="msg-modal" style="display: none">
    <div class="msg-modal-content">
      <p id="msgText"></p>
      <button onclick="closeMsgModal()">OK</button>
    </div>
  </div>

  <!-- Modal do galerii zdjƒôƒá -->
  <div id="galleryModal" class="gallery-modal" style="display: none;">
    <span class="gallery-close-btn" onclick="closeGalleryModal()">&times;</span>
    <div class="gallery-content">
      <button class="gallery-nav-btn prev-btn" onclick="showPrevPhoto()"><i class="fas fa-chevron-left"></i></button>
      <div class="gallery-image-container">
        <img id="galleryImage" src="" alt="">
        <p id="galleryCaption"></p>
      </div>
      <button class="gallery-nav-btn next-btn" onclick="showNextPhoto()"><i class="fas fa-chevron-right"></i></button>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script type="module">
    // --- Imports from Firebase ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- Global variables provided by the environment ---
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const authToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // --- Firebase Initialization ---
    let app, db, auth;
    let map, photosData = [], currentPhotoIndex = 0;

    async function initializeFirebase() {
        if (Object.keys(firebaseConfig).length === 0) {
            console.error("Firebase config is missing. Data persistence will not work.");
            return;
        }
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            if (authToken) {
                await signInWithCustomToken(auth, authToken);
            } else {
                await signInAnonymously(auth);
            }
            console.log("Firebase initialized successfully.");

            // Start fetching place data
            await setupPlaceListener();

        } catch (error) {
            console.error("Firebase initialization failed:", error);
            showMessage("Nie uda≈Ço siƒô po≈ÇƒÖczyƒá z bazƒÖ danych.");
        }
    }

    function getPlaceIdFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return params.get('id');
    }

    async function setupPlaceListener() {
        const placeId = getPlaceIdFromUrl();
        if (!placeId) {
            document.getElementById("place-content").innerHTML = "<p>‚ùå Brak identyfikatora miejsca.</p>";
            return;
        }

        const placeDocRef = doc(db, `artifacts/${appId}/public/data/places`, placeId);
        onSnapshot(placeDocRef, (docSnap) => {
            if (docSnap.exists()) {
                const placeData = docSnap.data();
                displayPlaceInfo(placeData);
            } else {
                document.getElementById("place-content").innerHTML = "<p>‚ùå Nie uda≈Ço siƒô za≈Çadowaƒá miejsca.</p>";
            }
        }, (error) => {
            console.error("B≈ÇƒÖd ≈Çadowania miejsca:", error);
            document.getElementById("place-content").innerHTML = "<p>‚ùå Nie uda≈Ço siƒô za≈Çadowaƒá miejsca.</p>";
        });
    }

    function displayPlaceInfo(placeData) {
      const placeContent = document.getElementById("place-content");
      placeContent.innerHTML = `
        <h1>${placeData.name}</h1>
        <p><b>Data wizyty:</b> ${formatDate(placeData.date)}</p>
        <p><b>Kategoria:</b> ${getCategoryLabel(placeData.category)}</p>
        <p>${placeData.description || ""}</p>
      `;

      if (placeData.photos && placeData.photos.length > 0) {
        photosData = placeData.photos;
        const photoGallery = document.getElementById("place-photos");
        photoGallery.innerHTML = "";
        placeData.photos.forEach((photo, index) => {
          const imgItem = document.createElement("img");
          imgItem.src = photo.url;
          imgItem.alt = photo.caption || "Zdjƒôcie";
          imgItem.onclick = () => openGalleryModal(index);
          photoGallery.appendChild(imgItem);
        });
      }

      if (placeData.latitude && placeData.longitude) {
        if (map) map.remove();
        map = L.map("place-map").setView([placeData.latitude, placeData.longitude], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        L.marker([placeData.latitude, placeData.longitude]).addTo(map);
      }
    }

    // --- Funkcje UI i obs≈Çugi galerii ---
    window.openGalleryModal = function(index) {
        currentPhotoIndex = index;
        updateGallery();
        document.getElementById('galleryModal').style.display = 'flex';
    };

    window.closeGalleryModal = function() {
        document.getElementById('galleryModal').style.display = 'none';
    };

    window.showPrevPhoto = function() {
        currentPhotoIndex = (currentPhotoIndex - 1 + photosData.length) % photosData.length;
        updateGallery();
    };

    window.showNextPhoto = function() {
        currentPhotoIndex = (currentPhotoIndex + 1) % photosData.length;
        updateGallery();
    };

    function updateGallery() {
        if (photosData.length === 0) return;
        const photo = photosData[currentPhotoIndex];
        document.getElementById('galleryImage').src = photo.url;
        document.getElementById('galleryCaption').textContent = photo.caption;
    }

    function formatDate(dateStr) {
      if (!dateStr) return "Brak daty";
      const date = new Date(dateStr);
      return date.toLocaleDateString("pl-PL", {
        day: "numeric",
        month: "long",
        year: "numeric",
      });
    }

    function getCategoryLabel(category) {
      const categories = {
        miasto: "üèôÔ∏è Miasto",
        park: "üå≥ Park",
        zabytek: "üèõÔ∏è Zabytek",
        muzeum: "üñºÔ∏è Muzeum",
        hotel: "üè® Hotel",
        szczyt: "‚õ∞Ô∏è Szczyt",
        restauracja: "üçΩÔ∏è Restauracja",
        miejsce_widokowe: "üåÑ Miejsce widokowe",
        atrakcja_turystyczna: "üéØ Atrakcja turystyczna",
        inny: "üîß Inny",
      };
      return categories[category] || category;
    }

    window.showMessage = function (text) {
      document.getElementById("msgText").textContent = text;
      document.getElementById("msgModal").style.display = "flex";
    };

    window.closeMsgModal = function () {
      document.getElementById("msgModal").style.display = "none";
    };

    // Obs≈Çuga klawisza ESC
    document.addEventListener("keydown", function (e) {
      if (e.key === "Escape") {
        document.getElementById("galleryModal").style.display = "none";
        document.getElementById("msgModal").style.display = "none";
      }
      if (
        document.getElementById("galleryModal").style.display === "flex" &&
        photosData.length > 1
      ) {
        if (e.key === "ArrowLeft") {
          showPrevPhoto();
        } else if (e.key === "ArrowRight") {
          showNextPhoto();
        }
      }
    });

    // Uruchomienie aplikacji
    document.addEventListener("DOMContentLoaded", () => {
        initializeFirebase();
    });
  </script>
</body>
</html>
