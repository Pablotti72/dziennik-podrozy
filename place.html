<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Miejsce</title>
  <link rel="stylesheet" href="style.css" />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css"
  />
</head>
<body>
  <div class="back-link">
    <a id="backLink" href="#">‚Üê Wr√≥ƒá do wyprawy</a>
  </div>

  <main class="place-page">
    <article id="place-content">
      <p>≈Åadowanie miejsca...</p>
    </article>
    <div id="place-map"></div>
    <div id="place-photos" class="photo-gallery"></div>
  </main>

  <!-- Modal do wy≈õwietlania wiadomo≈õci -->
  <div id="msgModal" class="msg-modal" style="display: none">
    <div class="msg-modal-content">
      <p id="msgText"></p>
      <button onclick="closeMsgModal()">OK</button>
    </div>
  </div>

  <!-- Nowy modal dla galerii zdjƒôƒá -->
  <div id="galleryModal" class="modal" style="display: none">
    <div class="gallery-content">
      <span class="gallery-close-btn" onclick="closeGalleryModal()"
        >&times;</span
      >
      <div id="galleryImageContainer" class="gallery-image-container">
        <img id="galleryImage" src="" alt="Zdjƒôcie z galerii" />
        <p id="galleryCaption"></p>
        <button
          class="gallery-nav-btn gallery-prev"
          onclick="navigateGallery(-1)"
        >
          &#10094;
        </button>
        <button
          class="gallery-nav-btn gallery-next"
          onclick="navigateGallery(1)"
        >
          &#10095;
        </button>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const firebaseBaseUrl =
      "https://moj-dziennik-podrozy-default-rtdb.europe-west1.firebasedatabase.app";
    const urlParams = new URLSearchParams(window.location.search);
    const tripId = urlParams.get("tripId");
    const placeId = urlParams.get("placeId");
    const fromPage = urlParams.get("from");
    const isEditing = sessionStorage.getItem("isEditing") === "true";

    const backLink = document.getElementById("backLink");
    if (isEditing) {
      backLink.href = `trip.html?id=${tripId}&from=edit`;
    } else {
      backLink.href = `trip.html?id=${tripId}`;
    }

    const placeUrl = `${firebaseBaseUrl}/trips/${tripId}/places/${placeId}.json`;
    const mapContainer = document.getElementById("place-map");
    const map = L.map(mapContainer, {
      zoomControl: false,
      scrollWheelZoom: false,
      dragging: false,
    });
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

    let photosData = [];
    let currentPhotoIndex = 0;

    // Funkcja ≈ÇadujƒÖca dane miejsca i renderujƒÖca zawarto≈õƒá
    function loadPlace() {
      fetch(placeUrl)
        .then((res) => res.json())
        .then((place) => {
          if (!place) {
            document.getElementById(
              "place-content"
            ).innerHTML = `<p class="no-content-message">‚ùå Nie uda≈Ço siƒô za≈Çadowaƒá miejsca.</p>`;
            return;
          }

          document.getElementById("place-content").innerHTML = `
            <h1>${place.name}</h1>
            <div class="main-image-container">
              ${
                place.photos && place.photos.length > 0
                  ? `<img src="${place.photos[0].url}" alt="G≈Ç√≥wne zdjƒôcie miejsca" class="main-image" />`
                  : `<p class="no-content-message">Brak g≈Ç√≥wnego zdjƒôcia.</p>`
              }
            </div>
            <p><strong>Kategoria:</strong> ${getCategoryLabel(
              place.category
            )}</p>
            <p><strong>Data:</strong> ${formatDate(place.date)}</p>
            <p>${place.description || "Brak opisu."}</p>
          `;

          // Ustawienie widoku mapy na lokalizacjƒô miejsca
          if (place.coords && place.coords.lat && place.coords.lng) {
            map.setView([place.coords.lat, place.coords.lng], 13);
            L.marker([place.coords.lat, place.coords.lng]).addTo(map);
          } else {
            mapContainer.style.display = "none";
          }

          // ≈Åadowanie i renderowanie zdjƒôƒá w galerii
          const photoGallery = document.getElementById("place-photos");
          photoGallery.innerHTML = "";
          photosData = place.photos || [];

          if (photosData.length > 0) {
            // Pomijamy pierwsze zdjƒôcie, bo jest wy≈õwietlane jako g≈Ç√≥wne
            photosData.slice(1).forEach((photo, index) => {
              const galleryItem = document.createElement("div");
              galleryItem.className = "photo-item";
              galleryItem.innerHTML = `
                <img src="${photo.url}" alt="${photo.caption}" class="place-image" onclick="openGalleryModal(${index + 1})" />
                <p class="photo-caption">${photo.caption}</p>
              `;
              photoGallery.appendChild(galleryItem);
            });
            if (photosData.length === 1) {
              photoGallery.innerHTML = "<p>Brak dodatkowych zdjƒôƒá w galerii.</p>";
            }
          } else {
            photoGallery.innerHTML =
              "<p>Brak zdjƒôƒá w galerii.</p>";
          }
        })
        .catch((err) => {
          console.error("B≈ÇƒÖd ≈Çadowania miejsca:", err);
          document.getElementById(
            "place-content"
          ).innerHTML = `<p class="no-content-message">‚ùå Nie uda≈Ço siƒô za≈Çadowaƒá miejsca.</p>`;
        });
    }

    // --- Funkcje do obs≈Çugi galerii ---
    window.openGalleryModal = function (index) {
      if (photosData.length === 0) return;
      currentPhotoIndex = index;
      const modal = document.getElementById("galleryModal");
      const img = document.getElementById("galleryImage");
      const caption = document.getElementById("galleryCaption");

      img.src = photosData[currentPhotoIndex].url;
      img.alt = photosData[currentPhotoIndex].caption;
      caption.textContent = photosData[currentPhotoIndex].caption;
      modal.style.display = "flex";
      updateGalleryNav();
    };

    window.closeGalleryModal = function () {
      const modal = document.getElementById("galleryModal");
      modal.style.display = "none";
    };

    window.navigateGallery = function (direction) {
      currentPhotoIndex = (currentPhotoIndex + direction + photosData.length) % photosData.length;
      const img = document.getElementById("galleryImage");
      const caption = document.getElementById("galleryCaption");

      img.src = photosData[currentPhotoIndex].url;
      img.alt = photosData[currentPhotoIndex].caption;
      caption.textContent = photosData[currentPhotoIndex].caption;
      updateGalleryNav();
    };

    function updateGalleryNav() {
      const prevBtn = document.querySelector(".gallery-prev");
      const nextBtn = document.querySelector(".gallery-next");

      prevBtn.style.display = photosData.length > 1 ? "block" : "none";
      nextBtn.style.display = photosData.length > 1 ? "block" : "none";
    }

    // --- Funkcje pomocnicze ---
    function formatDate(dateStr) {
      if (!dateStr) return "Brak daty";
      const date = new Date(dateStr);
      return date.toLocaleDateString("pl-PL", {
        day: "numeric",
        month: "long",
        year: "numeric",
      });
    }

    function getCategoryLabel(category) {
      const categories = {
        miasto: "üèôÔ∏è Miasto",
        park: "üå≥ Park",
        zabytek: "üèõÔ∏è Zabytek",
        muzeum: "üñºÔ∏è Muzeum",
        hotel: "üè® Hotel",
        szczyt: "‚õ∞Ô∏è Szczyt",
        restauracja: "üçΩÔ∏è Restauracja",
        miejsce_widokowe: "üåÑ Miejsce widokowe",
        atrakcja_turystyczna: "üéØ Atrakcja turystyczna",
        inny: "üîß Inny",
      };
      return categories[category] || category;
    }

    window.showMessage = function (text) {
      document.getElementById("msgText").textContent = text;
      document.getElementById("msgModal").style.display = "flex";
    };

    window.closeMsgModal = function () {
      document.getElementById("msgModal").style.display = "none";
    };

    document.addEventListener("keydown", function (e) {
      if (
        document.getElementById("galleryModal").style.display === "flex" &&
        photosData.length > 1
      ) {
        if (e.key === "ArrowLeft") {
          navigateGallery(-1);
        } else if (e.key === "ArrowRight") {
          navigateGallery(1);
        }
      }
      if (e.key === "Escape") {
        closeGalleryModal();
        closeMsgModal();
      }
    });

    loadPlace();
  </script>
</body>
</html>
