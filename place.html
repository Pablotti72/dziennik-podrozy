<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Miejsce</title>
  <link rel="stylesheet" href="style.css" />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css"
  />
</head>
<body>
  <div class="header-container right-top">
    <div class="header-box">Miejsce</div>
    <a id="backLink" class="back-link" href="#">← Wróć do wyprawy</a>
  </div>

  <main class="place-page">
    <article id="place-content">
      <p>Ładowanie miejsca...</p>
    </article>
    <div id="place-map"></div>
    <div id="place-photos" class="photo-gallery"></div>
  </main>

  <!-- Modal do wyświetlania wiadomości -->
  <div id="msgModal" class="msg-modal" style="display: none">
    <div class="msg-modal-content">
      <p id="msgText"></p>
      <button onclick="closeMsgModal()">OK</button>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const firebaseBaseUrl = "https://moj-dziennik-podrozy-default-rtdb.europe-west1.firebasedatabase.app";
    const urlParams = new URLSearchParams(window.location.search);
    const tripId = urlParams.get("tripId");
    const placeId = urlParams.get("placeId");
    let photosData = []; // Zmienna do przechowywania danych zdjęć dla galerii

    if (!tripId || !placeId) {
      document.getElementById("place-content").innerHTML = "<p>❌ Brak ID wyprawy lub miejsca.</p>";
    } else {
      document.getElementById("backLink").href = `trip.html?id=${tripId}`;
      loadPlaceDetails();
    }

    // Funkcja ładująca szczegóły miejsca
    function loadPlaceDetails() {
      const placeUrl = `${firebaseBaseUrl}/trips/${tripId}/places/${placeId}.json`;
      fetch(placeUrl)
        .then(res => {
          if (!res.ok) throw new Error("Błąd ładowania miejsca.");
          return res.json();
        })
        .then(place => {
          if (!place) {
            document.getElementById("place-content").innerHTML = "<p>❌ Nie znaleziono takiego miejsca.</p>";
            return;
          }
          displayPlace(place);
        })
        .catch(err => {
          console.error("Błąd ładowania miejsca:", err);
          document.getElementById("place-content").innerHTML = "<p>❌ Nie udało się załadować miejsca.</p>";
        });
    }

    // Funkcja wyświetlająca szczegóły miejsca
    function displayPlace(place) {
      // Pobieranie głównego URL zdjęcia z klucza 'image'
      const mainImageUrl = place.image ? place.image : 'https://placehold.co/800x400/e0e0e0/555555?text=Brak+zdjęcia';
      
      const contentHtml = `
        <h1>${place.name}</h1>
        <img src="${mainImageUrl}" alt="${place.name}" class="place-image" onerror="this.onerror=null;this.src='https://placehold.co/800x400/e0e0e0/555555?text=Brak+zdjęcia';">
        <p><strong>Kategoria:</strong> ${getCategoryLabel(place.category)}</p>
        <p><strong>Data:</strong> ${formatDate(place.date)}</p>
        <p><strong>Opis:</strong> ${place.description || "Brak opisu."}</p>
      `;
      document.getElementById("place-content").innerHTML = contentHtml;

      // Sprawdzamy, czy dane lokalizacji są zagnieżdżone w "coords" czy bezpośrednio w obiekcie
      let lat, lng;
      if (place.coords) {
          lat = place.coords.lat;
          lng = place.coords.lng;
      } else if (place.lat && place.lng) {
          lat = place.lat;
          lng = place.lng;
      } else {
          // Jeśli brak danych, nie próbuj tworzyć mapy
          console.error("Brak danych geolokalizacyjnych dla tego miejsca.");
          document.getElementById("place-map").style.display = "none";
          return;
      }

      // Wyświetlanie mapy z lokalizacją
      const map = L.map("place-map").setView([lat, lng], 13);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "© OpenStreetMap contributors",
      }).addTo(map);
      L.marker([lat, lng]).addTo(map).bindPopup(place.name).openPopup();
      
      // Obsługa galerii zdjęć - jeśli istnieje
      photosData = place.photos || [];
      const gallery = document.getElementById("place-photos");
      gallery.innerHTML = ''; // Wyczyść poprzednią zawartość

      if (photosData.length > 0) {
          photosData.forEach((photo, index) => {
              const item = document.createElement("a");
              item.href = "#";
              item.className = "photo-gallery-item";
              item.onclick = (e) => {
                  e.preventDefault();
                  // Tutaj brakuje funkcji openGalleryModal, która jest potrzebna do obsługi kliknięcia
              };
              item.innerHTML = `<img src="${photo.url}" alt="${photo.caption}" class="thumb" onerror="this.onerror=null;this.src='https://placehold.co/150x150/e0e0e0/555555?text=Brak+zdjęcia';">`;
              gallery.appendChild(item);
          });
      } else {
          gallery.innerHTML = "<p class='no-content-message'>Brak zdjęć w galerii.</p>";
      }
    }

    // --- Funkcje pomocnicze ---
    function formatDate(dateStr) {
      if (!dateStr) return "Brak daty";
      const date = new Date(dateStr);
      return date.toLocaleDateString("pl-PL", {
        day: "numeric",
        month: "long",
        year: "numeric",
      });
    }

    function getCategoryLabel(category) {
      const categories = {
        miasto: "🏙️ Miasto",
        park: "🌳 Park",
        zabytek: "🏛️ Zabytek",
        muzeum: "🖼️ Muzeum",
        hotel: "🏨 Hotel",
        szczyt: "⛰️ Szczyt",
        restauracja: "🍽️ Restauracja",
        miejsce_widokowe: "🌄 Miejsce widokowe",
        atrakcja_turystyczna: "🎯 Atrakcja turystyczna",
        inny: "🔧 Inny",
      };
      return categories[category] || category;
    }

    window.showMessage = function (text) {
      document.getElementById("msgText").textContent = text;
      document.getElementById("msgModal").style.display = "flex";
    };

    window.closeMsgModal = function () {
      document.getElementById("msgModal").style.display = "none";
    };

    // Obsługa klawisza ESC
    document.addEventListener("keydown", function (e) {
      if (e.key === "Escape") {
        closeMsgModal();
      }
    });
  </script>
</body>
</html>
