<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Miejsce</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" />
</head>
<body>

    <!-- G≈Ç√≥wny nag≈Ç√≥wek z przyciskami -->
    <header>
        <div class="header-container-left">
            <h1 class="page-title">Miejsce</h1>
        </div>
        <div class="header-container-right">
            <button id="openMenuBtn" class="open-btn-menu">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </header>

    <!-- Boczne menu -->
    <div id="sideMenu" class="side-menu">
        <button id="closeMenuBtn" class="close-btn-menu">&times;</button>
        <div class="menu-content">
            <h2>Opcje</h2>
            <a id="backLink" href="#">‚Üê Wr√≥ƒá do wyprawy</a>
            <a id="homeLink" href="index.html">üè† Strona g≈Ç√≥wna</a>
        </div>
    </div>

    <!-- G≈Ç√≥wna zawarto≈õƒá strony z miejscem -->
    <main class="place-page">
        <article id="place-content">
            <p>≈Åadowanie miejsca...</p>
        </article>
        <h2 class="section-title" id="gallery-title" style="display:none;">Galeria zdjƒôƒá</h2>
        <div id="place-photos" class="photo-gallery"></div>
    </main>

    <!-- Lightbox dla zdjƒôƒá -->
    <div id="lightbox" class="lightbox">
        <span class="close-btn" onclick="closeLightbox()">&times;</span>
        <span class="nav-btn prev" onclick="navigatePhotos(-1)">&#10094;</span>
        <img id="lightbox-image" src="" alt="">
        <span class="nav-btn next" onclick="navigatePhotos(1)">&#10095;</span>
        <div id="lightbox-caption" class="lightbox-caption"></div>
    </div>

    <!-- Modal komunikatu -->
    <div id="msgModal" class="msg-modal">
        <div class="msg-modal-content">
            <p id="msgText"></p>
            <button onclick="closeMsgModal()">OK</button>
        </div>
    </div>

    <script>
        const firebaseBaseUrl = "https://moj-dziennik-podrozy-default-rtdb.europe-west1.firebasedatabase.app";
        const urlParams = new URLSearchParams(window.location.search);
        const tripId = urlParams.get("tripId");
        const placeId = urlParams.get("placeId");
        
        let allPhotos = [];
        let currentPhotoIndex = 0;

        const backLink = document.getElementById("backLink");
        const galleryTitle = document.getElementById("gallery-title");
        const sideMenu = document.getElementById('sideMenu');
        const openMenuBtn = document.getElementById('openMenuBtn');
        const closeMenuBtn = document.getElementById('closeMenuBtn');
        const placePhotosContainer = document.getElementById("place-photos");
        const lightbox = document.getElementById("lightbox");
        const lightboxImage = document.getElementById("lightbox-image");
        const lightboxCaption = document.getElementById("lightbox-caption");

        // Funkcja do formatowania daty
        function formatDate(dateStr) {
            if (!dateStr) return "Brak daty";
            const date = new Date(dateStr);
            return date.toLocaleDateString("pl-PL", { day: "numeric", month: "long", year: "numeric" });
        }

        // Funkcja do pobierania etykiety kategorii
        function getCategoryLabel(category) {
            const categories = {
                "miasto": "üèôÔ∏è Miasto", "park": "üå≥ Park", "zabytek": "üèõÔ∏è Zabytek",
                "muzeum": "üñºÔ∏è Muzeum", "hotel": "üè® Hotel", "szczyt": "‚õ∞Ô∏è Szczyt",
                "restauracja": "üçΩÔ∏è Restauracja", "miejsce_widokowe": "üåÑ Miejsce widokowe",
                "atrakcja_turystyczna": "üéØ Atrakcja turystyczna", "inny": "üîß Inny"
            };
            return categories[category] || category;
        }

        // Funkcja do pokazywania komunikat√≥w
        function showMessage(text) {
            document.getElementById("msgText").textContent = text;
            document.getElementById("msgModal").style.display = "flex";
        }

        function closeMsgModal() {
            document.getElementById("msgModal").style.display = "none";
        }

        // Funkcja do otwierania menu bocznego
        function openNav() {
            sideMenu.style.width = "250px";
        }

        // Funkcja do zamykania menu bocznego
        function closeNav() {
            sideMenu.style.width = "0";
        }
        
        // Obs≈Çuga klikniƒôƒá przycisk√≥w menu
        openMenuBtn.addEventListener('click', openNav);
        closeMenuBtn.addEventListener('click', closeNav);

        // Funkcje obs≈ÇugujƒÖce lightbox
        function openLightbox(url, caption) {
            lightboxImage.src = url;
            lightboxCaption.textContent = caption;
            lightbox.style.display = "flex";
        }

        window.closeLightbox = function() {
            lightbox.style.display = "none";
        };

        window.navigatePhotos = function(direction) {
            currentPhotoIndex += direction;
            if (currentPhotoIndex < 0) {
                currentPhotoIndex = allPhotos.length - 1;
            } else if (currentPhotoIndex >= allPhotos.length) {
                currentPhotoIndex = 0;
            }
            const nextPhoto = allPhotos[currentPhotoIndex];
            openLightbox(nextPhoto.url, nextPhoto.caption);
        };

        // Nas≈Çuchiwanie na klawisze strza≈Çek i Esc
        document.addEventListener("keydown", function(e) {
            if (lightbox.style.display === "flex") {
                if (e.key === "ArrowLeft") {
                    navigatePhotos(-1);
                } else if (e.key === "ArrowRight") {
                    navigatePhotos(1);
                } else if (e.key === "Escape") {
                    closeLightbox();
                }
            }
            if (e.key === "Escape") {
                closeMsgModal();
            }
        });

        // ≈Åadowanie danych z Firebase
        function loadPlaceData() {
            backLink.href = `trip.html?id=${tripId}`;
            const placeUrl = `${firebaseBaseUrl}/trips/${tripId}/places/${placeId}.json`;

            fetch(placeUrl)
                .then(res => res.json())
                .then(place => {
                    if (!place) {
                        document.getElementById("place-content").innerHTML = "<p>‚ùå Miejsce nie istnieje.</p>";
                        return;
                    }
                    
                    document.getElementById("place-content").innerHTML = `
                        <h1>${place.name}</h1>
                        <p><strong>Kategoria:</strong> ${getCategoryLabel(place.category)}</p>
                        <p><strong>Data:</strong> ${formatDate(place.date)}</p>
                        <p>${place.description || ''}</p>
                    `;
                    
                    if (place.image) {
                        const mainImg = document.createElement("img");
                        mainImg.src = place.image;
                        mainImg.className = "place-image";
                        mainImg.onerror = function() { this.onerror=null; this.src='https://placehold.co/600x400/cccccc/333333?text=Brak%20zdjƒôcia%20g≈Ç√≥wnego'; };
                        document.getElementById("place-content").appendChild(mainImg);
                    }

                    if (place.photos && place.photos.length > 0) {
                        allPhotos = place.photos;
                        placePhotosContainer.innerHTML = "";
                        galleryTitle.style.display = "block";
                        
                        place.photos.forEach((photo, index) => {
                            const item = document.createElement("div");
                            item.className = "photo-item";
                            item.innerHTML = `
                                <img src="${photo.url}" alt="${photo.caption || ''}" data-index="${index}" onerror="this.onerror=null; this.src='https://placehold.co/300x200/cccccc/333333?text=Brak%20zdjƒôcia';">
                                <p>${photo.caption || ''}</p>
                            `;
                            placePhotosContainer.appendChild(item);
                            
                            const img = item.querySelector("img");
                            img.addEventListener("click", () => {
                                currentPhotoIndex = index;
                                openLightbox(img.src, img.alt);
                            });
                        });
                    } else {
                        galleryTitle.style.display = "none";
                        placePhotosContainer.innerHTML = "<p>Brak zdjƒôƒá w galerii.</p>";
                    }
                })
                .catch(err => {
                    console.error("B≈ÇƒÖd ≈Çadowania miejsca:", err);
                    document.getElementById("place-content").innerHTML = "<p>‚ùå Nie uda≈Ço siƒô za≈Çadowaƒá miejsca.</p>";
                });
        }

        // Wywo≈Çanie funkcji ≈Çadowania danych przy starcie strony
        loadPlaceData();
    </script>
</body>
</html>
