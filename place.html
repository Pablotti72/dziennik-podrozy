<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Miejsce</title>
  <link rel="stylesheet" href="style.css" />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css"
  />
</head>
<body>
  <div class="header-container right-top">
    <div class="header-box">Miejsce</div>
    <a id="backLink" class="back-link" href="#">‚Üê Wr√≥ƒá do wyprawy</a>
  </div>

  <main class="place-page">
    <article id="place-content">
      <p>≈Åadowanie miejsca...</p>
    </article>
    <div id="place-map"></div>
    <div id="place-photos" class="photo-gallery"></div>
  </main>

  <!-- Modal do wy≈õwietlania wiadomo≈õci -->
  <div id="msgModal" class="msg-modal" style="display: none">
    <div class="msg-modal-content">
      <p id="msgText"></p>
      <button onclick="closeMsgModal()">OK</button>
    </div>
  </div>

  <!-- Modal do wy≈õwietlania galerii zdjƒôƒá -->
  <div id="galleryModal" class="gallery-modal" style="display: none">
    <div class="gallery-content">
      <button class="gallery-close-btn" onclick="closeGalleryModal()">&times;</button>
      <button class="gallery-nav-btn prev" onclick="prevPhoto()"><i class="fas fa-chevron-left"></i></button>
      <div class="gallery-image-container">
        <img id="gallery-image" src="" alt="" />
        <p id="gallery-caption"></p>
      </div>
      <button class="gallery-nav-btn next" onclick="nextPhoto()"><i class="fas fa-chevron-right"></i></button>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // Konfiguracja Firebase
    const firebaseBaseUrl = "https://moj-dziennik-podrozy-default-rtdb.europe-west1.firebasedatabase.app/";
    let photosData = []; // Zmienna globalna do przechowywania danych zdjƒôƒá
    let currentPhotoIndex = 0; // Zmienna do ≈õledzenia aktualnego zdjƒôcia w galerii

    // Funkcja otwierajƒÖca modal galerii zdjƒôƒá
    window.openGalleryModal = function (index) {
      if (photosData.length === 0) return;
      currentPhotoIndex = index;
      updateGalleryModal();
      document.getElementById("galleryModal").style.display = "flex";
      // Ukryj przyciski nawigacyjne, je≈õli jest tylko jedno zdjƒôcie
      const navButtons = document.querySelectorAll('.gallery-nav-btn');
      if (photosData.length <= 1) {
        navButtons.forEach(btn => btn.style.display = 'none');
      } else {
        navButtons.forEach(btn => btn.style.display = 'block');
      }
    };

    // Funkcja zamykajƒÖca modal galerii
    window.closeGalleryModal = function () {
      document.getElementById("galleryModal").style.display = "none";
    };

    // Funkcja do aktualizacji zawarto≈õci modalu galerii
    function updateGalleryModal() {
      const photo = photosData[currentPhotoIndex];
      if (photo) {
        document.getElementById("gallery-image").src = photo.url;
        document.getElementById("gallery-image").alt = photo.caption;
        document.getElementById("gallery-caption").textContent = photo.caption;
      }
    }

    // Nawigacja w galerii
    window.prevPhoto = function () {
      currentPhotoIndex = (currentPhotoIndex - 1 + photosData.length) % photosData.length;
      updateGalleryModal();
    };

    window.nextPhoto = function () {
      currentPhotoIndex = (currentPhotoIndex + 1) % photosData.length;
      updateGalleryModal();
    };

    // Obs≈Çuga klawisza ESC
    document.addEventListener("keydown", function (e) {
      if (e.key === "Escape") {
        if (document.getElementById("galleryModal").style.display === "flex") {
          closeGalleryModal();
        }
        if (document.getElementById("msgModal").style.display === "flex") {
          closeMsgModal();
        }
      }
      if (
        document.getElementById("galleryModal").style.display === "flex" &&
        photosData.length > 1
      ) {
        if (e.key === "ArrowLeft") {
          prevPhoto();
        } else if (e.key === "ArrowRight") {
          nextPhoto();
        }
      }
    });

    const urlParams = new URLSearchParams(window.location.search);
    const tripId = urlParams.get("tripId");
    const placeId = urlParams.get("id");

    if (!tripId || !placeId) {
      document.getElementById("place-content").innerHTML =
        "<p>‚ùå Nieprawid≈Çowy adres URL. Brakuje ID wyprawy lub miejsca.</p>";
    }

    // Adresy URL
    const placeUrl = `${firebaseBaseUrl}trips/${tripId}/places/${placeId}.json`;
    const backLink = document.getElementById("backLink");
    backLink.href = `trip.html?id=${tripId}`;

    fetch(placeUrl)
      .then((res) => {
        if (!res.ok) throw new Error("B≈ÇƒÖd ≈Çadowania danych.");
        return res.json();
      })
      .then((place) => {
        if (!place) {
          document.getElementById("place-content").innerHTML =
            "<p>‚ùå Nie znaleziono miejsca.</p>";
          return;
        }

        const placeContent = document.getElementById("place-content");
        placeContent.innerHTML = `
          <h1>${place.name}</h1>
          <p><strong>Kategoria:</strong> ${getCategoryLabel(place.category)}</p>
          <p><strong>Data:</strong> ${formatDate(place.date)}</p>
          <p><strong>Opis:</strong> ${place.description || "Brak opisu."}</p>
        `;

        // ≈Åadowanie g≈Ç√≥wnego zdjƒôcia
        if (place.mainPhoto) {
          const mainPhotoHtml = `
            <img src="${place.mainPhoto}" alt="G≈Ç√≥wne zdjƒôcie miejsca" class="place-image">
          `;
          placeContent.innerHTML += mainPhotoHtml;
        }

        // Inicjalizacja mapy Leaflet
        const placeMap = document.getElementById("place-map");
        if (place.coords && place.coords.lat && place.coords.lng) {
          placeMap.style.height = "400px";
          const map = L.map("place-map").setView(
            [place.coords.lat, place.coords.lng],
            13
          );
          L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution:
              '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
          }).addTo(map);
          L.marker([place.coords.lat, place.coords.lng]).addTo(map).bindPopup(place.name);
          map.invalidateSize();
        } else {
          placeMap.style.display = "none";
        }

        // ≈Åadowanie galerii zdjƒôƒá
        const photoGallery = document.getElementById("place-photos");
        photosData = Array.isArray(place.photos) ? place.photos : [];
        if (photosData.length > 0) {
          photosData.forEach((photo, index) => {
            const item = document.createElement("div");
            item.className = "photo-item-thumb";
            item.innerHTML = `
                <img src="${photo.url}" alt="${photo.caption}" onclick="openGalleryModal(${index})">
                <p>${photo.caption}</p>
              `;
            photoGallery.appendChild(item);
          });
        }
      })
      .catch((err) => {
        console.error("B≈ÇƒÖd ≈Çadowania miejsca:", err);
        document.getElementById("place-content").innerHTML =
          "<p>‚ùå Nie uda≈Ço siƒô za≈Çadowaƒá miejsca.</p>";
      });

    // --- Funkcje pomocnicze ---
    function formatDate(dateStr) {
      if (!dateStr) return "Brak daty";
      const date = new Date(dateStr);
      return date.toLocaleDateString("pl-PL", {
        day: "numeric",
        month: "long",
        year: "numeric",
      });
    }

    function getCategoryLabel(category) {
      const categories = {
        miasto: "üèôÔ∏è Miasto",
        park: "üå≥ Park",
        zabytek: "üèõÔ∏è Zabytek",
        muzeum: "üñºÔ∏è Muzeum",
        hotel: "üè® Hotel",
        szczyt: "‚õ∞Ô∏è Szczyt",
        restauracja: "üçΩÔ∏è Restauracja",
        miejsce_widokowe: "üåÑ Miejsce widokowe",
        atrakcja_turystyczna: "üéØ Atrakcja turystyczna",
        inny: "üîß Inny",
      };
      return categories[category] || category;
    }

    window.showMessage = function (text) {
      document.getElementById("msgText").textContent = text;
      document.getElementById("msgModal").style.display = "flex";
    };

    window.closeMsgModal = function () {
      document.getElementById("msgModal").style.display = "none";
    };
  </script>
</body>
</html>
