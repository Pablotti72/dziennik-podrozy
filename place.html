<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Miejsce</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
  <div class="back-link">
    <a id="backLink" href="#">‚Üê Wr√≥ƒá do wyprawy</a>
  </div>

  <main class="place-page">
    <article id="place-content">
      <p>≈Åadowanie miejsca...</p>
    </article>
    <div id="place-map"></div>
    <div id="place-photos" class="photo-gallery"></div>
  </main>

  <div id="lightbox" class="lightbox" style="display: none;">
    <span class="close-btn" onclick="closeLightbox()">&times;</span>
    <span class="nav-btn prev" onclick="navigatePhotos(-1)">&#10094;</span>
    <img id="lightbox-image" src="" alt="">
    <span class="nav-btn next" onclick="navigatePhotos(1)">&#10095;</span>
    <div id="lightbox-caption" class="lightbox-caption"></div>
  </div>

  <div id="msgModal" class="msg-modal" style="display: none;">
    <div class="msg-modal-content">
      <p id="msgText"></p>
      <button onclick="closeMsgModal()">OK</button>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const firebaseBaseUrl = "https://moj-dziennik-podrozy-default-rtdb.europe-west1.firebasedatabase.app";
    const urlParams = new URLSearchParams(window.location.search);
    const tripId = urlParams.get("tripId");
    const placeId = urlParams.get("placeId");
    const fromPage = urlParams.get("from");
    const isEditing = sessionStorage.getItem("isEditing") === "true";

    let allPhotos = [];
    let currentPhotoIndex = 0;

    const backLink = document.getElementById("backLink");
    if (isEditing) {
        backLink.href = `trip.html?id=${tripId}&from=edit`;
    } else {
        backLink.href = `trip.html?id=${tripId}`;
    }
    
    const placeUrl = `${firebaseBaseUrl}/trips/${tripId}/places/${placeId}.json`;
    const map = L.map("place-map");
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

    fetch(placeUrl)
      .then(res => res.json())
      .then(place => {
        if (!place) {
          document.getElementById("place-content").innerHTML = "<p>‚ùå Miejsce nie istnieje.</p>";
          return;
        }

        document.getElementById("place-content").innerHTML = `
          <h1>${place.name}</h1>
          <p><strong>Kategoria:</strong> ${getCategoryLabel(place.category)}</p>
          <p><strong>Data:</strong> ${formatDate(place.date)}</p>
          <p>${place.description || ''}</p>
        `;
        
        if (place.lat && place.lng) {
          map.setView([place.lat, place.lng], 12);
          L.marker([place.lat, place.lng]).addTo(map).bindPopup(`<strong>${place.name}</strong>`).openPopup();
        }

        if (place.photos && place.photos.length > 0) {
          allPhotos = place.photos;
          const gallery = document.getElementById("place-photos");
          place.photos.forEach((photo, index) => {
            const item = document.createElement("div");
            item.className = "photo-item";
            item.innerHTML = `
              <img src="${photo.url}" alt="${photo.caption || ''}" data-index="${index}">
              <p>${photo.caption || ''}</p>
            `;
            gallery.appendChild(item);
          });
          addPhotoClickListeners();
        }
      })
      .catch(err => {
        console.error("B≈ÇƒÖd ≈Çadowania miejsca:", err);
        document.getElementById("place-content").innerHTML = "<p>‚ùå Nie uda≈Ço siƒô za≈Çadowaƒá miejsca.</p>";
      });

    // --- Funkcje galerii (lightbox) ---
    function addPhotoClickListeners() {
        const photos = document.querySelectorAll(".photo-item img");
        photos.forEach((img, index) => {
            img.addEventListener("click", () => {
                currentPhotoIndex = index;
                openLightbox(img.src, img.alt);
            });
        });
    }

    window.openLightbox = function(url, caption) {
        const lightbox = document.getElementById("lightbox");
        const lightboxImage = document.getElementById("lightbox-image");
        const lightboxCaption = document.getElementById("lightbox-caption");

        lightboxImage.src = url;
        lightboxCaption.textContent = caption;
        lightbox.style.display = "flex";
    };

    window.closeLightbox = function() {
        document.getElementById("lightbox").style.display = "none";
    };

    window.navigatePhotos = function(direction) {
        currentPhotoIndex += direction;
        if (currentPhotoIndex < 0) {
            currentPhotoIndex = allPhotos.length - 1;
        } else if (currentPhotoIndex >= allPhotos.length) {
            currentPhotoIndex = 0;
        }
        
        const nextPhoto = allPhotos[currentPhotoIndex];
        openLightbox(nextPhoto.url, nextPhoto.caption);
    };

    // --- Funkcje pomocnicze ---
    function formatDate(dateStr) {
      if (!dateStr) return "Brak daty";
      const date = new Date(dateStr);
      return date.toLocaleDateString("pl-PL", { day: "numeric", month: "long", year: "numeric" });
    }

    function getCategoryLabel(category) {
      const categories = {
        "miasto": "üèôÔ∏è Miasto", "park": "üå≥ Park", "zabytek": "üèõÔ∏è Zabytek",
        "muzeum": "üñºÔ∏è Muzeum", "hotel": "üè® Hotel", "szczyt": "‚õ∞Ô∏è Szczyt",
        "restauracja": "üçΩÔ∏è Restauracja", "miejsce_widokowe": "üåÑ Miejsce widokowe",
        "atrakcja_turystyczna": "üéØ Atrakcja turystyczna", "inny": "üîß Inny"
      };
      return categories[category] || category;
    }

    window.showMessage = function(text) {
      document.getElementById("msgText").textContent = text;
      document.getElementById("msgModal").style.display = "flex";
    };

    window.closeMsgModal = function() {
      document.getElementById("msgModal").style.display = "none";
    };
    
    document.addEventListener("keydown", function(e) {
      if (document.getElementById("lightbox").style.display === "flex") {
        if (e.key === "ArrowLeft") {
          navigatePhotos(-1);
        } else if (e.key === "ArrowRight") {
          navigatePhotos(1);
        }
      }
      if (e.key === "Escape") {
        closeLightbox();
        closeMsgModal();
      }
    });

  </script>
</body>
</html>
