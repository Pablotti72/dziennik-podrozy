<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Miejsce</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
  <div class="back-link">
    <a id="backLink" href="#">← Wróć do wyprawy</a>
  </div>

  <main class="place-page">
    <article id="place-content">
      <p>Ładowanie miejsca...</p>
    </article>
    <div id="place-map"></div>
    <div id="place-photos" class="photo-gallery"></div>
  </main>

  <div id="msgModal" class="msg-modal" style="display: none;">
    <div class="msg-modal-content">
      <p id="msgText"></p>
      <button onclick="closeMsgModal()">OK</button>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const firebaseBaseUrl = "https://moj-dziennik-podrozy-default-rtdb.europe-west1.firebasedatabase.app";
    const urlParams = new URLSearchParams(window.location.search);
    const tripId = urlParams.get("tripId");
    const placeId = urlParams.get("placeId");
    const fromPage = urlParams.get("from");
    const isEditing = sessionStorage.getItem("isEditing") === "true";

    const backLink = document.getElementById("backLink");
    if (isEditing) {
        backLink.href = `trip.html?id=${tripId}&from=edit`;
    } else {
        backLink.href = `trip.html?id=${tripId}`;
    }
    
    const placeUrl = `${firebaseBaseUrl}/trips/${tripId}/places/${placeId}.json`;
    const map = L.map("place-map");
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

    fetch(placeUrl)
      .then(res => res.json())
      .then(place => {
        if (!place) {
          document.getElementById("place-content").innerHTML = "<p>❌ Miejsce nie istnieje.</p>";
          return;
        }

        let editButton = '';
        if (isEditing) {
            editButton = `<button onclick="editPlace('${placeId}')">✏️ Edytuj to miejsce</button>`;
        }

        document.getElementById("place-content").innerHTML = `
          <h1>${place.name}</h1>
          <p><strong>Kategoria:</strong> ${getCategoryLabel(place.category)}</p>
          <p><strong>Data:</strong> ${formatDate(place.date)}</p>
          <p>${place.description || ''}</p>
          ${editButton}
        `;
        
        if (place.image) {
          const img = document.createElement("img");
          img.src = place.image;
          img.className = "place-image";
          document.getElementById("place-content").appendChild(img);
        }

        if (place.lat && place.lng) {
          map.setView([place.lat, place.lng], 12);
          L.marker([place.lat, place.lng]).addTo(map).bindPopup(`<strong>${place.name}</strong>`).openPopup();
        }

        if (place.photos && place.photos.length > 0) {
          const gallery = document.getElementById("place-photos");
          place.photos.forEach(photo => {
            const item = document.createElement("div");
            item.className = "photo-item";
            item.innerHTML = `
              <img src="${photo.url}" alt="${photo.caption || ''}">
              <p>${photo.caption || ''}</p>
            `;
            gallery.appendChild(item);
          });
        }
      })
      .catch(err => {
        console.error("Błąd ładowania miejsca:", err);
        document.getElementById("place-content").innerHTML = "<p>❌ Nie udało się załadować miejsca.</p>";
      });

    // --- Funkcje pomocnicze ---
    function formatDate(dateStr) {
      if (!dateStr) return "Brak daty";
      const date = new Date(dateStr);
      return date.toLocaleDateString("pl-PL", { day: "numeric", month: "long", year: "numeric" });
    }

    function getCategoryLabel(category) {
      const categories = {
        "miasto": "🏙️ Miasto", "park": "🌳 Park", "zabytek": "🏛️ Zabytek",
        "muzeum": "🖼️ Muzeum", "hotel": "🏨 Hotel", "szczyt": "⛰️ Szczyt",
        "restauracja": "🍽️ Restauracja", "miejsce_widokowe": "🌄 Miejsce widokowe",
        "atrakcja_turystyczna": "🎯 Atrakcja turystyczna", "inny": "🔧 Inny"
      };
      return categories[category] || category;
    }

    window.showMessage = function(text) {
      document.getElementById("msgText").textContent = text;
      document.getElementById("msgModal").style.display = "flex";
    };

    window.closeMsgModal = function() {
      document.getElementById("msgModal").style.display = "none";
    };

    // To be implemented as part of trip.html logic, not this page.
    window.editPlace = function(id) {
        window.location.href = `trip.html?id=${tripId}&editPlaceId=${id}&from=edit`;
    };
  </script>
</body>
</html>
