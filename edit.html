<script>
Â  Â  const correctPassword = "sekret2025";
Â  Â  const firebaseBaseUrl = "https://moj-dziennik-podrozy-default-rtdb.europe-west1.firebasedatabase.app";
Â  Â  const tripsUrl = `${firebaseBaseUrl}/trips.json`;
Â  Â  let isAddingTrip = false;

Â  Â  function checkPassword() {
Â  Â  Â  const password = document.getElementById("editPassword").value;
Â  Â  Â  if (password === correctPassword) {
Â  Â  Â  Â  sessionStorage.setItem("isEditing", "true");
Â  Â  Â  Â  document.getElementById("authModal").style.display = "none";
Â  Â  Â  Â  document.getElementById("editContent").style.display = "block";
Â  Â  Â  Â  initEditApp();
Â  Â  Â  } else {
Â  Â  Â  Â  alert("âŒ BÅ‚Ä™dne hasÅ‚o!");
Â  Â  Â  }
Â  Â  }

Â  Â  if (sessionStorage.getItem("isEditing") === "true") {
Â  Â  Â  document.getElementById("authModal").style.display = "none";
Â  Â  Â  document.getElementById("editContent").style.display = "block";
Â  Â  Â  initEditApp();
Â  Â  }

Â  Â  function initEditApp() {
Â  Â  Â  const map = L.map("map").setView([54.5, -3.0], 6);
Â  Â  Â  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

Â  Â  Â  function loadTrips() {
Â  Â  Â  Â  fetch(tripsUrl)
Â  Â  Â  Â  Â  .then(res => res.json())
Â  Â  Â  Â  Â  .then(trips => {
Â  Â  Â  Â  Â  Â  map.eachLayer(l => { if (l instanceof L.Marker) map.removeLayer(l); });
Â  Â  Â  Â  Â  Â  if (!trips) return;
Â  Â  Â  Â  Â  Â  Object.keys(trips).forEach(key => {
Â  Â  Â  Â  Â  Â  Â  const t = trips[key];
Â  Â  Â  Â  Â  Â  Â  if (!t.lat || !t.lng) return;
Â  Â  Â  Â  Â  Â  Â  const m = L.marker([t.lat, t.lng]).addTo(map);
Â  Â  Â  Â  Â  Â  Â  m.bindPopup(`
Â  Â  Â  Â  Â  Â  Â  Â  <strong><a href="trip.html?id=${key}">${t.name}</a></strong><br>
Â  Â  Â  Â  Â  Â  Â  Â  ${t.description || ''}<br>
Â  Â  Â  Â  Â  Â  Â  Â  <img src="${t.image}" width="100"><br>
Â  Â  Â  Â  Â  Â  Â  Â  <small>${formatDate(t.dateFrom)} â€“ ${formatDate(t.dateTo)}</small><br><br>
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="editTrip('${key}', ${t.lat}, ${t.lng})">âœï¸ Edytuj</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="deleteTrip('${key}')">ğŸ—‘ï¸ UsuÅ„</button>
Â  Â  Â  Â  Â  Â  Â  `);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  .catch(err => {
Â  Â  Â  Â  Â  Â  console.error("BÅ‚Ä…d Å‚adowania wypraw:", err);
Â  Â  Â  Â  Â  Â  showMessage("BÅ‚Ä…d Å‚adowania wypraw.");
Â  Â  Â  Â  Â  });
Â  Â  Â  }

Â  Â  Â  loadTrips();

Â  Â  Â  document.getElementById("addTripBtn").addEventListener("click", function () {
Â  Â  Â  Â  if (isAddingTrip) {
Â  Â  Â  Â  Â  isAddingTrip = false;
Â  Â  Â  Â  Â  this.textContent = "â• Dodaj wyprawÄ™";
Â  Â  Â  Â  Â  this.style.background = "#4CAF50";
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  isAddingTrip = true;
Â  Â  Â  Â  Â  this.textContent = "ğŸ›‘ Anuluj";
Â  Â  Â  Â  Â  this.style.background = "#f44336";
Â  Â  Â  Â  }
Â  Â  Â  });

Â  Â  Â  map.on("click", function (e) {
Â  Â  Â  Â  if (isAddingTrip) {
Â  Â  Â  Â  Â  isAddingTrip = false;
Â  Â  Â  Â  Â  document.getElementById("addTripBtn").textContent = "â• Dodaj wyprawÄ™";
Â  Â  Â  Â  Â  document.getElementById("addTripBtn").style.background = "#4CAF50";
Â  Â  Â  Â  Â  openAddTripModal(e.latlng.lat, e.latlng.lng);
Â  Â  Â  Â  }
Â  Â  Â  });

Â  Â  Â  window.openAddTripModal = function(lat, lng) {
Â  Â  Â  Â  document.getElementById("tripForm").reset();
Â  Â  Â  Â  document.getElementById("tripId").value = "";
Â  Â  Â  Â  document.getElementById("tripLat").value = lat;
Â  Â  Â  Â  document.getElementById("tripLng").value = lng;
Â  Â  Â  Â  document.getElementById("tripModalTitle").textContent = "Dodaj nowÄ… wyprawÄ™";
Â  Â  Â  Â  document.getElementById("tripModal").style.display = "flex";
Â  Â  Â  };

Â  Â  Â  window.editTrip = function(id, lat, lng) {
Â  Â  Â  Â  fetch(`${firebaseBaseUrl}/trips/${id}.json`)
Â  Â  Â  Â  Â  .then(res => res.json())
Â  Â  Â  Â  Â  .then(trip => {
Â  Â  Â  Â  Â  Â  document.getElementById("tripName").value = trip.name;
Â  Â  Â  Â  Â  Â  document.getElementById("tripDescription").value = trip.description || '';
Â  Â  Â  Â  Â  Â  document.getElementById("tripImage").value = trip.image;
Â  Â  Â  Â  Â  Â  document.getElementById("tripDateFrom").value = trip.dateFrom || '';
Â  Â  Â  Â  Â  Â  document.getElementById("tripDateTo").value = trip.dateTo || '';
Â  Â  Â  Â  Â  Â  document.getElementById("tripLat").value = lat;
Â  Â  Â  Â  Â  Â  document.getElementById("tripLng").value = lng;
Â  Â  Â  Â  Â  Â  document.getElementById("tripId").value = id;

Â  Â  Â  Â  Â  Â  document.getElementById("tripModalTitle").textContent = "Edytuj wyprawÄ™";
Â  Â  Â  Â  Â  Â  document.getElementById("tripModal").style.display = "flex";
Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  .catch(err => {
Â  Â  Â  Â  Â  Â  console.error("BÅ‚Ä…d Å‚adowania wyprawy:", err);
Â  Â  Â  Â  Â  Â  showMessage("Nie udaÅ‚o siÄ™ zaÅ‚adowaÄ‡ wyprawy.");
Â  Â  Â  Â  Â  });
Â  Â  Â  };

Â  Â  Â  document.getElementById("tripForm").addEventListener("submit", async function(e) {
Â  Â  Â  Â  e.preventDefault();

Â  Â  Â  Â  const id = document.getElementById("tripId").value;
Â  Â  Â  Â  const isEdit = id !== "";

Â  Â  Â  Â  const tripData = {
Â  Â  Â  Â  Â  name: document.getElementById("tripName").value,
Â  Â  Â  Â  Â  description: document.getElementById("tripDescription").value,
Â  Â  Â  Â  Â  image: document.getElementById("tripImage").value,
Â  Â  Â  Â  Â  dateFrom: document.getElementById("tripDateFrom").value,
Â  Â  Â  Â  Â  dateTo: document.getElementById("tripDateTo").value,
Â  Â  Â  Â  Â  lat: parseFloat(document.getElementById("tripLat").value),
Â  Â  Â  Â  Â  lng: parseFloat(document.getElementById("tripLng").value)
Â  Â  Â  Â  };

Â  Â  Â  Â  if (isEdit) {
Â  Â  Â  Â  Â  const fetchUrl = `${firebaseBaseUrl}/trips/${id}.json`;
Â  Â  Â  Â  Â  fetch(fetchUrl, {
Â  Â  Â  Â  Â  Â  method: "PATCH",
Â  Â  Â  Â  Â  Â  body: JSON.stringify(tripData),
Â  Â  Â  Â  Â  Â  headers: { "Content-Type": "application/json" }
Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  .then(() => {
Â  Â  Â  Â  Â  Â  closeTripModal();
Â  Â  Â  Â  Â  Â  showMessage("âœ… Wyprawa zapisana!");
Â  Â  Â  Â  Â  Â  loadTrips();
Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  .catch(err => {
Â  Â  Â  Â  Â  Â  console.error("BÅ‚Ä…d zapisu:", err);
Â  Â  Â  Â  Â  Â  showMessage("Nie udaÅ‚o siÄ™ zapisaÄ‡ wyprawy.");
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  const newTripId = generateId(tripData.name);
Â  Â  Â  Â  Â  const fetchUrl = `${firebaseBaseUrl}/trips/${newTripId}.json`;
Â  Â  Â  Â  Â  fetch(fetchUrl, {
Â  Â  Â  Â  Â  Â  method: "PUT", // Zmieniono na PUT, aby uÅ¼yÄ‡ nazwy jako ID
Â  Â  Â  Â  Â  Â  body: JSON.stringify(tripData),
Â  Â  Â  Â  Â  Â  headers: { "Content-Type": "application/json" }
Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  .then(() => {
Â  Â  Â  Â  Â  Â  closeTripModal();
Â  Â  Â  Â  Â  Â  showMessage("âœ… Wyprawa zapisana!");
Â  Â  Â  Â  Â  Â  loadTrips();
Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  .catch(err => {
Â  Â  Â  Â  Â  Â  console.error("BÅ‚Ä…d zapisu:", err);
Â  Â  Â  Â  Â  Â  showMessage("Nie udaÅ‚o siÄ™ zapisaÄ‡ wyprawy.");
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  });

Â  Â  Â  function generateId(name) {
Â  Â  Â  Â  return name
Â  Â  Â  Â  Â  .toLowerCase()
Â  Â  Â  Â  Â  .trim()
Â  Â  Â  Â  Â  .normalize("NFD")
Â  Â  Â  Â  Â  .replace(/[\u0300-\u036f]/g, "")
Â  Â  Â  Â  Â  .replace(/[^a-z0-9]/g, "_")
Â  Â  Â  Â  Â  .replace(/_+/g, "_")
Â  Â  Â  Â  Â  .replace(/^_+|_+$/g, "");
Â  Â  Â  }

Â  Â  Â  window.closeTripModal = function() { document.getElementById("tripModal").style.display = "none"; };
Â  Â  Â  window.deleteTrip = function(tripId) {
Â  Â  Â  Â  if (confirm("Czy na pewno chcesz usunÄ…Ä‡ tÄ™ wyprawÄ™?")) {
Â  Â  Â  Â  Â  fetch(`${firebaseBaseUrl}/trips/${tripId}.json`, { method: "DELETE" })
Â  Â  Â  Â  Â  Â  .then(() => {
Â  Â  Â  Â  Â  Â  Â  showMessage("âœ… Wyprawa usuniÄ™ta!");
Â  Â  Â  Â  Â  Â  Â  loadTrips();
Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  .catch(err => {
Â  Â  Â  Â  Â  Â  Â  console.error("BÅ‚Ä…d usuwania:", err);
Â  Â  Â  Â  Â  Â  Â  showMessage("Nie udaÅ‚o siÄ™ usunÄ…Ä‡ wyprawy.");
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  };

Â  Â  Â  window.showMessage = function(text) {
Â  Â  Â  Â  const modal = document.getElementById("msgModal");
Â  Â  Â  Â  const msgText = document.getElementById("msgText");
Â  Â  Â  Â  msgText.textContent = text;
Â  Â  Â  Â  modal.style.display = "flex";
Â  Â  Â  };

Â  Â  Â  window.closeMsgModal = function() { document.getElementById("msgModal").style.display = "none"; };

Â  Â  Â  function formatDate(dateStr) {
Â  Â  Â  Â  if (!dateStr) return "";
Â  Â  Â  Â  const date = new Date(dateStr);
Â  Â  Â  Â  return date.toLocaleDateString("pl-PL", { day: "numeric", month: "long", year: "numeric" });
Â  Â  Â  }

Â  Â  Â  document.addEventListener("keydown", function(e) {
Â  Â  Â  Â  if (e.key === "Escape") {
Â  Â  Â  Â  Â  if (document.getElementById("tripModal").style.display === "flex") {
Â  Â  Â  Â  Â  Â  closeTripModal();
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  if (document.getElementById("msgModal").style.display === "flex") {
Â  Â  Â  Â  Â  Â  closeMsgModal();
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  const addTripBtn = document.getElementById("addTripBtn");
Â  Â  Â  Â  Â  if (addTripBtn && addTripBtn.textContent === "ğŸ›‘ Anuluj") {
Â  Â  Â  Â  Â  Â  addTripBtn.click();
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  }
</script>
