<!DOCTYPE html>
<html lang="pl">
<head>
Â  <meta charset="UTF-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
Â  <title>Edytuj wyprawy</title>
Â  <link rel="stylesheet" href="style.css" />
Â  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
Â  Â  <div id="authModal" class="modal" style="display: flex;">
Â  Â  <div class="modal-content">
Â  Â  Â  <h2>ğŸ” DostÄ™p do edycji</h2>
Â  Â  Â  <p>WprowadÅº hasÅ‚o, aby edytowaÄ‡.</p>
Â  Â  Â  <input type="password" id="editPassword" placeholder="HasÅ‚o">
Â  Â  Â  <button onclick="checkPassword()">WejdÅº</button>
Â  Â  </div>
Â  </div>

Â  Â  <div id="editContent" style="display: none;">
Â  Â  <div class="header-container right-top">
Â  Â  Â  <div class="header-box">Edycja wypraw</div>
Â  Â  Â  <button id="addTripBtn" class="add-btn">â• Dodaj wyprawÄ™</button>
Â  Â  </div>

Â  Â  <div id="map"></div>

Â  Â  Â  Â  <div id="tripModal" class="modal" style="display: none;">
Â  Â  Â  <div class="modal-content scrollable-modal">
Â  Â  Â  Â  <h2 id="tripModalTitle">Dodaj wyprawÄ™</h2>
Â  Â  Â  Â  <form id="tripForm">
Â  Â  Â  Â  Â  <input type="hidden" id="tripId">
Â  Â  Â  Â  Â  <input type="hidden" id="tripLat">
Â  Â  Â  Â  Â  <input type="hidden" id="tripLng">

Â  Â  Â  Â  Â  <label>Nazwa: <input type="text" id="tripName" required></label><br><br>
Â  Â  Â  Â  Â  <label>Opis: <textarea id="tripDescription" rows="2"></textarea></label><br><br>
Â  Â  Â  Â  Â  <label>ZdjÄ™cie (URL): <input type="url" id="tripImage" required></label><br><br>
Â  Â  Â  Â  Â  <label>Data od: <input type="date" id="tripDateFrom" required></label><br><br>
Â  Â  Â  Â  Â  <label>Data do: <input type="date" id="tripDateTo"></label><br><br>

Â  Â  Â  Â  Â  <button type="submit">Zapisz</button>
Â  Â  Â  Â  Â  <button type="button" onclick="closeTripModal()">Anuluj</button>
Â  Â  Â  Â  </form>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  Â  Â  <div id="msgModal" class="msg-modal" style="display: none;">
Â  Â  Â  <div class="msg-modal-content">
Â  Â  Â  Â  <p id="msgText"></p>
Â  Â  Â  Â  <button onclick="closeMsgModal()">OK</button>
Â  Â  Â  Â  <a href="index.html" class="button">WrÃ³Ä‡ do strony gÅ‚Ã³wnej</a>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  Â  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
Â  <script>
Â  Â  // ğŸ” Ustaw swoje hasÅ‚o
Â  Â  const correctPassword = "sekret2025";

Â  Â  function checkPassword() {
Â  Â  Â  const password = document.getElementById("editPassword").value;
Â  Â  Â  if (password === correctPassword) {
Â  Â  Â  Â  sessionStorage.setItem("isEditing", "true");
Â  Â  Â  Â  document.getElementById("authModal").style.display = "none";
Â  Â  Â  Â  document.getElementById("editContent").style.display = "block";
Â  Â  Â  Â  initEditApp();
Â  Â  Â  } else {
Â  Â  Â  Â  alert("âŒ BÅ‚Ä™dne hasÅ‚o!");
Â  Â  Â  }
Â  Â  }

Â  Â  if (sessionStorage.getItem("isEditing") === "true") {
Â  Â  Â  document.getElementById("authModal").style.display = "none";
Â  Â  Â  document.getElementById("editContent").style.display = "block";
Â  Â  Â  initEditApp();
Â  Â  }

Â  Â  function initEditApp() {
Â  Â  Â  const firebaseBaseUrl = "https://moj-dziennik-podrozy-default-rtdb.europe-west1.firebasedatabase.app";
Â  Â  Â  const tripsUrl = `${firebaseBaseUrl}/trips.json`;

Â  Â  Â  const map = L.map("map").setView([54.5, -3.0], 6);
Â  Â  Â  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

Â  Â  Â  let isAddingTrip = false;

Â  Â  Â  function loadTrips() {
Â  Â  Â  Â  fetch(tripsUrl)
Â  Â  Â  Â  Â  .then(res => res.json())
Â  Â  Â  Â  Â  .then(trips => {
Â  Â  Â  Â  Â  Â  map.eachLayer(l => { if (l instanceof L.Marker) map.removeLayer(l); });
Â  Â  Â  Â  Â  Â  if (!trips) return;
Â  Â  Â  Â  Â  Â  Object.keys(trips).forEach(key => {
Â  Â  Â  Â  Â  Â  Â  const t = trips[key];
Â  Â  Â  Â  Â  Â  Â  if (!t.lat || !t.lng) return;
Â  Â  Â  Â  Â  Â  Â  const m = L.marker([t.lat, t.lng]).addTo(map);
Â  Â  Â  Â  Â  Â  Â  m.bindPopup(`
Â  Â  Â  Â  Â  Â  Â  Â  <strong><a href="trip.html?id=${key}">${t.name}</a></strong><br>
Â  Â  Â  Â  Â  Â  Â  Â  ${t.description || ''}<br>
Â  Â  Â  Â  Â  Â  Â  Â  <img src="${t.image}" width="100"><br>
Â  Â  Â  Â  Â  Â  Â  Â  <small>${formatDate(t.dateFrom)} â€“ ${formatDate(t.dateTo)}</small><br><br>
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="editTrip('${key}', ${t.lat}, ${t.lng})">âœï¸ Edytuj</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="deleteTrip('${key}')">ğŸ—‘ï¸ UsuÅ„</button>
Â  Â  Â  Â  Â  Â  Â  `);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  .catch(err => {
Â  Â  Â  Â  Â  Â  console.error("BÅ‚Ä…d Å‚adowania wypraw:", err);
Â  Â  Â  Â  Â  Â  showMessage("BÅ‚Ä…d Å‚adowania wypraw.");
Â  Â  Â  Â  Â  });
Â  Â  Â  }

Â  Â  Â  loadTrips();

Â  Â  Â  document.getElementById("addTripBtn").addEventListener("click", function () {
Â  Â  Â  Â  if (isAddingTrip) {
Â  Â  Â  Â  Â  isAddingTrip = false;
Â  Â  Â  Â  Â  this.textContent = "â• Dodaj wyprawÄ™";
Â  Â  Â  Â  Â  this.style.background = "#4CAF50";
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  isAddingTrip = true;
Â  Â  Â  Â  Â  this.textContent = "ğŸ›‘ Anuluj";
Â  Â  Â  Â  Â  this.style.background = "#f44336";
Â  Â  Â  Â  }
Â  Â  Â  });

Â  Â  Â  map.on("click", function (e) {
Â  Â  Â  Â  if (isAddingTrip) {
Â  Â  Â  Â  Â  isAddingTrip = false;
Â  Â  Â  Â  Â  document.getElementById("addTripBtn").textContent = "â• Dodaj wyprawÄ™";
Â  Â  Â  Â  Â  document.getElementById("addTripBtn").style.background = "#4CAF50";
Â  Â  Â  Â  Â  openAddTripModal(e.latlng.lat, e.latlng.lng);
Â  Â  Â  Â  }
Â  Â  Â  });

Â  Â  Â  window.openAddTripModal = function(lat, lng) {
Â  Â  Â  Â  document.getElementById("tripForm").reset();
Â  Â  Â  Â  document.getElementById("tripId").value = "";
Â  Â  Â  Â  document.getElementById("tripLat").value = lat;
Â  Â  Â  Â  document.getElementById("tripLng").value = lng;
Â  Â  Â  Â  document.getElementById("tripModalTitle").textContent = "Dodaj nowÄ… wyprawÄ™";
Â  Â  Â  Â  document.getElementById("tripModal").style.display = "flex";
Â  Â  Â  };

Â  Â  Â  window.editTrip = function(id, lat, lng) {
Â  Â  Â  Â  fetch(`${firebaseBaseUrl}/trips/${id}.json`)
Â  Â  Â  Â  Â  .then(res => res.json())
Â  Â  Â  Â  Â  .then(trip => {
Â  Â  Â  Â  Â  Â  document.getElementById("tripName").value = trip.name;
Â  Â  Â  Â  Â  Â  document.getElementById("tripDescription").value = trip.description || '';
Â  Â  Â  Â  Â  Â  document.getElementById("tripImage").value = trip.image;
Â  Â  Â  Â  Â  Â  document.getElementById("tripDateFrom").value = trip.dateFrom || '';
Â  Â  Â  Â  Â  Â  document.getElementById("tripDateTo").value = trip.dateTo || '';
Â  Â  Â  Â  Â  Â  document.getElementById("tripLat").value = lat;
Â  Â  Â  Â  Â  Â  document.getElementById("tripLng").value = lng;
Â  Â  Â  Â  Â  Â  document.getElementById("tripId").value = id;

Â  Â  Â  Â  Â  Â  document.getElementById("tripModalTitle").textContent = "Edytuj wyprawÄ™";
Â  Â  Â  Â  Â  Â  document.getElementById("tripModal").style.display = "flex";
Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  .catch(err => {
Â  Â  Â  Â  Â  Â  console.error("BÅ‚Ä…d Å‚adowania wyprawy:", err);
Â  Â  Â  Â  Â  Â  showMessage("Nie udaÅ‚o siÄ™ zaÅ‚adowaÄ‡ wyprawy.");
Â  Â  Â  Â  Â  });
Â  Â  Â  };

Â  Â  Â  document.getElementById("tripForm").addEventListener("submit", async function(e) {
Â  Â  Â  Â  e.preventDefault();

Â  Â  Â  Â  const id = document.getElementById("tripId").value;
Â  Â  Â  Â  const isEdit = id !== "";

Â  Â  Â  Â  const tripData = {
Â  Â  Â  Â  Â  name: document.getElementById("tripName").value,
Â  Â  Â  Â  Â  description: document.getElementById("tripDescription").value,
Â  Â  Â  Â  Â  image: document.getElementById("tripImage").value,
Â  Â  Â  Â  Â  dateFrom: document.getElementById("tripDateFrom").value,
Â  Â  Â  Â  Â  dateTo: document.getElementById("tripDateTo").value,
Â  Â  Â  Â  Â  lat: parseFloat(document.getElementById("tripLat").value),
Â  Â  Â  Â  Â  lng: parseFloat(document.getElementById("tripLng").value)
Â  Â  Â  Â  };

Â  Â  Â  Â  let fetchUrl;
Â  Â  Â  Â  let fetchMethod;

Â  Â  Â  Â  if (isEdit) {
Â  Â  Â  Â  Â  // Edycja: uzyjemy metody PATCH
Â  Â  Â  Â  Â  fetchUrl = `${firebaseBaseUrl}/trips/${id}.json`;
Â  Â  Â  Â  Â  fetchMethod = "PATCH";
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  // Dodawanie: uzyjemy metody POST
Â  Â  Â  Â  Â  fetchUrl = tripsUrl;
Â  Â  Â  Â  Â  fetchMethod = "POST";
Â  Â  Â  Â  }

Â  Â  Â  Â  fetch(fetchUrl, {
Â  Â  Â  Â  Â  method: fetchMethod,
Â  Â  Â  Â  Â  body: JSON.stringify(tripData),
Â  Â  Â  Â  Â  headers: { "Content-Type": "application/json" }
Â  Â  Â  Â  })
Â  Â  Â  Â  .then(() => {
Â  Â  Â  Â  Â  closeTripModal();
Â  Â  Â  Â  Â  showMessage("âœ… Wyprawa zapisana!");
Â  Â  Â  Â  Â  loadTrips();
Â  Â  Â  Â  })
Â  Â  Â  Â  .catch(err => {
Â  Â  Â  Â  Â  console.error("BÅ‚Ä…d zapisu:", err);
Â  Â  Â  Â  Â  showMessage("Nie udaÅ‚o siÄ™ zapisaÄ‡ wyprawy.");
Â  Â  Â  Â  });
Â  Â  Â  });

Â  Â  Â  window.closeTripModal = function() {
Â  Â  Â  Â  document.getElementById("tripModal").style.display = "none";
Â  Â  Â  };

Â  Â  Â  window.deleteTrip = function(tripId) {
Â  Â  Â  Â  if (confirm("Czy na pewno chcesz usunÄ…Ä‡ tÄ™ wyprawÄ™?")) {
Â  Â  Â  Â  Â  fetch(`${firebaseBaseUrl}/trips/${tripId}.json`, { method: "DELETE" })
Â  Â  Â  Â  Â  Â  .then(() => {
Â  Â  Â  Â  Â  Â  Â  showMessage("âœ… Wyprawa usuniÄ™ta!");
Â  Â  Â  Â  Â  Â  Â  loadTrips();
Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  .catch(err => {
Â  Â  Â  Â  Â  Â  Â  console.error("BÅ‚Ä…d usuwania:", err);
Â  Â  Â  Â  Â  Â  Â  showMessage("Nie udaÅ‚o siÄ™ usunÄ…Ä‡ wyprawy.");
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  };

Â  Â  Â  window.showMessage = function(text) {
Â  Â  Â  Â  const modal = document.getElementById("msgModal");
Â  Â  Â  Â  const msgText = document.getElementById("msgText");
Â  Â  Â  Â  msgText.textContent = text;
Â  Â  Â  Â  modal.style.display = "flex";
Â  Â  Â  };

Â  Â  Â  window.closeMsgModal = function() {
Â  Â  Â  Â  document.getElementById("msgModal").style.display = "none";
Â  Â  Â  };

Â  Â  Â  function formatDate(dateStr) {
Â  Â  Â  Â  if (!dateStr) return "";
Â  Â  Â  Â  const date = new Date(dateStr);
Â  Â  Â  Â  return date.toLocaleDateString("pl-PL", { day: "numeric", month: "long", year: "numeric" });
Â  Â  Â  }

Â  Â  Â  // ObsÅ‚uga ESC
Â  Â  Â  document.addEventListener("keydown", function(e) {
Â  Â  Â  Â  if (e.key === "Escape") {
Â  Â  Â  Â  Â  if (document.getElementById("tripModal").style.display === "flex") {
Â  Â  Â  Â  Â  Â  closeTripModal();
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  if (document.getElementById("msgModal").style.display === "flex") {
Â  Â  Â  Â  Â  Â  closeMsgModal();
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  const addTripBtn = document.getElementById("addTripBtn");
Â  Â  Â  Â  Â  if (addTripBtn && addTripBtn.textContent === "ğŸ›‘ Anuluj") {
Â  Â  Â  Â  Â  Â  addTripBtn.click();
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  }
Â  </script>
</body>
</html>
