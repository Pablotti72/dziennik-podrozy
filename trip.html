<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Wyprawa</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" />
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>
  <div class="header-container right-top">
    <div class="header-box">Wyprawa</div>
    <button id="addPlaceBtn" class="add-btn" style="display: none;">â• Dodaj miejsce</button>
    <a id="backLink" class="back-link" href="#">â† WrÃ³Ä‡ do mapy</a>
  </div>

  <main class="place-page">
    <div class="trip-main-content">
      <div id="trip-map-container">
        <div id="trip-map"></div>
      </div>
      <div id="trip-info-and-places">
        <article id="trip-content">
          <p>Åadowanie wyprawy...</p>
        </article>
      </div>
    </div>
  </main>

  <div id="placeModal" class="modal" style="display: none;">
    <div class="modal-content scrollable-modal">
      <h2 id="placeModalTitle">Dodaj miejsce</h2>
      <form id="placeForm">
        <input type="hidden" id="placeId">
        <input type="hidden" id="placeLat">
        <input type="hidden" id="placeLng">
        <label>Nazwa: <input type="text" id="placeName" required></label><br>
        <label>Kategoria:
          <select id="placeCategory" required>
            <option value="miasto">ğŸ™ï¸ Miasto</option>
            <option value="park">ğŸŒ³ Park</option>
            <option value="zabytek">ğŸ›ï¸ Zabytek</option>
            <option value="muzeum">ğŸ–¼ï¸ Muzeum</option>
            <option value="hotel">ğŸ¨ Hotel</option>
            <option value="szczyt">â›°ï¸ Szczyt</option>
            <option value="restauracja">ğŸ½ï¸ Restauracja</option>
            <option value="miejsce_widokowe">ğŸŒ„ Miejsce widokowe</option>
            <option value="atrakcja_turystyczna">ğŸ¯ Atrakcja turystyczna</option>
            <option value="inny">ğŸ”§ Inny</option>
          </select>
        </label><br>
        <label>Data od: <input type="date" id="placeDateFrom"></label><br>
        <label>Data do: <input type="date" id="placeDateTo"></label><br>
        <label>Opis: <textarea id="placeDescription" rows="4"></textarea></label><br>
        
        <h3>Galeria zdjÄ™Ä‡</h3>
        <div id="photoList"></div>
        <button type="button" onclick="addPhotoField()">â• Dodaj zdjÄ™cie</button><br><br>

        <button type="submit">Zapisz</button>
        <button type="button" onclick="closePlaceModal()">Anuluj</button>
      </form>
    </div>
  </div>
  
  <div id="msgModal" class="msg-modal" style="display: none">
    <div class="msg-modal-content">
      <p id="msgText"></p>
      <button onclick="closeMsgModal()">OK</button>
    </div>
  </div>

  <div id="galleryModal" class="modal" style="display: none">
    <span class="gallery-close-btn" onclick="closeGalleryModal()">&times;</span>
    <img class="gallery-content" id="modalImage">
    <div class="gallery-caption" id="modalCaption"></div>
    <button class="gallery-nav-btn prev-btn" onclick="plusSlides(-1)">&#10094;</button>
    <button class="gallery-nav-btn next-btn" onclick="plusSlides(1)">&#10095;</button>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // Konfiguracja Firebase
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      databaseURL: "YOUR_DATABASE_URL",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    // --- Globalne zmienne i stan ---
    const urlParams = new URLSearchParams(window.location.search);
    const tripId = urlParams.get("id");
    const isEditing = sessionStorage.getItem("isEditing") === "true";
    let placeMarkers = {};
    let photosData = [];
    let slideIndex = 0;

    // --- Inicjalizacja UI ---
    const backLink = document.getElementById("backLink");
    const addPlaceBtn = document.getElementById("addPlaceBtn");
    
    backLink.href = isEditing ? `index.html` : `index.html`;
    addPlaceBtn.style.display = isEditing ? "block" : "none";

    // --- Mapa ---
    const map = L.map("trip-map").setView([52.2297, 21.0122], 6);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
    }).addTo(map);

    // --- Åadowanie danych wyprawy ---
    function loadTripData() {
      db.ref(`trips/${tripId}`).once('value', (snapshot) => {
        const trip = snapshot.val();
        if (trip) {
          displayTripInfo(trip);
          loadPlaces(trip.mainLat, trip.mainLng);
        } else {
          document.getElementById("trip-content").innerHTML = "Brak danych dla tej wyprawy.";
        }
      });
    }
    loadTripData();

    function displayTripInfo(trip) {
      document.querySelector(".header-box").textContent = `Wyprawa: ${trip.name}`;
      const tripContent = document.getElementById("trip-content");
      tripContent.innerHTML = `
        <h2>${trip.name}</h2>
        <p>${getCategoryLabel(trip.category)}</p>
        <p>${formatDate(trip.dateFrom)} ${trip.dateTo ? ' - ' + formatDate(trip.dateTo) : ''}</p>
        <img src="${trip.mainPhotoUrl || 'https://via.placeholder.com/300x200?text=Brak+zdj'}" alt="GÅ‚Ã³wne zdjÄ™cie wyprawy" style="width:100%; height:auto;">
        <p>${trip.description || "Brak opisu."}</p>
      `;
    }

    function loadPlaces(tripLat, tripLng) {
      db.ref(`trips/${tripId}/places`).on('value', (snapshot) => {
        const places = snapshot.val() || {};
        const placesList = document.getElementById("trip-info-and-places");
        let htmlContent = `<h3>Miejsca na trasie</h3>`;

        // UsuÅ„ wszystkie markery, aby uniknÄ…Ä‡ duplikatÃ³w
        for (const markerId in placeMarkers) {
          map.removeLayer(placeMarkers[markerId]);
        }
        placeMarkers = {};

        // StwÃ³rz listÄ™ miejsc
        Object.keys(places).forEach(placeId => {
          const place = places[placeId];
          htmlContent += `
            <div class="place-item">
              <h4>${place.name}</h4>
              <p>${getCategoryLabel(place.category)}</p>
              <p>${formatDate(place.dateFrom)} ${place.dateTo ? ' - ' + formatDate(place.dateTo) : ''}</p>
              ${isEditing ? `
                <button onclick="editPlace('${placeId}')">âœï¸ Edytuj</button>
                <button onclick="deletePlace('${placeId}')">ğŸ—‘ï¸ UsuÅ„</button>
              ` : ''}
              <a href="place.html?tripId=${tripId}&placeId=${placeId}" class="view-place-btn">Zobacz szczegÃ³Å‚y</a>
            </div>
          `;

          // Dodaj markery na mapie
          if (place.lat && place.lng) {
            const marker = L.marker([place.lat, place.lng]).addTo(map)
              .bindPopup(`<h4>${place.name}</h4><a href="place.html?tripId=${tripId}&placeId=${placeId}">Zobacz szczegÃ³Å‚y</a>`);
            placeMarkers[placeId] = marker;
          }
        });
        
        placesList.innerHTML = `<article id="trip-content"></article>${htmlContent}`;
        displayTripInfo(snapshot.val()); // Aktualizuj informacje o wyprawie
        
        // Dopasuj mapÄ™ do wszystkich znacznikÃ³w, jeÅ›li istniejÄ…
        if (Object.keys(placeMarkers).length > 0) {
          const group = new L.featureGroup(Object.values(placeMarkers));
          map.fitBounds(group.getBounds().pad(0.5));
        } else if (tripLat && tripLng) {
            map.setView([tripLat, tripLng], 12);
        }
      });
    }

    // --- Funkcje CRUD ---
    const placeForm = document.getElementById("placeForm");
    const addPlaceBtnEl = document.getElementById("addPlaceBtn");
    let isAddingMode = false;

    addPlaceBtnEl.addEventListener("click", () => {
      if (!isAddingMode) {
        isAddingMode = true;
        addPlaceBtnEl.textContent = "ğŸ›‘ Anuluj";
        addPlaceBtnEl.style.background = "#FFC107";
        showMessage("Kliknij na mapie, aby dodaÄ‡ miejsce.");
        map.on("click", onMapClick);
      } else {
        isAddingMode = false;
        addPlaceBtnEl.textContent = "â• Dodaj miejsce";
        addPlaceBtnEl.style.background = "#4CAF50";
        map.off("click", onMapClick);
        closeMsgModal();
      }
    });

    function onMapClick(e) {
      if (isAddingMode) {
        document.getElementById("placeId").value = "";
        placeForm.reset();
        document.getElementById("placeModalTitle").textContent = "Dodaj miejsce";
        document.getElementById("placeLat").value = e.latlng.lat;
        document.getElementById("placeLng").value = e.latlng.lng;
        document.getElementById("placeModal").style.display = "flex";
        addPlaceBtnEl.click(); // PrzeÅ‚Ä…cz tryb z powrotem na "Dodaj"
      }
    }

    placeForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const placeId = document.getElementById("placeId").value;
      const lat = document.getElementById("placeLat").value;
      const lng = document.getElementById("placeLng").value;
      const photos = Array.from(document.querySelectorAll("#photoList .photo-item")).map(item => ({
        url: item.querySelector(".photo-url").value,
        caption: item.querySelector(".photo-caption").value,
      }));

      const placeData = {
        name: document.getElementById("placeName").value,
        category: document.getElementById("placeCategory").value,
        description: document.getElementById("placeDescription").value,
        dateFrom: document.getElementById("placeDateFrom").value,
        dateTo: document.getElementById("placeDateTo").value,
        lat: parseFloat(lat),
        lng: parseFloat(lng),
        photos: photos,
      };

      if (placeId) {
        db.ref(`trips/${tripId}/places/${placeId}`).update(placeData)
          .then(() => {
            showMessage("âœ… Miejsce zaktualizowane!");
            closePlaceModal();
          })
          .catch(err => showMessage("âŒ BÅ‚Ä…d aktualizacji miejsca: " + err.message));
      } else {
        const newPlaceRef = db.ref(`trips/${tripId}/places`).push();
        newPlaceRef.set(placeData)
          .then(() => {
            showMessage("âœ… Miejsce dodane!");
            closePlaceModal();
            // Zaktualizuj gÅ‚Ã³wny punkt wyprawy, jeÅ›li to pierwsze miejsce
            db.ref(`trips/${tripId}`).once('value', snapshot => {
              if (!snapshot.val().mainLat) {
                db.ref(`trips/${tripId}`).update({
                  mainLat: parseFloat(lat),
                  mainLng: parseFloat(lng)
                });
              }
            });
          })
          .catch(err => showMessage("âŒ BÅ‚Ä…d dodawania miejsca: " + err.message));
      }
    });

    window.editPlace = function(placeId) {
      db.ref(`trips/${tripId}/places/${placeId}`).once('value', (snapshot) => {
        const place = snapshot.val();
        if (place) {
          document.getElementById("placeId").value = placeId;
          document.getElementById("placeModalTitle").textContent = "Edytuj miejsce";
          document.getElementById("placeName").value = place.name;
          document.getElementById("placeCategory").value = place.category;
          document.getElementById("placeDescription").value = place.description;
          document.getElementById("placeDateFrom").value = place.dateFrom;
          document.getElementById("placeDateTo").value = place.dateTo;
          document.getElementById("placeLat").value = place.lat;
          document.getElementById("placeLng").value = place.lng;
          
          const photoList = document.getElementById("photoList");
          photoList.innerHTML = "";
          (place.photos || []).forEach(photo => addPhotoField(photo.url, photo.caption));
          
          document.getElementById("placeModal").style.display = "flex";
        }
      });
    };

    window.deletePlace = function(placeId) {
      if (confirm("Czy na pewno chcesz usunÄ…Ä‡ to miejsce?")) {
        db.ref(`trips/${tripId}/places/${placeId}`).remove()
          .then(() => showMessage("âœ… Miejsce usuniÄ™te!"))
          .catch(err => showMessage("âŒ BÅ‚Ä…d usuwania miejsca: " + err.message));
      }
    };
    
    // --- Funkcje pomocnicze ---
    window.addPhotoField = function(url = '', caption = '') {
      const container = document.getElementById("photoList");
      const item = document.createElement("div");
      item.className = "photo-item";
      item.innerHTML = `
        <label>URL zdjÄ™cia: <input type="url" class="photo-url" value="${url}" placeholder="https://..."></label><br>
        <label>Komentarz: <input type="text" class="photo-caption" value="${caption}" placeholder="Opis zdjÄ™cia"></label><br><br>
      `;
      container.appendChild(item);
    };

    function formatDate(dateStr) {
      if (!dateStr) return "";
      const date = new Date(dateStr);
      return date.toLocaleDateString("pl-PL", {
        day: "numeric",
        month: "long",
        year: "numeric",
      });
    }

    function getCategoryLabel(category) {
      const categories = {
        miasto: "ğŸ™ï¸ Miasto",
        park: "ğŸŒ³ Park",
        zabytek: "ğŸ›ï¸ Zabytek",
        muzeum: "ğŸ–¼ï¸ Muzeum",
        hotel: "ğŸ¨ Hotel",
        szczyt: "â›°ï¸ Szczyt",
        restauracja: "ğŸ½ï¸ Restauracja",
        miejsce_widokowe: "ğŸŒ„ Miejsce widokowe",
        atrakcja_turystyczna: "ğŸ¯ Atrakcja turystyczna",
        inny: "ğŸ”§ Inny",
      };
      return categories[category] || category;
    }

    window.closePlaceModal = function() { document.getElementById("placeModal").style.display = "none"; };
    window.showMessage = function (text) {
      document.getElementById("msgText").textContent = text;
      document.getElementById("msgModal").style.display = "flex";
    };
    window.closeMsgModal = function () {
      document.getElementById("msgModal").style.display = "none";
    };

    document.addEventListener("keydown", function(e) {
      if (e.key === "Escape") {
        document.getElementById("placeModal").style.display = "none";
        document.getElementById("msgModal").style.display = "none";
      }
    });
  </script>
</body>
</html>