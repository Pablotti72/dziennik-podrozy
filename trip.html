<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Wyprawa</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
  <div class="header-container right-top">
    <div class="header-box">Wyprawa</div>
    <button id="addPlaceBtn" class="add-btn" style="display: none;">‚ûï Dodaj miejsce</button>
  </div>

  <div class="back-link">
    <a id="backLink" href="index.html">‚Üê Wr√≥ƒá do mapy</a>
  </div>

  <main class="place-page">
    <article id="trip-content">
      <p>≈Åadowanie wyprawy...</p>
    </article>
    <div id="trip-map"></div>
  </main>

  <!-- Modal do dodawania/edycji miejsca -->
  <div id="placeModal" class="modal" style="display: none;">
    <div class="modal-content scrollable-modal">
      <h2 id="placeModalTitle">Dodaj miejsce</h2>
      <form id="placeForm">
        <input type="hidden" id="placeId">
        <input type="hidden" id="placeLat">
        <input type="hidden" id="placeLng">
        <input type="hidden" id="originalPlaceId">

        <label>Nazwa: <input type="text" id="placeName" required></label><br><br>
        <label>Data wizyty: <input type="date" id="placeDate"></label><br><br>
        <label>Kategoria:
          <select id="placeCategory">
            <option value="miasto">üèôÔ∏è Miasto</option>
            <option value="park">üå≥ Park</option>
            <option value="zabytek">üèõÔ∏è Zabytek</option>
            <option value="muzeum">üñºÔ∏è Muzeum</option>
            <option value="hotel">üè® Hotel</option>
            <option value="szczyt">‚õ∞Ô∏è Szczyt</option>
            <option value="restauracja">üçΩÔ∏è Restauracja</option>
            <option value="miejsce_widokowe">üåÑ Miejsce widokowe</option>
            <option value="atrakcja_turystyczna">üéØ Atrakcja turystyczna</option>
            <option value="inny">üîß Inny</option>
          </select>
        </label><br><br>
        <label>Opis: <textarea id="placeDescription" rows="4" placeholder="Kr√≥tki opis miejsca..."></textarea></label><br><br>

        <div id="photos-container">
          <!-- Dynamically added photo fields here -->
        </div>
        <button type="button" onclick="window.addPhotoField()">‚ûï Dodaj kolejne zdjƒôcie</button><br><br>

        <div id="placeActions">
          <button type="submit">Zapisz</button>
          <button type="button" onclick="window.closePlaceModal()">Anuluj</button>
          <button type="button" id="deletePlaceBtn" class="delete-btn" style="display: none;">Usu≈Ñ</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal do wy≈õwietlania wiadomo≈õci -->
  <div id="msgModal" class="msg-modal" style="display: none;">
    <div class="msg-modal-content">
      <p id="msgText"></p>
      <button onclick="closeMsgModal()">OK</button>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script type="module">
    // --- Imports from Firebase ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, doc, getDoc, addDoc, updateDoc, deleteDoc, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- Global variables provided by the environment ---
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const authToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // --- Firebase Initialization ---
    let app, db, auth, userId;
    let map, placesLayer;
    let isEditMode = false;
    let tripId;

    async function initializeFirebase() {
        if (Object.keys(firebaseConfig).length === 0) {
            console.error("Firebase config is missing. Data persistence will not work.");
            return;
        }
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            if (authToken) {
                await signInWithCustomToken(auth, authToken);
            } else {
                await signInAnonymously(auth);
            }
            userId = auth.currentUser.uid;
            console.log("Firebase initialized successfully. User ID:", userId);
            
            // Start listening for trip data
            await setupTripListener();

        } catch (error) {
            console.error("Firebase initialization failed:", error);
            showMessage("Nie uda≈Ço siƒô po≈ÇƒÖczyƒá z bazƒÖ danych.");
        }
    }

    // Initialize Leaflet map
    function initializeMap() {
      map = L.map('trip-map').setView([52.0, 19.0], 6);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);
      placesLayer = L.layerGroup().addTo(map);
    }

    function getTripIdFromUrl() {
        const params = new URLSearchParams(window.location.search);
        return params.get('id');
    }

    async function setupTripListener() {
        tripId = getTripIdFromUrl();
        if (!tripId) {
            document.getElementById('trip-content').innerHTML = "<p>‚ùå Brak identyfikatora wyprawy.</p>";
            return;
        }

        const tripDocRef = doc(db, `artifacts/${appId}/public/data/trips`, tripId);
        onSnapshot(tripDocRef, (docSnap) => {
            if (docSnap.exists()) {
                const tripData = docSnap.data();
                displayTripInfo(tripData);
                checkAuthStatus();
            } else {
                document.getElementById('trip-content').innerHTML = "<p>‚ùå Wyprawa nie istnieje.</p>";
            }
        }, (error) => {
            console.error("B≈ÇƒÖd ≈Çadowania wyprawy:", error);
            document.getElementById('trip-content').innerHTML = "<p>‚ùå Nie uda≈Ço siƒô za≈Çadowaƒá wyprawy.</p>";
        });

        // Listen for places associated with this trip
        const placesCollectionRef = collection(db, `artifacts/${appId}/public/data/places`);
        const q = query(placesCollectionRef, where("tripId", "==", tripId));
        onSnapshot(q, (snapshot) => {
            const places = [];
            snapshot.forEach(doc => {
                places.push({ id: doc.id, ...doc.data() });
            });
            updatePlacesOnMap(places);
        }, (error) => {
            console.error("B≈ÇƒÖd ≈Çadowania miejsc:", error);
            showMessage("Nie uda≈Ço siƒô za≈Çadowaƒá listy miejsc.");
        });
    }

    function checkAuthStatus() {
        // Here you would check if the user is authenticated and authorized to edit
        // For this example, we'll just check if a user is logged in
        if (auth.currentUser) {
            isEditMode = true; // Simplified edit mode check
            document.getElementById('addPlaceBtn').style.display = 'block';
        }
    }

    function displayTripInfo(tripData) {
        const tripContent = document.getElementById('trip-content');
        tripContent.innerHTML = `
            <h1>${tripData.name}</h1>
            <p><b>Daty:</b> ${formatDate(tripData.startDate)} - ${formatDate(tripData.endDate)}</p>
            <p>${tripData.description || ''}</p>
        `;
        if (tripData.imageUrl) {
            tripContent.innerHTML += `<img src="${tripData.imageUrl}" alt="${tripData.name}" class="trip-image">`;
        }
    }

    function updatePlacesOnMap(places) {
        placesLayer.clearLayers();
        if (places.length > 0) {
            const bounds = L.latLngBounds(places.map(p => [p.latitude, p.longitude]));
            map.fitBounds(bounds, { padding: [50, 50] });
        }

        places.forEach(place => {
            const marker = L.marker([place.latitude, place.longitude]).addTo(placesLayer);
            const popupContent = `
                <b>${place.name}</b><br>
                ${place.date ? formatDate(place.date) : ''}<br>
                ${place.category ? getCategoryLabel(place.category) : ''}<br><br>
                <a href="place.html?id=${place.id}">Szczeg√≥≈Çy miejsca</a>
            `;
            marker.bindPopup(popupContent);

            if (isEditMode) {
              const editBtn = document.createElement('button');
              editBtn.textContent = 'Edytuj';
              editBtn.classList.add('action-btn');
              editBtn.onclick = () => window.editPlace(place);
              
              const deleteBtn = document.createElement('button');
              deleteBtn.textContent = 'Usu≈Ñ';
              deleteBtn.classList.add('action-btn', 'delete-btn');
              deleteBtn.onclick = () => window.deletePlace(place.id);
              
              const popupDiv = document.createElement('div');
              popupDiv.innerHTML = popupContent;
              popupDiv.appendChild(editBtn);
              popupDiv.appendChild(deleteBtn);
              
              marker.setPopupContent(popupDiv);
            }
        });
    }

    // --- Funkcje UI i obs≈Çugi danych ---
    window.openPlaceModal = function() {
      document.getElementById('placeModalTitle').textContent = 'Dodaj miejsce';
      document.getElementById('placeForm').reset();
      document.getElementById('placeId').value = '';
      document.getElementById('photos-container').innerHTML = '';
      document.getElementById('deletePlaceBtn').style.display = 'none';
      document.getElementById('placeModal').style.display = 'flex';
      
      const addBtn = document.getElementById('addPlaceBtn');
      addBtn.textContent = 'üõë Anuluj';
      addBtn.onclick = function() { window.closePlaceModal(); addBtn.textContent = '‚ûï Dodaj miejsce'; addBtn.onclick = window.openPlaceModal; };
    };

    window.editPlace = function(place) {
      document.getElementById('placeModalTitle').textContent = 'Edytuj miejsce';
      document.getElementById('placeId').value = place.id;
      document.getElementById('placeName').value = place.name;
      document.getElementById('placeDate').value = place.date || '';
      document.getElementById('placeCategory').value = place.category || 'inny';
      document.getElementById('placeDescription').value = place.description || '';
      document.getElementById('photos-container').innerHTML = '';
      
      if (place.photos && place.photos.length > 0) {
        place.photos.forEach(photo => {
          addPhotoField(photo.url, photo.caption);
        });
      }

      document.getElementById('deletePlaceBtn').style.display = 'block';
      document.getElementById('placeModal').style.display = 'flex';
    };

    window.deletePlace = async function(placeId) {
      const confirmed = confirm("Czy na pewno chcesz usunƒÖƒá to miejsce?");
      if (!confirmed) return;

      try {
        await deleteDoc(doc(db, `artifacts/${appId}/public/data/places`, placeId));
        showMessage('Miejsce zosta≈Ço usuniƒôte.');
      } catch (e) {
        console.error("B≈ÇƒÖd podczas usuwania miejsca:", e);
        showMessage("Nie uda≈Ço siƒô usunƒÖƒá miejsca.");
      }
      closePlaceModal();
    };

    window.addPhotoField = function(url = '', caption = '') {
      const container = document.getElementById("photos-container");
      const item = document.createElement("div");
      item.className = "photo-item";
      item.innerHTML = `
        <label>Zdjƒôcie URL: <input type="url" class="photo-url" placeholder="https://" value="${url}"></label><br>
        <label>Komentarz: <input type="text" class="photo-caption" placeholder="Opis zdjƒôcia" value="${caption}"></label><br><br>
      `;
      container.appendChild(item);
    };

    window.closePlaceModal = function() {
      document.getElementById("placeModal").style.display = "none";
    };

    window.closeMsgModal = function() {
      document.getElementById("msgModal").style.display = "none";
    };

    window.showMessage = function(text) {
      document.getElementById("msgText").textContent = text;
      document.getElementById("msgModal").style.display = "flex";
    };

    document.getElementById('addPlaceBtn').addEventListener('click', window.openPlaceModal);
    
    document.getElementById('placeForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const placeId = document.getElementById('placeId').value;
      const photos = Array.from(document.querySelectorAll('.photo-item')).map(item => ({
        url: item.querySelector('.photo-url').value,
        caption: item.querySelector('.photo-caption').value
      })).filter(p => p.url);
      
      const placeData = {
        name: document.getElementById('placeName').value,
        date: document.getElementById('placeDate').value,
        category: document.getElementById('placeCategory').value,
        description: document.getElementById('placeDescription').value,
        photos: photos,
        tripId: tripId,
        latitude: map.getCenter().lat,
        longitude: map.getCenter().lng,
        creatorId: userId
      };

      try {
        if (placeId) {
          await updateDoc(doc(db, `artifacts/${appId}/public/data/places`, placeId), placeData);
          showMessage('Miejsce zosta≈Ço zaktualizowane!');
        } else {
          await addDoc(collection(db, `artifacts/${appId}/public/data/places`), placeData);
          showMessage('Nowe miejsce zosta≈Ço dodane!');
        }
      } catch (e) {
        console.error("B≈ÇƒÖd zapisu danych:", e);
        showMessage("Nie uda≈Ço siƒô zapisaƒá miejsca.");
      }
      closePlaceModal();
    });

    function formatDate(dateStr) {
      return dateStr ? new Date(dateStr).toLocaleDateString("pl-PL", { day: "numeric", month: "long", year: "numeric" }) : "Brak daty";
    }

    function getCategoryLabel(category) {
      const categories = {
        "miasto": "üèôÔ∏è Miasto", "park": "üå≥ Park", "zabytek": "üèõÔ∏è Zabytek",
        "muzeum": "üñºÔ∏è Muzeum", "hotel": "üè® Hotel", "szczyt": "‚õ∞Ô∏è Szczyt",
        "restauracja": "üçΩÔ∏è Restauracja", "miejsce_widokowe": "üåÑ Miejsce widokowe",
        "atrakcja_turystyczna": "üéØ Atrakcja turystyczna", "inny": "üîß Inny"
      };
      return categories[category] || category;
    }

    // Obs≈Çuga klawisza ESC
    document.addEventListener("keydown", function(e) {
      if (e.key === "Escape") {
        document.getElementById("placeModal").style.display = "none";
        document.getElementById("msgModal").style.display = "none";
        const addBtn = document.getElementById("addPlaceBtn");
        if (addBtn && addBtn.textContent === "üõë Anuluj") {
          addBtn.textContent = '‚ûï Dodaj miejsce';
          addBtn.onclick = window.openPlaceModal;
        }
      }
    });

    document.addEventListener("DOMContentLoaded", () => {
        initializeMap();
        initializeFirebase();
    });
  </script>
</body>
</html>
