<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Wyprawa</title>
  
  <!-- Upewnij siÄ™, Å¼e masz poÅ‚Ä…czone arkusze stylÃ³w -->
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIINfBI87S29mo4o1z7ck8O+OGsBfuL2I36="
        crossorigin=""/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css"/>
</head>
<body>

  <!-- NagÅ‚Ã³wek i przyciski -->
  <div class="header-container right-top">
    <div class="header-box">Wyprawa</div>
    <button id="addPlaceBtn" class="add-btn" style="display: none;">â• Dodaj miejsce</button>
  </div>

  <!-- Link powrotny -->
  <div class="back-link">
    <a id="backLink" href="index.html">â† WrÃ³Ä‡ do mapy</a>
  </div>

  <!-- GÅ‚Ã³wna zawartoÅ›Ä‡ strony -->
  <main class="place-page">
    <article id="trip-content">
      <p>Åadowanie wyprawy...</p>
    </article>
    <div id="trip-map"></div>
  </main>

  <!-- Modal do dodawania/edycji miejsca -->
  <div id="placeModal" class="modal" style="display: none;">
    <div class="modal-content scrollable-modal">
      <h2 id="placeModalTitle">Dodaj miejsce</h2>
      <form id="placeForm">
        <input type="hidden" id="placeId">
        <input type="hidden" id="placeLat">
        <input type="hidden" id="placeLng">
        <input type="hidden" id="originalPlaceId">

        <label>Nazwa: <input type="text" id="placeName" required placeholder="Nazwa miejsca"></label>
        <label>Kategoria:
          <select id="placeCategory" required>
            <option value="miasto">ğŸ™ï¸ Miasto</option>
            <option value="park">ğŸŒ³ Park</option>
            <option value="zabytek">ğŸ›ï¸ Zabytek</option>
            <option value="muzeum">ğŸ–¼ï¸ Muzeum</option>
            <option value="hotel">ğŸ¨ Hotel</option>
            <option value="szczyt">â›°ï¸ Szczyt</option>
            <option value="restauracja">ğŸ½ï¸ Restauracja</option>
            <option value="miejsce_widokowe">ğŸŒ„ Miejsce widokowe</option>
            <option value="atrakcja_turystyczna">ğŸ¯ Atrakcja turystyczna</option>
            <option value="inny">ğŸ”§ Inny</option>
          </select>
        </label>
        <label>Data odwiedzenia: <input type="date" id="placeDate"></label>
        <label>Opis: <textarea id="placeDescription" placeholder="Opisz to miejsce..."></textarea></label>

        <!-- Galeria zdjÄ™Ä‡ -->
        <h3>Galeria zdjÄ™Ä‡</h3>
        <div id="photos-container">
          <div class="photo-item">
            <label>ZdjÄ™cie URL: <input type="url" class="photo-url" placeholder="https://..."></label><br>
            <label>Komentarz: <input type="text" class="photo-caption" placeholder="Opis zdjÄ™cia"></label><br><br>
          </div>
        </div>
        <button type="button" onclick="addPhotoField()">â• Dodaj kolejne zdjÄ™cie</button><br><br>

        <button type="submit" id="savePlaceBtn">Zapisz</button>
        <button type="button" onclick="closePlaceModal()">Anuluj</button>
        <button type="button" id="deletePlaceBtn" class="delete-btn" style="display: none;">ğŸ—‘ï¸ UsuÅ„</button>
      </form>
    </div>
  </div>

  <!-- Modal do wyÅ›wietlania wiadomoÅ›ci -->
  <div id="msgModal" class="msg-modal" style="display: none;">
    <div class="msg-modal-content">
      <p id="msgText"></p>
      <button onclick="closeMsgModal()">OK</button>
    </div>
  </div>

  <!-- Skrypty zewnÄ™trzne -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-200Jg9u/aD2p8d5x2jJd4Xp2GjE4C4uWd4uR5uW9A9Y="
          crossorigin=""></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js"></script>
  
  <script>
    // Konfiguracja Firebase (wymagana do dziaÅ‚ania)
    const firebaseConfig = {
      databaseURL: "https://moj-dziennik-podrozy-default-rtdb.europe-west1.firebasedatabase.app/",
    };
    const app = firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    
    let map = null;
    let markers = [];
    let currentTripId = null;
    let currentTripData = null;
    let editMode = false;
    let tempPlaceMarker = null;

    // --- Funkcje gÅ‚Ã³wne ---

    window.onload = function() {
      // Pobranie ID wyprawy z adresu URL
      const urlParams = new URLSearchParams(window.location.search);
      currentTripId = urlParams.get('id');
      const fromEdit = urlParams.get('from') === 'edit';

      // Ustawienie trybu edycji na podstawie URL
      if (fromEdit) {
        editMode = true;
        document.getElementById('addPlaceBtn').style.display = 'block';
      }

      // Ustawienie linku powrotnego
      document.getElementById('backLink').href = fromEdit ? 'index.html?mode=edit' : 'index.html';

      if (currentTripId) {
        loadTripAndPlaces();
      } else {
        document.getElementById('trip-content').innerHTML = '<p>âŒ Brak ID wyprawy w adresie URL.</p>';
        showMessage('Brak ID wyprawy. WrÃ³Ä‡ do strony gÅ‚Ã³wnej.');
      }
    };

    /**
     * Inicjalizuje mapÄ™ Leaflet.
     * @param {number} lat SzerokoÅ›Ä‡ geograficzna.
     * @param {number} lng DÅ‚ugoÅ›Ä‡ geograficzna.
     */
    function initMap(lat, lng) {
      if (map) {
        map.remove();
      }
      map = L.map('trip-map').setView([lat, lng], 6);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);

      // ObsÅ‚uga trybu edycji
      if (editMode) {
        map.on('click', onMapClick);
      }
    }

    /**
     * Pobiera dane wyprawy i miejsc z Firebase.
     */
    function loadTripAndPlaces() {
      const tripRef = database.ref(`trips/${currentTripId}`);
      tripRef.once('value')
        .then(snapshot => {
          const trip = snapshot.val();
          if (!trip) {
            document.getElementById('trip-content').innerHTML = '<p>âŒ Nie znaleziono wyprawy.</p>';
            return;
          }
          currentTripData = trip;
          document.title = `Wyprawa: ${trip.name}`;

          // Bezpieczne Å‚adowanie mapy - tutaj jest kluczowa poprawka!
          const defaultCoords = { lat: 52.23, lng: 21.01 }; // DomyÅ›lne koordynaty dla Polski
          const mapCoords = trip.coords || defaultCoords;
          initMap(mapCoords.lat, mapCoords.lng);

          displayTripDetails(trip);
          displayPlaces(trip.places || {});
        })
        .catch(err => {
          console.error("BÅ‚Ä…d Å‚adowania wyprawy:", err);
          showMessage('Nie udaÅ‚o siÄ™ zaÅ‚adowaÄ‡ wyprawy.');
        });
    }

    /**
     * WyÅ›wietla szczegÃ³Å‚y wyprawy.
     * @param {object} trip Dane wyprawy.
     */
    function displayTripDetails(trip) {
      const content = document.getElementById('trip-content');
      content.innerHTML = `
        <h1>${trip.name}</h1>
        <p><strong>Okres:</strong> ${formatDate(trip.startDate)} - ${formatDate(trip.endDate)}</p>
        <p><strong>Opis:</strong> ${trip.description || 'Brak opisu.'}</p>
        <hr>
        <h2>Odwiedzone miejsca:</h2>
        <div id="places-list"></div>
      `;
    }

    /**
     * WyÅ›wietla listÄ™ miejsc i dodaje markery do mapy.
     * @param {object} places Miejsca w danej wyprawie.
     */
    function displayPlaces(places) {
      const listContainer = document.getElementById('places-list');
      listContainer.innerHTML = '';
      if (Object.keys(places).length === 0) {
        listContainer.innerHTML = '<p class="no-content-message">Brak dodanych miejsc.</p>';
      }

      // UsuÅ„ stare markery przed dodaniem nowych
      markers.forEach(marker => map.removeLayer(marker));
      markers = [];

      Object.entries(places).forEach(([key, place]) => {
        const item = document.createElement('div');
        item.className = 'place-item';
        item.innerHTML = `
          <div class="place-icon">${getCategoryLabel(place.category).split(' ')[0]}</div>
          <div class="place-details">
            <h3><a href="place.html?tripId=${currentTripId}&placeId=${key}">${place.name}</a></h3>
            <p><strong>Kategoria:</strong> ${getCategoryLabel(place.category)}</p>
            <p><strong>Data:</strong> ${formatDate(place.date)}</p>
          </div>
        `;
        listContainer.appendChild(item);

        // Dodawanie markera do mapy
        if (place.coords && place.coords.lat && place.coords.lng) {
          const marker = L.marker([place.coords.lat, place.coords.lng]).addTo(map);
          marker.bindPopup(`
            <h4>${place.name}</h4>
            <p>${getCategoryLabel(place.category)}</p>
            <a href="place.html?tripId=${currentTripId}&placeId=${key}" class="popup-link">Zobacz szczegÃ³Å‚y</a>
          `);
          markers.push(marker);

          // ObsÅ‚uga trybu edycji dla markerÃ³w
          if (editMode) {
            marker.on('click', () => {
              openPlaceModal(key, place);
            });
          }
        }
      });
    }

    /**
     * Otwiera modal do dodawania nowego miejsca.
     */
    window.openNewPlaceModal = function() {
      document.getElementById('placeModalTitle').textContent = 'Dodaj nowe miejsce';
      document.getElementById('placeForm').reset();
      document.getElementById('placeId').value = '';
      document.getElementById('deletePlaceBtn').style.display = 'none';
      document.getElementById('placeModal').style.display = 'flex';
      
      // UsuÅ„ tymczasowy marker, jeÅ›li istniaÅ‚
      if (tempPlaceMarker) {
        map.removeLayer(tempPlaceMarker);
        tempPlaceMarker = null;
      }
    };
    
    /**
     * ObsÅ‚uga klikniÄ™cia na mapÄ™ w trybie edycji.
     * @param {object} e Zdarzenie klikniÄ™cia.
     */
    function onMapClick(e) {
      if (editMode) {
        if (tempPlaceMarker) {
          map.removeLayer(tempPlaceMarker);
        }
        tempPlaceMarker = L.marker(e.latlng).addTo(map);
        document.getElementById('placeLat').value = e.latlng.lat;
        document.getElementById('placeLng').value = e.latlng.lng;
        openNewPlaceModal();
      }
    }

    /**
     * Otwiera modal do edycji istniejÄ…cego miejsca.
     * @param {string} key Klucz miejsca.
     * @param {object} placeData Dane miejsca.
     */
    function openPlaceModal(key, placeData) {
      document.getElementById('placeModalTitle').textContent = 'Edytuj miejsce';
      document.getElementById('placeForm').reset();
      document.getElementById('placeId').value = key;
      document.getElementById('placeName').value = placeData.name || '';
      document.getElementById('placeCategory').value = placeData.category || 'inny';
      document.getElementById('placeDate').value = placeData.date || '';
      document.getElementById('placeDescription').value = placeData.description || '';
      document.getElementById('placeLat').value = placeData.coords.lat;
      document.getElementById('placeLng').value = placeData.coords.lng;
      document.getElementById('deletePlaceBtn').style.display = 'inline-block';
      document.getElementById('placeModal').style.display = 'flex';

      // WypeÅ‚nij pola zdjÄ™Ä‡
      const photosContainer = document.getElementById('photos-container');
      photosContainer.innerHTML = '';
      const photos = placeData.photos || [];
      if (photos.length > 0) {
          photos.forEach(photo => {
              const item = document.createElement('div');
              item.className = 'photo-item';
              item.innerHTML = `
                  <label>ZdjÄ™cie URL: <input type="url" class="photo-url" value="${photo.url || ''}" placeholder="https://..."></label><br>
                  <label>Komentarz: <input type="text" class="photo-caption" value="${photo.caption || ''}" placeholder="Opis zdjÄ™cia"></label><br><br>
              `;
              photosContainer.appendChild(item);
          });
      } else {
          // Dodaj puste pole, jeÅ›li brak zdjÄ™Ä‡
          addPhotoField();
      }
    }
    window.openPlaceModal = openPlaceModal;

    // ObsÅ‚uga formularza
    document.getElementById('placeForm').addEventListener('submit', function(e) {
      e.preventDefault();
      savePlace();
    });

    // Funkcja do dodawania pola na zdjÄ™cie
    window.addPhotoField = function() {
      const container = document.getElementById("photos-container");
      const item = document.createElement("div");
      item.className = "photo-item";
      item.innerHTML = `
        <label>ZdjÄ™cie URL: <input type="url" class="photo-url" placeholder="https://..."></label><br>
        <label>Komentarz: <input type="text" class="photo-caption" placeholder="Opis zdjÄ™cia"></label><br><br>
      `;
      container.appendChild(item);
    };

    /**
     * Zapisuje lub aktualizuje miejsce w Firebase.
     */
    function savePlace() {
      const placeId = document.getElementById('placeId').value || generateId(document.getElementById('placeName').value);
      const placeLat = parseFloat(document.getElementById('placeLat').value);
      const placeLng = parseFloat(document.getElementById('placeLng').value);
      
      const photos = [];
      document.querySelectorAll('#photos-container .photo-item').forEach(item => {
        const url = item.querySelector('.photo-url').value;
        const caption = item.querySelector('.photo-caption').value;
        if (url.trim() !== '') {
          photos.push({ url, caption });
        }
      });
      
      const newPlaceData = {
        name: document.getElementById('placeName').value,
        category: document.getElementById('placeCategory').value,
        date: document.getElementById('placeDate').value,
        description: document.getElementById('placeDescription').value,
        coords: { lat: placeLat, lng: placeLng },
        photos: photos
      };
      
      const placeRef = database.ref(`trips/${currentTripId}/places/${placeId}`);
      placeRef.set(newPlaceData)
        .then(() => {
          showMessage('Miejsce zostaÅ‚o zapisane!');
          closePlaceModal();
          loadTripAndPlaces();
        })
        .catch(err => {
          console.error("BÅ‚Ä…d zapisywania miejsca:", err);
          showMessage('Nie udaÅ‚o siÄ™ zapisaÄ‡ miejsca.');
        });
    }

    // ObsÅ‚uga przycisku "UsuÅ„"
    document.getElementById('deletePlaceBtn').addEventListener('click', function() {
      const placeId = document.getElementById('placeId').value;
      if (confirm('Czy na pewno chcesz usunÄ…Ä‡ to miejsce?')) {
        database.ref(`trips/${currentTripId}/places/${placeId}`).remove()
          .then(() => {
            showMessage('Miejsce zostaÅ‚o usuniÄ™te.');
            closePlaceModal();
            loadTripAndPlaces();
          })
          .catch(err => {
            console.error("BÅ‚Ä…d usuwania miejsca:", err);
            showMessage('Nie udaÅ‚o siÄ™ usunÄ…Ä‡ miejsca.');
          });
      }
    });

    /**
     * Generuje unikalne ID na podstawie nazwy.
     * @param {string} name Nazwa do konwersji.
     * @returns {string} Wygenerowane ID.
     */
    function generateId(name) {
      return name
        .toLowerCase()
        .trim()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/[^a-z0-9]/g, "_")
        .replace(/_+/g, "_")
        .replace(/^_+|_+$/g, "");
    }

    /**
     * Formatuje datÄ™.
     * @param {string} dateStr Data w formacie ISO.
     * @returns {string} Sformatowana data.
     */
    function formatDate(dateStr) {
      return dateStr ? new Date(dateStr).toLocaleDateString("pl-PL", { day: "numeric", month: "long", year: "numeric" }) : "Brak daty";
    }

    /**
     * Zwraca etykietÄ™ kategorii z emoji.
     * @param {string} category Kategoria.
     * @returns {string} Etykieta.
     */
    function getCategoryLabel(category) {
      const categories = {
        "miasto": "ğŸ™ï¸ Miasto", "park": "ğŸŒ³ Park", "zabytek": "ğŸ›ï¸ Zabytek",
        "muzeum": "ğŸ–¼ï¸ Muzeum", "hotel": "ğŸ¨ Hotel", "szczyt": "â›°ï¸ Szczyt",
        "restauracja": "ğŸ½ï¸ Restauracja", "miejsce_widokowe": "ğŸŒ„ Miejsce widokowe",
        "atrakcja_turystyczna": "ğŸ¯ Atrakcja turystyczna", "inny": "ğŸ”§ Inny"
      };
      return categories[category] || category;
    }

    // --- ObsÅ‚uga UI i modalÃ³w ---

    window.closePlaceModal = function() {
      document.getElementById('placeModal').style.display = 'none';
      // UsuÅ„ tymczasowy marker po zamkniÄ™ciu modala
      if (tempPlaceMarker) {
        map.removeLayer(tempPlaceMarker);
        tempPlaceMarker = null;
      }
    };
    
    window.closeMsgModal = function() {
      document.getElementById('msgModal').style.display = 'none';
    };

    window.showMessage = function(text) {
      document.getElementById("msgText").textContent = text;
      document.getElementById("msgModal").style.display = "flex";
    };

    // NasÅ‚uch na klawisz ESC
    document.addEventListener("keydown", function(e) {
      if (e.key === "Escape") {
        if (document.getElementById("placeModal").style.display === "flex") {
          closePlaceModal();
        }
        if (document.getElementById("msgModal").style.display === "flex") {
          closeMsgModal();
        }
      }
    });

    // Przycisk "Dodaj miejsce"
    document.getElementById('addPlaceBtn').addEventListener('click', function() {
      showMessage('Kliknij na mapie, aby dodaÄ‡ miejsce.');
    });
  </script>
</body>
</html>
