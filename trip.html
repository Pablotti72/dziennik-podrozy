<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Wyprawa</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
  <div class="header-container right-top">
    <div class="header-box">Wyprawa</div>
    <button id="addPlaceBtn" class="add-btn" style="display: none;">➕ Dodaj miejsce</button>
    <a id="backLink" class="back-link" href="index.html">← Wróć do mapy</a>
  </div>

  <main class="trip-page">
    <div class="trip-main-content">
      <div id="trip-map-container">
        <div id="trip-map"></div>
      </div>
      <div id="trip-info-and-places">
        <article id="trip-content">
          <p>Ładowanie wyprawy...</p>
        </article>
      </div>
    </div>
  </main>

  <div id="placeModal" class="modal" style="display: none;">
    <div class="modal-content scrollable-modal">
      <h2 id="placeModalTitle">Dodaj miejsce</h2>
      <form id="placeForm">
        <input type="hidden" id="placeId">
        <input type="hidden" id="originalPlaceId">
        <input type="hidden" id="placeLat">
        <input type="hidden" id="placeLng">
        <label>Nazwa: <input type="text" id="placeName" required></label><br><br>
        <label>Kategoria:
          <select id="placeCategory">
            <option value="miasto">🏙️ Miasto</option>
            <option value="park">🌳 Park</option>
            <option value="zabytek">🏛️ Zabytek</option>
            <option value="muzeum">🖼️ Muzeum</option>
            <option value="hotel">🏨 Hotel</option>
            <option value="szczyt">⛰️ Szczyt</option>
            <option value="restauracja">🍽️ Restauracja</option>
            <option value="miejsce_widokowe">🌄 Miejsce widokowe</option>
            <option value="atrakcja_turystyczna">🎯 Atrakcja turystyczna</option>
            <option value="inny">🔧 Inny</option>
          </select>
        </label><br><br>
        <label>Opis: <textarea id="placeDescription" rows="3"></textarea></label><br><br>
        <label>Zdjęcie główne (URL): <input type="url" id="placeImage"></label><br><br>
        <div id="photo-inputs-container">
          <h4>Galeria zdjęć</h4>
          <div class="photo-input">
            <label>URL: <input type="url" class="photo-url" placeholder="https://..."></label><br>
            <label>Komentarz: <input type="text" class="photo-caption" placeholder="Opis zdjęcia"></label><br><br>
          </div>
        </div>
        <button type="button" onclick="addPhotoInput()">➕ Dodaj kolejne zdjęcie</button><br><br>
        
        <button type="submit">Zapisz</button>
        <button type="button" onclick="closePlaceModal()">Anuluj</button>
      </form>
    </div>
  </div>

  <div id="msgModal" class="msg-modal" style="display: none;">
    <div class="msg-modal-content">
      <p id="msgText"></p>
      <button onclick="closeMsgModal()">OK</button>
    </div>
  </div>

  <div id="galleryModal" class="gallery-modal" style="display: none;">
    <span class="gallery-close-btn" onclick="closeGalleryModal()">&times;</span>
    <img id="modalImage" class="gallery-modal-content">
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const firebaseBaseUrl = "https://moj-dziennik-podrozy-default-rtdb.europe-west1.firebasedatabase.app";
    const tripId = new URLSearchParams(window.location.search).get("id");
    const map = L.map("trip-map", {
      center: [52.237, 21.017],
      zoom: 6,
    });
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

    let isEditing = sessionStorage.getItem("isEditing") === "true";
    let markers = {};

    document.getElementById("backLink").href = "index.html";

    if (isEditing) {
      document.getElementById("addPlaceBtn").style.display = "block";
    }

    // --- Ładowanie i wyświetlanie danych ---
    function loadTripAndPlaces() {
      if (!tripId) {
        showMessage("❌ Błąd: Nieprawidłowy ID wyprawy.");
        return;
      }
      
      // Ładowanie danych wyprawy
      fetch(`${firebaseBaseUrl}/trips/${tripId}.json`)
        .then(res => res.json())
        .then(trip => {
          if (trip) {
            document.getElementById("trip-content").innerHTML = `
              <h1>${trip.name}</h1>
              <p>📅 ${formatDate(trip.dateFrom)} ${trip.dateTo ? ' - ' + formatDate(trip.dateTo) : ''}</p>
              <img src="${trip.image}" alt="Zdjęcie główne" class="main-image" onerror="this.onerror=null;this.src='https://placehold.co/600x400/818181/fff?text=Brak+zdj%C4%99cia'" onclick="showMainImageModal(this.src)">
              <p class="description-text">${trip.description || ''}</p>
            `;
            if (trip.lat && trip.lng) {
              map.setView([trip.lat, trip.lng], 12);
            }
          } else {
            document.getElementById("trip-content").innerHTML = "<p>Nie znaleziono wyprawy.</p>";
          }
        })
        .catch(err => {
          console.error("Błąd ładowania wyprawy:", err);
          showMessage("❌ Nie udało się załadować danych wyprawy.");
        });

      // Ładowanie danych miejsc
      fetch(`${firebaseBaseUrl}/trips/${tripId}/places.json`)
        .then(res => res.json())
        .then(places => {
          Object.values(markers).forEach(marker => map.removeLayer(marker));
          markers = {};
          
          if (places) {
            document.getElementById("trip-info-and-places").innerHTML += "<h2>Miejsca na trasie</h2><div id='places-list'></div>";
            Object.keys(places).forEach(key => {
              const place = places[key];
              const placeElement = document.createElement("div");
              placeElement.className = "place-item";
              placeElement.innerHTML = `
                <h3>${getCategoryLabel(place.category)} ${place.name}</h3>
                <p>${place.description || 'Brak opisu.'}</p>
                <div class="place-actions">
                  ${isEditing ? `
                    <button onclick="editPlace('${key}')">✏️ Edytuj</button>
                    <button onclick="deletePlace('${key}')">🗑️ Usuń</button>
                  ` : ''}
                </div>
              `;
              document.getElementById("places-list").appendChild(placeElement);

              if (place.lat && place.lng) {
                const marker = L.marker([place.lat, place.lng]).addTo(map);
                marker.bindPopup(`<strong>${place.name}</strong><br>${place.description || ''}`);
                marker.on('click', () => {
                  placeElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                  marker.openPopup();
                });
                markers[key] = marker;
              }
            });
          }
        })
        .catch(err => {
          console.error("Błąd ładowania miejsc:", err);
          showMessage("❌ Nie udało się załadować listy miejsc.");
        });
    }

    // --- Logika edycji ---
    document.getElementById("addPlaceBtn").addEventListener("click", function () {
      if (document.getElementById("addPlaceBtn").textContent === "➕ Dodaj miejsce") {
        map.on("click", onMapClick);
        showMessage("🗺️ Kliknij na mapie, aby zaznaczyć miejsce!");
        document.getElementById("addPlaceBtn").textContent = "🛑 Anuluj";
      } else {
        map.off("click", onMapClick);
        document.getElementById("addPlaceBtn").textContent = "➕ Dodaj miejsce";
        closeMsgModal();
      }
    });

    function onMapClick(e) {
      map.off("click", onMapClick);
      document.getElementById("placeLat").value = e.latlng.lat;
      document.getElementById("placeLng").value = e.latlng.lng;
      openPlaceModal();
      document.getElementById("addPlaceBtn").textContent = "➕ Dodaj miejsce";
      closeMsgModal();
    }

    window.openPlaceModal = function() {
      document.getElementById("placeForm").reset();
      document.getElementById("placeId").value = "";
      document.getElementById("originalPlaceId").value = "";
      document.getElementById("placeModalTitle").textContent = "Dodaj nowe miejsce";
      document.getElementById("photo-inputs-container").innerHTML = `
        <h4>Galeria zdjęć</h4>
        <div class="photo-input">
            <label>URL: <input type="url" class="photo-url" placeholder="https://..."></label><br>
            <label>Komentarz: <input type="text" class="photo-caption" placeholder="Opis zdjęcia"></label><br><br>
        </div>
      `;
      document.getElementById("placeModal").style.display = "flex";
    };

    window.editPlace = function(id) {
      fetch(`${firebaseBaseUrl}/trips/${tripId}/places/${id}.json`)
        .then(res => res.json())
        .then(place => {
          if (place) {
            document.getElementById("placeId").value = id;
            document.getElementById("originalPlaceId").value = id;
            document.getElementById("placeName").value = place.name;
            document.getElementById("placeCategory").value = place.category;
            document.getElementById("placeDescription").value = place.description || '';
            document.getElementById("placeImage").value = place.image || '';

            const photosContainer = document.getElementById("photo-inputs-container");
            photosContainer.innerHTML = '<h4>Galeria zdjęć</h4>';
            if (place.photos && place.photos.length > 0) {
              place.photos.forEach(photo => {
                const item = document.createElement("div");
                item.className = "photo-input";
                item.innerHTML = `
                  <label>URL: <input type="url" class="photo-url" value="${photo.url}"></label><br>
                  <label>Komentarz: <input type="text" class="photo-caption" value="${photo.caption || ''}"></label><br><br>
                `;
                photosContainer.appendChild(item);
              });
            } else {
                addPhotoInput();
            }

            document.getElementById("placeModalTitle").textContent = "Edytuj miejsce";
            document.getElementById("placeModal").style.display = "flex";
          }
        });
    };

    document.getElementById("placeForm").addEventListener("submit", async function(e) {
      e.preventDefault();

      const placeId = document.getElementById("placeId").value;
      const isEdit = placeId !== "";
      const newId = generateId(document.getElementById("placeName").value);
      const originalId = document.getElementById("originalPlaceId").value;

      const photoInputs = document.querySelectorAll(".photo-input");
      const photos = [];
      photoInputs.forEach(input => {
        const url = input.querySelector(".photo-url").value;
        const caption = input.querySelector(".photo-caption").value;
        if (url) {
          photos.push({ url, caption });
        }
      });
      
      const placeData = {
        name: document.getElementById("placeName").value,
        category: document.getElementById("placeCategory").value,
        description: document.getElementById("placeDescription").value,
        image: document.getElementById("placeImage").value,
        lat: parseFloat(document.getElementById("placeLat").value),
        lng: parseFloat(document.getElementById("placeLng").value),
        photos: photos
      };

      try {
        if (isEdit) {
            if (originalId && originalId !== newId) {
                // Zmiana nazwy - utwórz nowy wpis i usuń stary
                await fetch(`${firebaseBaseUrl}/trips/${tripId}/places/${newId}.json`, {
                    method: "PUT",
                    body: JSON.stringify(placeData),
                    headers: { "Content-Type": "application/json" }
                });
                await fetch(`${firebaseBaseUrl}/trips/${tripId}/places/${originalId}.json`, { method: "DELETE" });
            } else {
                // Brak zmiany nazwy lub brak oryginalnego ID - zaktualizuj istniejący
                await fetch(`${firebaseBaseUrl}/trips/${tripId}/places/${newId}.json`, {
                    method: "PATCH",
                    body: JSON.stringify(placeData),
                    headers: { "Content-Type": "application/json" }
                });
            }
        } else {
            // Nowe miejsce
            await fetch(`${firebaseBaseUrl}/trips/${tripId}/places/${newId}.json`, {
                method: "PUT",
                body: JSON.stringify(placeData),
                headers: { "Content-Type": "application/json" }
            });
        }
        closePlaceModal();
        showMessage("✅ Zapisano!");
        loadTripAndPlaces();
      } catch(err) {
        console.error("Błąd zapisu:", err);
        showMessage("❌ Nie udało się zapisać.");
      }
    });

    window.deletePlace = function(id) {
      if (confirm("Czy na pewno chcesz usunąć to miejsce?")) {
        fetch(`${firebaseBaseUrl}/trips/${tripId}/places/${id}.json`, { method: "DELETE" })
          .then(() => {
            showMessage("✅ Usunięto!");
            loadTripAndPlaces();
          })
          .catch(err => {
            console.error("Błąd usuwania:", err);
            showMessage("❌ Nie udało się usunąć miejsca.");
          });
      }
    };

    function generateId(name) {
      return name
        .toLowerCase()
        .trim()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/[^a-z0-9]/g, "_")
        .replace(/_+/g, "_")
        .replace(/^_+|_+$/g, "");
    }

    // --- Obsługa UI i modalów ---
    window.addPhotoInput = function() {
      const container = document.getElementById("photo-inputs-container");
      const item = document.createElement("div");
      item.className = "photo-input";
      item.innerHTML = `
        <label>URL: <input type="url" class="photo-url" placeholder="https://..."></label><br>
        <label>Komentarz: <input type="text" class="photo-caption" placeholder="Opis zdjęcia"></label><br><br>
      `;
      container.appendChild(item);
    };

    window.closePlaceModal = function() { document.getElementById("placeModal").style.display = "none"; };
    window.closeMsgModal = function() { document.getElementById("msgModal").style.display = "none"; };
    window.showMessage = function(text) { document.getElementById("msgText").textContent = text; document.getElementById("msgModal").style.display = "flex"; };
    
    // Obsługa nowo dodanego modala
    window.showMainImageModal = function(imageUrl) {
      const modal = document.getElementById("galleryModal");
      const modalImage = document.getElementById("modalImage");
      modalImage.src = imageUrl;
      modal.style.display = "flex";
    };
    
    window.closeGalleryModal = function() {
      document.getElementById("galleryModal").style.display = "none";
    };

    function formatDate(dateStr) {
      if (!dateStr) return "Brak daty";
      const date = new Date(dateStr);
      return date.toLocaleDateString("pl-PL", {
        day: "numeric",
        month: "long",
        year: "numeric",
      });
    }

    function getCategoryLabel(category) {
      const categories = {
        miasto: "🏙️ Miasto",
        park: "🌳 Park",
        zabytek: "🏛️ Zabytek",
        muzeum: "🖼️ Muzeum",
        hotel: "🏨 Hotel",
        szczyt: "⛰️ Szczyt",
        restauracja: "🍽️ Restauracja",
        miejsce_widokowe: "🌄 Miejsce widokowe",
        atrakcja_turystyczna: "🎯 Atrakcja turystyczna",
        inny: "🔧 Inny",
      };
      return categories[category] || category;
    }

    document.addEventListener("keydown", function(e) {
      if (e.key === "Escape") {
        document.getElementById("placeModal").style.display = "none";
        document.getElementById("msgModal").style.display = "none";
        document.getElementById("galleryModal").style.display = "none";
        const addBtn = document.getElementById("addPlaceBtn");
        if (addBtn && addBtn.textContent === "🛑 Anuluj") {
          addBtn.click();
        }
      }
    });

    loadTripAndPlaces();
  </script>
</body>
</html>
