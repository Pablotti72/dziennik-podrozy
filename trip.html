document.getElementById("placeForm").addEventListener("submit", async function(e) {
  e.preventDefault();

  const id = document.getElementById("placeId").value;
  const isEdit = id !== "";

  const photos = [];
  document.querySelectorAll(".photo-url").forEach((input, i) => {
    if (input.value.trim() !== "") {
      photos.push({
        url: input.value.trim(),
        caption: document.querySelectorAll(".photo-caption")[i]?.value.trim() || ""
      });
    }
  });

  const placeData = {
    name: document.getElementById("placeName").value,
    description: document.getElementById("placeDescription").value,
    image: document.getElementById("placeImage").value,
    category: document.getElementById("placeCategory").value,
    date: document.getElementById("placeDate").value,
    lat: parseFloat(document.getElementById("placeLat").value),
    lng: parseFloat(document.getElementById("placeLng").value),
    photos: photos,
  };

  if (isEdit) {
    const originalId = document.getElementById("originalPlaceId").value;
    const newId = generateId(placeData.name);

    if (originalId !== newId) {
      const oldRef = firebase.database().ref(`trips/${tripId}/places/${originalId}`);
      const newRef = firebase.database().ref(`trips/${tripId}/places/${newId}`);
      try {
        const oldPlaceSnapshot = await oldRef.once('value');
        if (oldPlaceSnapshot.exists()) {
          await newRef.set({...oldPlaceSnapshot.val(), ...placeData});
          await oldRef.remove();
          closePlaceModal();
          showMessage("✅ Zmieniono nazwę i zapisano miejsce!");
          loadTripAndPlaces();
          return;
        }
      } catch (err) {
        console.error("Błąd zmiany nazwy miejsca:", err);
        showMessage("❌ Nie udało się zmienić nazwy miejsca.");
        return;
      }
    }
    firebase.database().ref(`trips/${tripId}/places/${id}`).update(placeData)
    .then(() => {
      closePlaceModal();
      showMessage("✅ Zapisano!");
      loadTripAndPlaces();
    })
    .catch(err => {
      console.error("Błąd zapisu:", err);
      showMessage("❌ Nie udało się zapisać.");
    });
  } else {
    const newPlaceId = generateId(placeData.name);
    firebase.database().ref(`trips/${tripId}/places/${newPlaceId}`).set(placeData)
    .then(() => {
      closePlaceModal();
      showMessage("✅ Zapisano!");
      loadTripAndPlaces();
    })
    .catch(err => {
      console.error("Błąd zapisu:", err);
      showMessage("❌ Nie udało się zapisać.");
    });
  }
});