<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Galeria miejsc</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>

  <!-- Przycisk powrotu -->
  <div class="gallery-container">
    <a href="index.html" class="back-to-map">â† WrÃ³Ä‡ do mapy</a>
    <h1 id="galleryTitle">Åadowanie galerii...</h1>
  </div>

  <!-- Grid zdjÄ™Ä‡ -->
  <div class="gallery-container">
    <div id="photoGrid" class="photo-grid">
      <!-- ZdjÄ™cia zostanÄ… zaÅ‚adowane dynamicznie -->
    </div>
  </div>

  <!-- Lightbox -->
  <div id="lightbox" class="lightbox">
    <button class="lightbox-close" onclick="closeLightbox()">&times;</button>
    <div class="lightbox-content">
      <button class="lightbox-nav lightbox-prev" onclick="prevPhoto()">&#10094;</button>
      <img id="lightboxImage" class="lightbox-image" src="" alt="PeÅ‚ne zdjÄ™cie">
      <p id="lightboxCaption" class="lightbox-caption"></p>
      <button class="lightbox-nav lightbox-next" onclick="nextPhoto()">&#10095;</button>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const firebaseBaseUrl = "https://moj-dziennik-podrozy-default-rtdb.europe-west1.firebasedatabase.app";
    const tripsUrl = `${firebaseBaseUrl}/trips.json`;

    const urlParams = new URLSearchParams(window.location.search);
    const type = urlParams.get("type"); // country lub category
    const value = urlParams.get("value");

    const photoGrid = document.getElementById("photoGrid");
    const galleryTitle = document.getElementById("galleryTitle");
    const lightbox = document.getElementById("lightbox");
    const lightboxImage = document.getElementById("lightboxImage");
    const lightboxCaption = document.getElementById("lightboxCaption");

    let allPhotos = []; // Wszystkie zdjÄ™cia pasujÄ…ce do filtra
    let currentPhotoIndex = 0;

    // Ustaw tytuÅ‚
    if (type === "country") {
      galleryTitle.textContent = `Miejsca w kraju: ${decodeURIComponent(value)}`;
    } else if (type === "category") {
      galleryTitle.textContent = `Miejsca w kategorii: ${getCategoryLabel(decodeURIComponent(value))}`;
    }

    // ZaÅ‚aduj dane
    fetch(tripsUrl)
      .then(res => res.json())
      .then(trips => {
        if (!trips) return;

        allPhotos = [];

        Object.values(trips).forEach(trip => {
          if (trip.places) {
            Object.values(trip.places).forEach(place => {
              if ((type === "country" && place.country === value) ||
                  (type === "category" && place.category === value)) {

                if (place.photos && place.photos.length > 0) {
                  place.photos.forEach(photo => {
                    allPhotos.push({
                      url: photo.url,
                      caption: photo.caption || `ZdjÄ™cie z ${place.name}`,
                      placeName: place.name,
                      date: place.date
                    });
                  });
                } else if (place.image) {
                  allPhotos.push({
                    url: place.image,
                    caption: `ZdjÄ™cie gÅ‚Ã³wne z ${place.name}`,
                    placeName: place.name,
                    date: place.date
                  });
                }
              }
            });
          }
        });

        renderGallery();
      })
      .catch(err => {
        console.error("BÅ‚Ä…d Å‚adowania galerii:", err);
        photoGrid.innerHTML = "<p>âŒ Nie udaÅ‚o siÄ™ zaÅ‚adowaÄ‡ zdjÄ™Ä‡.</p>";
      });

    function renderGallery() {
      photoGrid.innerHTML = "";
      if (allPhotos.length === 0) {
        photoGrid.innerHTML = "<p>Brak zdjÄ™Ä‡ do wyÅ›wietlenia.</p>";
        return;
      }

      allPhotos.forEach((photo, index) => {
        const item = document.createElement("div");
        item.className = "photo-item";
        item.onclick = () => openLightbox(index);
        item.innerHTML = `
          <img src="${photo.url}" alt="ZdjÄ™cie z ${photo.placeName}">
          <div class="photo-caption">
            <strong>${photo.placeName}</strong><br>
            ${formatDate(photo.date) || 'Bez daty'}
          </div>
        `;
        photoGrid.appendChild(item);
      });
    }

    // Lightbox
    function openLightbox(index) {
      currentPhotoIndex = index;
      updateLightbox();
      lightbox.style.display = "flex";
      document.body.style.overflow = "hidden";
    }

    function closeLightbox() {
      lightbox.style.display = "none";
      document.body.style.overflow = "";
    }

    function updateLightbox() {
      const photo = allPhotos[currentPhotoIndex];
      lightboxImage.src = photo.url;
      lightboxCaption.textContent = `${photo.placeName} â€¢ ${formatDate(photo.date) || 'Bez daty'}${photo.caption ? ' â€“ ' + photo.caption : ''}`;
    }

    function nextPhoto() {
      currentPhotoIndex = (currentPhotoIndex + 1) % allPhotos.length;
      updateLightbox();
    }

    function prevPhoto() {
      currentPhotoIndex = (currentPhotoIndex - 1 + allPhotos.length) % allPhotos.length;
      updateLightbox();
    }

    // ObsÅ‚uga klawiatury
    document.addEventListener("keydown", e => {
      if (lightbox.style.display === "flex") {
        if (e.key === "ArrowRight") nextPhoto();
        if (e.key === "ArrowLeft") prevPhoto();
        if (e.key === "Escape") closeLightbox();
      }
    });

    // Pomocnicze funkcje
    function formatDate(dateStr) {
      return dateStr ? new Date(dateStr).toLocaleDateString("pl-PL") : "";
    }

    function getCategoryLabel(category) {
      const labels = {
        miasto: "ğŸ™ï¸ Miasto",
        park: "ğŸŒ³ Park",
        zabytek: "ğŸ›ï¸ Zabytek",
        muzeum: "ğŸ–¼ï¸ Muzeum",
        hotel: "ğŸ¨ Hotel",
        szczyt: "â›°ï¸ Szczyt",
        restauracja: "ğŸ½ï¸ Restauracja",
        miejsce_widokowe: "ğŸŒ„ Miejsce widokowe",
        atrakcja_turystyczna: "ğŸ¯ Atrakcja turystyczna",
        inny: "ğŸ”§ Inny"
      };
      return labels[category] || category;
    }
  </script>
</body>
</html>