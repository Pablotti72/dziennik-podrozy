<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Galeria</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>

  <div class="back-link">
    <a href="index.html">‚Üê Wr√≥ƒá do mapy</a>
  </div>

  <main class="gallery-page">
    <h1 id="gallery-title"></h1>
    <div id="gallery-grid" class="photo-gallery">
      <p>≈Åadowanie zdjƒôƒá...</p>
    </div>
  </main>

  <div id="lightbox" class="lightbox" style="display: none;">
    <span class="close-btn" onclick="closeLightbox()">&times;</span>
    <span class="nav-btn prev" onclick="navigatePhotos(-1)">&#10094;</span>
    <img id="lightbox-image" src="" alt="">
    <span class="nav-btn next" onclick="navigatePhotos(1)">&#10095;</span>
    <div id="lightbox-caption" class="lightbox-caption"></div>
  </div>

  <div id="msgModal" class="msg-modal" style="display: none;">
    <div class="msg-modal-content">
      <p id="msgText"></p>
      <button onclick="closeMsgModal()">OK</button>
    </div>
  </div>

  <script>
    const firebaseBaseUrl = "https://moj-dziennik-podrozy-default-rtdb.europe-west1.firebasedatabase.app";
    const tripsUrl = `${firebaseBaseUrl}/trips.json`;
    const urlParams = new URLSearchParams(window.location.search);
    const countryParam = urlParams.get("country");
    const categoryParam = urlParams.get("category");

    let allPhotos = [];
    let currentPhotoIndex = 0;

    // Ustawia tytu≈Ç strony
    const pageTitle = document.getElementById("gallery-title");
    if (countryParam) {
      pageTitle.textContent = `Wyprawy w kraju: ${countryParam}`;
    } else if (categoryParam) {
      pageTitle.textContent = `Miejsca w kategorii: ${getCategoryLabel(categoryParam)}`;
    } else {
      pageTitle.textContent = 'Galeria zdjƒôƒá';
    }
    
    // --- ≈Åadowanie i generowanie galerii ---
    function loadAndDisplayGallery() {
      fetch(tripsUrl)
        .then(res => res.json())
        .then(trips => {
          if (!trips) return;
          const galleryGrid = document.getElementById("gallery-grid");
          galleryGrid.innerHTML = '';

          allPhotos = [];

          Object.keys(trips).forEach(tripKey => {
            const trip = trips[tripKey];

            // Filtrowanie po kraju
            if (countryParam && trip.country !== countryParam) {
                return;
            }

            // Pƒôtla po miejscach w ramach wyprawy
            if (trip.places) {
              Object.keys(trip.places).forEach(placeKey => {
                const place = trip.places[placeKey];

                // Filtrowanie po kategorii
                if (categoryParam && place.category !== categoryParam) {
                    return;
                }

                if (place.photos && place.photos.length > 0) {
                  place.photos.forEach(photo => {
                    const item = document.createElement("div");
                    item.className = "photo-item";
                    item.innerHTML = `
                      <img src="${photo.url}" alt="${photo.caption || ''}" data-url="${photo.url}" data-caption="${photo.caption || ''}" data-place-name="${place.name}">
                      <p>${photo.caption || ''}</p>
                    `;
                    galleryGrid.appendChild(item);
                    allPhotos.push(photo);
                  });
                }
              });
            }
          });
          
          addPhotoClickListeners();

          if (allPhotos.length === 0) {
            galleryGrid.innerHTML = '<p>Brak zdjƒôƒá do wy≈õwietlenia w tej kategorii.</p>';
          }

        })
        .catch(err => {
          console.error("B≈ÇƒÖd ≈Çadowania galerii:", err);
          showMessage("Nie uda≈Ço siƒô za≈Çadowaƒá galerii.");
        });
    }

    // --- Funkcje galerii (lightbox) ---
    function addPhotoClickListeners() {
        const photos = document.querySelectorAll(".photo-item img");
        photos.forEach((img, index) => {
            img.addEventListener("click", () => {
                currentPhotoIndex = index;
                openLightbox(img.src, img.alt);
            });
        });
    }

    window.openLightbox = function(url, caption) {
        const lightbox = document.getElementById("lightbox");
        const lightboxImage = document.getElementById("lightbox-image");
        const lightboxCaption = document.getElementById("lightbox-caption");

        lightboxImage.src = url;
        lightboxCaption.textContent = caption;
        lightbox.style.display = "flex";
    };

    window.closeLightbox = function() {
        document.getElementById("lightbox").style.display = "none";
    };

    window.navigatePhotos = function(direction) {
        currentPhotoIndex += direction;
        if (currentPhotoIndex < 0) {
            currentPhotoIndex = allPhotos.length - 1;
        } else if (currentPhotoIndex >= allPhotos.length) {
            currentPhotoIndex = 0;
        }
        
        const nextPhoto = allPhotos[currentPhotoIndex];
        openLightbox(nextPhoto.url, nextPhoto.caption);
    };

    // --- Funkcje pomocnicze ---
    function getCategoryLabel(category) {
      const categories = {
        "miasto": "üèôÔ∏è Miasto", "park": "üå≥ Park", "zabytek": "üèõÔ∏è Zabytek",
        "muzeum": "üñºÔ∏è Muzeum", "hotel": "üè® Hotel", "szczyt": "‚õ∞Ô∏è Szczyt",
        "restauracja": "üçΩÔ∏è Restauracja", "miejsce_widokowe": "üåÑ Miejsce widokowe",
        "atrakcja_turystyczna": "üéØ Atrakcja turystyczna", "inny": "üîß Inny"
      };
      return categories[category] || category;
    }

    window.showMessage = function(text) {
      document.getElementById("msgText").textContent = text;
      document.getElementById("msgModal").style.display = "flex";
    };

    window.closeMsgModal = function() {
      document.getElementById("msgModal").style.display = "none";
    };

    document.addEventListener("keydown", function(e) {
      if (document.getElementById("lightbox").style.display === "flex") {
        if (e.key === "ArrowLeft") {
          navigatePhotos(-1);
        } else if (e.key === "ArrowRight") {
          navigatePhotos(1);
        }
      }
      if (e.key === "Escape") {
        closeLightbox();
        closeMsgModal();
      }
    });

    loadAndDisplayGallery();
  </script>
</body>
</html>
