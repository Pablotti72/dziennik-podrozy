<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Galeria</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" />
</head>
<body>
    <div class="header-container right-top">
        <div class="header-box">Galeria</div>
        <a id="backLink" class="back-link" href="index.html">← Wróć do mapy</a>
        <button id="menuBtn" class="menu-btn"><i class="fas fa-bars"></i></button>
    </div>

    <!-- Menu boczne (identyczne jak na stronie głównej) -->
    <div id="sideMenu" class="side-menu">
        <button class="menu-close-btn" onclick="toggleMenu()">
            <i class="fas fa-times"></i>
        </button>
        <nav>
            <ul>
                <li><a href="index.html">Strona główna</a></li>
                <li><a href="list.html">Galeria</a></li>
                <li><a href="#">Odwiedzone kraje</a></li>
                <li><a href="#">Kategorie</a></li>
                <li><a href="#">Wyszukiwarka</a></li>
                <li><a href="#">Opcje sortowania</a></li>
                <li><a href="#">Statystyki</a></li>
            </ul>
        </nav>
    </div>
    <div id="overlay" class="overlay" onclick="toggleMenu()"></div>

    <main class="gallery-page">
        <div id="galleryContent" class="gallery-container">
            <p>Ładowanie zdjęć...</p>
        </div>
    </main>

    <!-- Modal do wyświetlania wiadomości -->
    <div id="msgModal" class="msg-modal" style="display: none;">
        <div class="msg-modal-content">
            <p id="msgText"></p>
            <button onclick="closeMsgModal()">OK</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;

        async function initFirebase() {
            if (!Object.keys(firebaseConfig).length) {
                showMessage("Błąd: brak konfiguracji Firebase.");
                return;
            }
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        loadGallery();
                    } else {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });
            } catch (error) {
                console.error("Błąd inicjalizacji Firebase:", error);
                showMessage("Błąd podczas ładowania aplikacji.");
            }
        }

        window.toggleMenu = function() {
            const body = document.body;
            body.classList.toggle('menu-open');
        };

        window.showMessage = function(text) {
            document.getElementById("msgText").textContent = text;
            document.getElementById("msgModal").style.display = "flex";
        };

        window.closeMsgModal = function() {
            document.getElementById("msgModal").style.display = "none";
        };

        async function loadGallery() {
            if (!db) return;
            const galleryContainer = document.getElementById("galleryContent");
            galleryContainer.innerHTML = '<p>Ładowanie zdjęć...</p>';
            
            try {
                const tripsSnapshot = await getDocs(collection(db, `artifacts/${appId}/public/data/trips`));
                const trips = tripsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                const placesSnapshot = await getDocs(collection(db, `artifacts/${appId}/public/data/places`));
                const places = placesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                galleryContainer.innerHTML = '';
                
                if (places.length === 0) {
                    galleryContainer.innerHTML = '<p>Brak zdjęć w galerii. Dodaj miejsca i zdjęcia w trybie edycji.</p>';
                } else {
                    places.forEach(place => {
                        const trip = trips.find(t => t.id === place.tripId);
                        if (place.photos && place.photos.length > 0) {
                            const galleryItem = document.createElement('div');
                            galleryItem.className = 'gallery-item';
                            galleryItem.innerHTML = `<h3>${place.name} <br> <span class="gallery-trip-name">${trip ? `(${trip.name})` : ''}</span></h3>`;
                            
                            place.photos.forEach(photo => {
                                const photoEl = document.createElement('div');
                                photoEl.className = 'gallery-photo';
                                photoEl.innerHTML = `<img src="${photo.url}" alt="${photo.caption || 'Zdjęcie'}">
                                                     <p>${photo.caption || ''}</p>`;
                                galleryItem.appendChild(photoEl);
                            });
                            galleryContainer.appendChild(galleryItem);
                        }
                    });
                }
            } catch (error) {
                console.error("Błąd ładowania galerii:", error);
                showMessage("Nie udało się załadować galerii zdjęć.");
                galleryContainer.innerHTML = '<p>Wystąpił błąd podczas ładowania galerii.</p>';
            }
        }

        document.getElementById("menuBtn").addEventListener("click", toggleMenu);
        document.addEventListener("keydown", function(e) {
          if (e.key === "Escape") {
            document.body.classList.remove('menu-open');
          }
        });

        initFirebase();
    </script>
</body>
</html>
